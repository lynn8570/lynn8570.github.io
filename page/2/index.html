<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="android"><meta name="keywords" content="android"><link rel="alternate" href="/default" title="Lynn8570's Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="https://lynn8570.github.io/page/2/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>Lynn8570's Blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Lynn8570's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Lynn8570's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/常见动画效果/">常见动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="引导动画"><a href="#引导动画" class="headerlink" title="引导动画"></a>引导动画</h1><p>项目地址：<a href="https://github.com/daimajia/AndroidViewAnimations" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/c41223966bdfed2260dbbabbcbae648e5db542c6/687474703a2f2f7777332e73696e61696d672e636e2f6d773639302f3631306463303334677731656a37356d69327737376732306333306a623471722e676966" alt="引导动画"></p>
<p>这个库使用起来还是非常方便的：例如在点击的时候，就可以设置某个视图的动画效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">findViewById(R.id.submit).setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onClick(View v) &#123;</span><br><span class="line"></span><br><span class="line">               YoYo.with(Techniques.Tada)</span><br><span class="line">                       .duration(700)</span><br><span class="line">                       .playOn(findViewById(R.id.edit_area));</span><br><span class="line"></span><br><span class="line">               t.setText(&quot;Wrong password!&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>

<p>YoYo.with(Techniques.Tada)返回一个new AnimationComposer(techniques)的对象，主要用于设置动画的参数。</p>
<p>playOn(target);的时候，将参数设置到animator中并通过animator.setTarget(target);设置作用对象，然后调用play，实际上就是设置好动画参数，然后执行animator.animate()开始动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private BaseViewAnimator play() &#123;</span><br><span class="line">    animator.setTarget(target);</span><br><span class="line"></span><br><span class="line">    if (pivotX == YoYo.CENTER_PIVOT) &#123;</span><br><span class="line">        ViewCompat.setPivotX(target, target.getMeasuredWidth() / 2.0f);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        target.setPivotX(pivotX);</span><br><span class="line">    &#125;</span><br><span class="line">    if (pivotY == YoYo.CENTER_PIVOT) &#123;</span><br><span class="line">        ViewCompat.setPivotY(target, target.getMeasuredHeight() / 2.0f);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        target.setPivotY(pivotY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    animator.setDuration(duration)</span><br><span class="line">            .setRepeatTimes(repeatTimes)</span><br><span class="line">            .setRepeatMode(repeatMode)</span><br><span class="line">            .setInterpolator(interpolator)</span><br><span class="line">            .setStartDelay(delay);</span><br><span class="line"></span><br><span class="line">    if (callbacks.size() &gt; 0) &#123;</span><br><span class="line">        for (Animator.AnimatorListener callback : callbacks) &#123;</span><br><span class="line">            animator.addAnimatorListener(callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    animator.animate();</span><br><span class="line">    return animator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来挑几个基本的动画实现或者几个有意思的实现来看看吧。</p>
<p>所以textview的demo动画有几个基本的设置默认一些参数，执行时间为1200，无限循环，中心点，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.duration(1200)</span><br><span class="line">.repeat(YoYo.INFINITE)</span><br><span class="line">.pivot(YoYo.CENTER_PIVOT, YoYo.CENTER_PIVOT)</span><br><span class="line">.interpolate(new AccelerateDecelerateInterpolator())</span><br></pre></td></tr></table></figure>

<h2 id="弹性掉落"><a href="#弹性掉落" class="headerlink" title="弹性掉落"></a>弹性掉落</h2><p>DropOutnAnimator</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class DropOutAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void prepare(View target) &#123;</span><br><span class="line">        int distance = target.getTop() + target.getHeight();</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;alpha&quot;, 0, 1),</span><br><span class="line">                Glider.glide(Skill.BounceEaseOut, getDuration(), ObjectAnimator.ofFloat(target, &quot;translationY&quot;, -distance, 0))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepare()方法在设置setTarget的时候被调用，这里主要用于AnimatorSet的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public BaseViewAnimator setTarget(View target) &#123;</span><br><span class="line">       reset(target);</span><br><span class="line">       prepare(target);</span><br><span class="line">       return this;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>DropOutAnimator在prepare的时候设置了两个动画，一个是透明度从从0到1，这个比较好理解，在透明度变化的同时，有个y轴位置上的偏移动画，这个y轴的位置偏移不是简单的线性偏移，而是带有球回弹效果的偏移，这种偏移怎么实现的呢？</p>
<p>先看ObjectAnimator.ofFloat(target, “translationY”, -distance, 0)表示将translationY属性从-171到0的一个变化，-171的时候超出屏幕之外，不可见，然后慢慢向下移，移动到view的top为0的位置，即view在屏幕的top位置。</p>
<p>再看Glider.glide(Skill.BounceEaseOut, getDuration(), ValueAnimator XXXX)，表示将 的这种TypeEvaluator通过animator.setEvaluator(TypeEvaluator t);设置到ValueAnimator XXXXanimator中，这个animator就是前面说的translationY偏移动画中。这种组合将产生奇妙的效果，那Skill.BounceEaseOut具体对translationY的偏移有什么影响呢？</p>
<p>TypeEvaluator的核心在于evaluate方法，子类通过override该方法，通过参数fraction因素和startValue\endValue来计算中间值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface TypeEvaluator&lt;T&gt; &#123;</span><br><span class="line">    T evaluate(float fraction, T startValue, T endValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DropOutAnimator的集成关系是：DropOutAnimator-&gt;BaseEasingMet-&gt;TypeEvaluator，其中BaseEasingMet对evaluate进行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public final Float evaluate(float fraction, Number startValue, Number endValue)&#123;</span><br><span class="line">       float t = mDuration * fraction;</span><br><span class="line">       float b = startValue.floatValue();</span><br><span class="line">       float c = endValue.floatValue() - startValue.floatValue();</span><br><span class="line">       float d = mDuration;</span><br><span class="line">       float result = calculate(t,b,c,d);</span><br><span class="line">       for(EasingListener l : mListeners)&#123;</span><br><span class="line">           l.on(t,result,b,c,d);</span><br><span class="line">       &#125;</span><br><span class="line">       return result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public abstract Float calculate(float t, float b, float c, float d);</span><br></pre></td></tr></table></figure>

<p>其中，算法分析如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public  Float calculate(float t, float b, float c, float d)&#123;</span><br><span class="line">               Log.i(&quot;DropOutAnimator&quot;,&quot;time=&quot;+t+&quot;start b=&quot;+b+&quot;length c=&quot;+c+&quot;duration=&quot;+d);</span><br><span class="line">               if ((t/=d) &lt; (1/2.75f)) &#123;//f=0.36</span><br><span class="line">                   return c*(7.5625f*t*t) + b;</span><br><span class="line">               &#125; else if (t &lt; (2/2.75f)) &#123;//f=0.72727272</span><br><span class="line">                   return c*(7.5625f*(t-=(1.5f/2.75f))*t + .75f) + b;</span><br><span class="line">               &#125; else if (t &lt; (2.5/2.75)) &#123;</span><br><span class="line">                   return c*(7.5625f*(t-=(2.25f/2.75f))*t + .9375f) + b;</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   return c*(7.5625f*(t-=(2.625f/2.75f))*t + .984375f) + b;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>第一个阶段f从0-0.36的时候，将参数带入<code>171*7.5625*x*x-171</code>得到-171-0的值，完成了y坐标从-171到0的drop过程。</p>
<p>第二个阶段0.36-0.7272，带入参数为<code>171*(7.5625*(x-0.54)*(x-0.54)+0.75)-171</code>完成从0到-42.75再到0的过程</p>
<p>以此类推，算法的图形如下</p>
<p><img src="images/dropdown.png" alt="路径示意图"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01-11 00:29:10.884 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: result=-13.279831</span><br><span class="line">01-11 00:29:10.900 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: fraction=0.37059042startValue=-171.0fraction=0.0</span><br><span class="line">01-11 00:29:10.902 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: time=444.7085start b=-171.0length c=171.0duration=1200.0</span><br><span class="line">01-11 00:29:10.902 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: result=-3.2075958</span><br></pre></td></tr></table></figure>

<p>以上，就是弹性掉落的动画分析啦</p>
<p>其他的效果也主要是算法的分析：</p>
<p>t=f*duaration 时间</p>
<p>b表示起始值</p>
<p>c表示总的变化幅度</p>
<p>d表示持续时长</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public Float calculate(float t, float b, float c, float d) &#123;</span><br><span class="line">        return c*((t=t/d-1)*t*t*t*t + 1) + b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="心脏跳动效果"><a href="#心脏跳动效果" class="headerlink" title="心脏跳动效果"></a>心脏跳动效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class PulseAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleY&quot;, 1, 1.1f, 1),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleX&quot;, 1, 1.1f, 1)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>x,y大小的变化组合，1变到1.1再变回1</p>
<h2 id="拉扯效果"><a href="#拉扯效果" class="headerlink" title="拉扯效果"></a>拉扯效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class RubberBandAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleX&quot;, 1, 1.25f, 0.75f, 1.15f, 1),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleY&quot;, 1, 0.75f, 1.25f, 0.85f, 1)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>x方向被拉由1变为1.25，弹回0.75，再被拉到1.15，在弹回到1</p>
<p>y方向在x被拉伸的时候，y是缩小的，对应1变为0.75，到1.25，在对应，0.85，再回到1，互补</p>
<h2 id="左右抖动"><a href="#左右抖动" class="headerlink" title="左右抖动"></a>左右抖动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ShakeAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;translationX&quot;, 0, 25, -25, 25, -25, 15, -15, 6, -6, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="摇晃效果"><a href="#摇晃效果" class="headerlink" title="摇晃效果"></a>摇晃效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class SwingAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;rotation&quot;, 0, 10, -10, 6, -6, 3, -3, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="站立效果"><a href="#站立效果" class="headerlink" title="站立效果"></a>站立效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class StandUpAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        float x = (target.getWidth() - target.getPaddingLeft() - target.getPaddingRight()) / 2</span><br><span class="line">                + target.getPaddingLeft();</span><br><span class="line">        float y = target.getHeight() - target.getPaddingBottom();</span><br><span class="line">        //中心点</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotX&quot;, x, x, x, x, x),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotY&quot;, y, y, y, y, y),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;rotationX&quot;, 55, -30, 15, -15, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rotationX表示围绕x坐标的旋转，55到-30表示从屏幕后方往前绕x抽向屏幕前方旋转，几个来回值后，有抖动反弹效果。</p>
<h2 id="悬挂旋转，掉落"><a href="#悬挂旋转，掉落" class="headerlink" title="悬挂旋转，掉落"></a>悬挂旋转，掉落</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HingeAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        float x = target.getPaddingLeft();</span><br><span class="line">        float y = target.getPaddingTop();</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                Glider.glide(Skill.SineEaseInOut, 1300, ObjectAnimator.ofFloat(target, &quot;rotation&quot;, 0, 80, 60, 80, 60, 60)),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;translationY&quot;, 0, 0, 0, 0, 0, 700),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;alpha&quot;, 1, 1, 1, 1, 1, 0),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotX&quot;, x, x, x, x, x, x),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotY&quot;, y, y, y, y, y, y)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        setDuration(1300);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以左上角为中心，SineEaseInOut方式，从0-80-60-80-60，最后在60度的地方，Y轴坐标下降，并且淡出</p>
<p>差不多类似的所以，这些可爱的组合和算法是怎么想出来的啊，真棒！！！</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/TextPathView动画/">Textpath动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Text路径动画效果"><a href="#Text路径动画效果" class="headerlink" title="Text路径动画效果"></a>Text路径动画效果</h1><p>项目地址：<a href="https://github.com/totond/TextPathView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/5f388182db2cf6e039befbfdc41a7e195e93f5a4/68747470733a2f2f692e696d6775722e636f6d2f6c356f385847352e676966" alt="text path 动画"></p>
<p>这个的原理解析也写的很清楚 <a href="https://juejin.im/post/5a9677b16fb9a063375765ad" target="_blank" rel="noopener">连接</a></p>
<p>主要是获取path的过程</p>
<p>以及同步显示画笔</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/wave动画效果/">wave动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Wave动画效果"><a href="#Wave动画效果" class="headerlink" title="Wave动画效果"></a>Wave动画效果</h1><p>项目地址：<a href="https://github.com/tangqi92/WaveLoadingView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/8f83a9935a2b79ed9c63749a1b1b907e2cae850a/687474703a2f2f3778696b66632e636f6d312e7a302e676c622e636c6f7564646e2e636f6d2f776176656c6f6164696e67766965772e706e67" alt="image"></p>
<p>实现波浪wave效果，以及水位位置调整。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="外部形状"><a href="#外部形状" class="headerlink" title="外部形状"></a>外部形状</h3><p>外部形状可以是圆形，三角形，整个图形的绘制区域由canvas决定</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void initBoarderPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBoarderPain = new Paint();</span><br><span class="line">    mBoarderPain.setAntiAlias(true);</span><br><span class="line">    mBoarderPain.setStyle(Paint.Style.STROKE);//描边</span><br><span class="line">    mBoarderPain.setStrokeWidth(DEFAULT_BOARD_WIDTH);</span><br><span class="line">    mBoarderPain.setColor(Color.RED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void initBgPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBgPaint = new Paint();</span><br><span class="line">    mBgPaint.setAntiAlias(true);</span><br><span class="line">    mBgPaint.setColor(getResources().getColor(R.color.voicebg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>怎么画波浪呢？</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void initWavePaint() &#123;</span><br><span class="line">       mWavePain = new Paint();</span><br><span class="line">       mWavePain.setAntiAlias(true);</span><br><span class="line">       mWavePain.setColor(getResources().getColor(R.color.voicefr));</span><br><span class="line">       updateWaveShader();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中updateWaveShader，使用的着色器是BitmapShader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void updateWaveShader() &#123;</span><br><span class="line">       if (getWaveBitmap() != null) &#123;</span><br><span class="line">           mWaveShader = new BitmapShader(getWaveBitmap(), Shader.TileMode.REPEAT, Shader.TileMode.CLAMP);//x坐标repeat模式，y方向上最后一个像素重复</span><br><span class="line">           mWavePain.setShader(mWaveShader);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePain.setShader(null);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>而getWaveBitmap()的任务是获得一个画有两个波浪的图形</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private Bitmap getWaveBitmap() &#123;//返回一个波形的图案，两条线</span><br><span class="line"></span><br><span class="line">    int wavecount = 1;//容纳多少个完整波形</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    int width = getMeasuredWidth();</span><br><span class="line">    int height = getMeasuredHeight();</span><br><span class="line">    Log.i(&quot;linlian&quot;, &quot;width=&quot; + width + &quot; height=&quot; + height);</span><br><span class="line">    if (width &gt; 0 &amp;&amp; height &gt; 0) &#123;</span><br><span class="line"></span><br><span class="line">        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">        Canvas waveLineCanvas = new Canvas(bitmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //坐标点数组，x从0-width，y=Asin(Wx+Q)+H</span><br><span class="line">        // W = 2*PI/width</span><br><span class="line">        // A = height</span><br><span class="line">        // h = height</span><br><span class="line">        // Q = 0</span><br><span class="line">        final int endX = width + 1;</span><br><span class="line">        final int endY = height + 1;</span><br><span class="line">        float W = (float) (2f * Math.PI * wavecount / width);</span><br><span class="line">        float A = height / 10f;//波浪幅度在整体的10分之一</span><br><span class="line">        float H = height / 2;//默认水位在一半的位置</span><br><span class="line">        float[] waveY = new float[endX];</span><br><span class="line"></span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveY[x] = (float) (A * Math.sin(W * x)) + H;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int xShift = width / 4;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavebg));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[(x + xShift) % endX], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavefr));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line"></span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[x], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置好图形着色器之后，在view的onDraw方法上，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePain);//画波浪图形</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何实现动画效果呢"><a href="#如何实现动画效果呢" class="headerlink" title="如何实现动画效果呢"></a>如何实现动画效果呢</h3><p>通过属性动画来实现，改变waveXshift的值，从0到1变化，两秒，重复变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void initAnimation() &#123;</span><br><span class="line">       mShaderMatrix = new Matrix();</span><br><span class="line">       ObjectAnimator waveXshiftAnimator = ObjectAnimator.ofFloat(this, &quot;waveXshift&quot;, 0f, 1f); </span><br><span class="line">       waveXshiftAnimator.setRepeatCount(ValueAnimator.INFINITE);</span><br><span class="line">       waveXshiftAnimator.setDuration(2000);</span><br><span class="line">       waveXshiftAnimator.setInterpolator(new LinearInterpolator());</span><br><span class="line">       mAnimatorset = new AnimatorSet();</span><br><span class="line">       mAnimatorset.play(waveXshiftAnimator);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>属性变化的时候，重新绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void setWaveXshift(float mWaveXshift) &#123;</span><br><span class="line">    if (this.mWaveXshift != mWaveXshift) &#123;</span><br><span class="line">        this.mWaveXshift = mWaveXshift;</span><br><span class="line">        //变化的是重新绘制view，实现动画效果</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中，实现图像的水平移动 mWaveXshift * getWidth();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (mWaveShader != null) &#123;</span><br><span class="line">           if (mWavePaint.getShader() == null) &#123;</span><br><span class="line">               mWavePaint.setShader(mWaveShader);</span><br><span class="line">           &#125;</span><br><span class="line">           float dx = mWaveXshift * getWidth();</span><br><span class="line">           mShaderMatrix.setTranslate(dx, 0);//平移波浪，实现推进效果</span><br><span class="line">           mWaveShader.setLocalMatrix(mShaderMatrix);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePaint.setShader(null);</span><br><span class="line">       &#125;</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePaint);//画波浪</span><br></pre></td></tr></table></figure>

<p>重新实现的代码可以参考</p>
<p><a href="https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java" target="_blank" rel="noopener">https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/Loading动画效果/">Loading 动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Loading动画效果"><a href="#Loading动画效果" class="headerlink" title="Loading动画效果"></a>Loading动画效果</h1><p>项目地址：<a href="https://github.com/81813780/AVLoadingIndicatorView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://github.com/81813780/AVLoadingIndicatorView/blob/master/screenshots/avi.gif" alt="loading动画"></p>
<p>进阶升级，主要是一些自定义的view，基本原理是在draw的时候，因某些属性的变化，使得draw的图形发生变化，从而产生动画效果</p>
<h2 id="基础类"><a href="#基础类" class="headerlink" title="基础类"></a>基础类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public abstract class Indicator extends Drawable implements Animatable</span><br></pre></td></tr></table></figure>

<p>可以详细了解下Drawable的一些常用方法</p>
<h2 id="BallPulseIndicator"><a href="#BallPulseIndicator" class="headerlink" title="BallPulseIndicator"></a>BallPulseIndicator</h2><p>三个小圆点，大小相继变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Created by Jack on 2015/10/16.</span><br><span class="line"> */</span><br><span class="line">public class BallPulseIndicator extends Indicator &#123;</span><br><span class="line"></span><br><span class="line">    public static final float SCALE=1.0f;</span><br><span class="line"></span><br><span class="line">    //scale x ,y</span><br><span class="line">    private float[] scaleFloats=new float[]&#123;SCALE,</span><br><span class="line">            SCALE,</span><br><span class="line">            SCALE&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void draw(Canvas canvas, Paint paint) &#123;</span><br><span class="line">        float circleSpacing=4;</span><br><span class="line">        float radius=(Math.min(getWidth(),getHeight())-circleSpacing*2)/6;</span><br><span class="line">        //根据view的宽度高度，和圆圈的间隔大小计算每个元的半径</span><br><span class="line">        </span><br><span class="line">        float x = getWidth()/ 2-(radius*2+circleSpacing);</span><br><span class="line">        float y=getHeight() / 2;</span><br><span class="line">        第一个小圆圈的位置，</span><br><span class="line">        for (int i = 0; i &lt; 3; i++) &#123;//总共有三个，每个小圆圈的位置相继向右偏移</span><br><span class="line">            canvas.save();</span><br><span class="line">            float translateX=x+(radius*2)*i+circleSpacing*i;</span><br><span class="line">            </span><br><span class="line">            canvas.translate(translateX, y);</span><br><span class="line">           // Log.i(&quot;BallPulseIndicator&quot;,&quot;scaleFloats[&quot;+i+&quot;]=&quot;+scaleFloats[i]);</span><br><span class="line">            canvas.scale(scaleFloats[i], scaleFloats[i]);//scaleFloats[i]根据ValueAnimator的值来变化</span><br><span class="line">            canvas.drawCircle(0, 0, radius, paint);</span><br><span class="line">            canvas.restore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ArrayList&lt;ValueAnimator&gt; onCreateAnimators() &#123;</span><br><span class="line">        ArrayList&lt;ValueAnimator&gt; animators=new ArrayList&lt;&gt;();</span><br><span class="line">        int[] delays=new int[]&#123;120,240,360&#125;;</span><br><span class="line">        for (int i = 0; i &lt; 3; i++) &#123;</span><br><span class="line">            final int index=i;</span><br><span class="line"></span><br><span class="line">            ValueAnimator scaleAnim=ValueAnimator.ofFloat(1,0.3f,1);</span><br><span class="line"></span><br><span class="line">            scaleAnim.setDuration(750);</span><br><span class="line">            scaleAnim.setRepeatCount(-1);</span><br><span class="line">            scaleAnim.setStartDelay(delays[i]);//每个小圈的scale变化通过delay来错开</span><br><span class="line"></span><br><span class="line">            addUpdateListener(scaleAnim,new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">                    scaleFloats[index] = (float) animation.getAnimatedValue();</span><br><span class="line">                    postInvalidate();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            animators.add(scaleAnim);</span><br><span class="line">        &#125;</span><br><span class="line">        return animators;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过代码分析，基本原理，有一种豁然开朗的感觉，有时候觉得动画这东西就是在变魔术</p>
<h2 id="BallClipRotateIndicator"><a href="#BallClipRotateIndicator" class="headerlink" title="BallClipRotateIndicator"></a>BallClipRotateIndicator</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">* Created by Jack on 2015/10/16.</span><br><span class="line"> */</span><br><span class="line">public class BallClipRotateIndicator extends Indicator &#123;</span><br><span class="line"></span><br><span class="line">    float scaleFloat=1,degrees;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void draw(Canvas canvas, Paint paint) &#123;</span><br><span class="line">        paint.setStyle(Paint.Style.STROKE);</span><br><span class="line">        paint.setStrokeWidth(3);</span><br><span class="line"></span><br><span class="line">        float circleSpacing=12;</span><br><span class="line">        float x = (getWidth()) / 2;</span><br><span class="line">        float y=(getHeight()) / 2;</span><br><span class="line">        canvas.translate(x, y);</span><br><span class="line">        canvas.scale(scaleFloat, scaleFloat);</span><br><span class="line">        canvas.rotate(degrees);</span><br><span class="line">        RectF rectF=new RectF(-x+circleSpacing,-y+circleSpacing,0+x-circleSpacing,0+y-circleSpacing);</span><br><span class="line">        canvas.drawArc(rectF, -45, 270, false, paint);//画有一段弧形</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ArrayList&lt;ValueAnimator&gt; onCreateAnimators() &#123;</span><br><span class="line">        ArrayList&lt;ValueAnimator&gt; animators=new ArrayList&lt;&gt;();</span><br><span class="line">        ValueAnimator scaleAnim=ValueAnimator.ofFloat(1,0.6f,0.5f,1);</span><br><span class="line">        scaleAnim.setDuration(750);</span><br><span class="line">        scaleAnim.setRepeatCount(-1);</span><br><span class="line">        addUpdateListener(scaleAnim,new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">                scaleFloat = (float) animation.getAnimatedValue();</span><br><span class="line">                postInvalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ValueAnimator rotateAnim=ValueAnimator.ofFloat(0,180,360);</span><br><span class="line">        rotateAnim.setDuration(750);</span><br><span class="line">        rotateAnim.setRepeatCount(-1);</span><br><span class="line">        addUpdateListener(rotateAnim,new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">                degrees = (float) animation.getAnimatedValue();</span><br><span class="line">                postInvalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        animators.add(scaleAnim);</span><br><span class="line">        animators.add(rotateAnim);</span><br><span class="line">        return animators;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SquareSpinIndicator"><a href="#SquareSpinIndicator" class="headerlink" title="SquareSpinIndicator"></a>SquareSpinIndicator</h2><p>上下左右翻转的正方形，通过camera的api来用于计算3d的转化，用于生成matrix提供给canvas使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by Jack on 2015/10/16.</span><br><span class="line"> */</span><br><span class="line">public class SquareSpinIndicator extends Indicator &#123;</span><br><span class="line"></span><br><span class="line">    private float rotateX;</span><br><span class="line">    private float rotateY;</span><br><span class="line"></span><br><span class="line">    private Camera mCamera;</span><br><span class="line">    private Matrix mMatrix;</span><br><span class="line"></span><br><span class="line">    public SquareSpinIndicator()&#123;</span><br><span class="line">        mCamera=new Camera();</span><br><span class="line">        mMatrix=new Matrix();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void draw(Canvas canvas, Paint paint) &#123;</span><br><span class="line"></span><br><span class="line">        mMatrix.reset();</span><br><span class="line">        mCamera.save();</span><br><span class="line">        mCamera.rotateX(rotateX);</span><br><span class="line">        mCamera.rotateY(rotateY);//通过camera来坐x轴y轴的旋转</span><br><span class="line">        mCamera.getMatrix(mMatrix);//生成matrix</span><br><span class="line">        mCamera.restore();</span><br><span class="line"></span><br><span class="line">        mMatrix.preTranslate(-centerX(), -centerY());</span><br><span class="line">        mMatrix.postTranslate(centerX(), centerY());</span><br><span class="line">        //以上两行主要解决中心对称问题</span><br><span class="line">        //转变之前将0.0的中心点转化到view的中心，转化之后，再恢复回去</span><br><span class="line">        canvas.concat(mMatrix);</span><br><span class="line"></span><br><span class="line">        canvas.drawRect(new RectF(getWidth()/5,getHeight()/5,getWidth()*4/5,getHeight()*4/5),paint);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ArrayList&lt;ValueAnimator&gt; onCreateAnimators() &#123;</span><br><span class="line">        ArrayList&lt;ValueAnimator&gt; animators=new ArrayList&lt;&gt;();</span><br><span class="line">        ValueAnimator animator=ValueAnimator.ofFloat(0,180,180,0,0);</span><br><span class="line">        addUpdateListener(animator,new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">                rotateX= (float) animation.getAnimatedValue();</span><br><span class="line">                postInvalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        animator.setInterpolator(new LinearInterpolator());</span><br><span class="line">        animator.setRepeatCount(-1);</span><br><span class="line">        animator.setDuration(2500);</span><br><span class="line"></span><br><span class="line">        ValueAnimator animator1=ValueAnimator.ofFloat(0,0,180,180,0);</span><br><span class="line">        addUpdateListener(animator1,new ValueAnimator.AnimatorUpdateListener() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void onAnimationUpdate(ValueAnimator animation) &#123;</span><br><span class="line">                rotateY= (float) animation.getAnimatedValue();</span><br><span class="line">                postInvalidate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        animator1.setInterpolator(new LinearInterpolator());</span><br><span class="line">        animator1.setRepeatCount(-1);</span><br><span class="line">        animator1.setDuration(2500);</span><br><span class="line"></span><br><span class="line">        animators.add(animator);</span><br><span class="line">        animators.add(animator1);</span><br><span class="line">        return animators;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/12/animation summary/">动画收集summary</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-12
        </span><span class="post-category">
            <a href="/categories/BLOG/">BLOG</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="动画收集"><a href="#动画收集" class="headerlink" title="动画收集"></a>动画收集</h1><p>最近挖了一个坑，关于动画效果的收集和分析，慢慢补缺补漏吧</p>
<p><a href="https://github.com/lynn8570/AnimationCollect" target="_blank" rel="noopener">https://github.com/lynn8570/AnimationCollect</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/12/hexo note/">Hexo 小记</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-12
        </span><span class="post-category">
            <a href="/categories/BLOG/">BLOG</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="搬迁到hexo啦"><a href="#搬迁到hexo啦" class="headerlink" title="搬迁到hexo啦"></a>搬迁到hexo啦</h1><p>把以前的blog从HUGO迁移成hexo啦</p>
<p>hexo文档</p>
<p><a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">https://hexo.io/zh-cn/docs/index.html</a></p>
<p>用了even 主题</p>
<p><a href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">https://github.com/ahonn/hexo-theme-even</a></p>
<h2 id="如何添加新文章"><a href="#如何添加新文章" class="headerlink" title="如何添加新文章"></a>如何添加新文章</h2><ul>
<li><code>hexo\source\_posts</code> 下添加新文章，新的md文件</li>
<li><code>hexo server</code> 本地查看效果</li>
<li><code>hexo g</code>生成静态文件</li>
<li><code>hexo d</code> 部署到GitHub上</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/26/gradle properties/">gradle properties</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-26
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>Android studio gradle更新同步一直报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error:Unable to resolve dependency for &apos;:app@debug/compileClasspath&apos;: Could not https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/3.2.0-alpha07/gradle-3.2.0-alpha07.pom </span><br><span class="line"></span><br><span class="line">Received status code 400 from server: Bad Request</span><br></pre></td></tr></table></figure>

<p>浏览器访问下载没有问题，但是Android studio下载一直失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/3.2.0-alpha07/gradle-3.2.0-alpha07.pom</span><br></pre></td></tr></table></figure>

<p>查了代理设置</p>
<p>setting-http proxy -设置成 no proxy没有问题</p>
<p>折腾了后来发现，<code>gradle.properties</code>文件被设置了，删除掉代理设置，可gradle sync OK</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/26/Android locale change procedure/">安卓语言切换流程</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-26
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h1><ol>
<li><p>在settings应用中，通过LocaleDragAndDropAdapter来实现语言列表拖拽切换语言的，在拖拽结束后会调用updateLocalesWhenAnimationStops表示当动画结束后，进行locale的更新操作</p>
<p>​</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    public void updateLocalesWhenAnimationStops(final LocaleList localeList) &#123;</span><br><span class="line">    //在动画借宿后，更新locale设置</span><br><span class="line">    if (localeList.equals(mLocalesToSetNext)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This will only update the Settings application to make things feel more responsive,</span><br><span class="line">    // the system will be updated later, when animation stopped.</span><br><span class="line">    LocaleList.setDefault(localeList);</span><br><span class="line"></span><br><span class="line">    mLocalesToSetNext = localeList;</span><br><span class="line">    final RecyclerView.ItemAnimator itemAnimator = mParentView.getItemAnimator();</span><br><span class="line">    itemAnimator.isRunning(new RecyclerView.ItemAnimator.ItemAnimatorFinishedListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onAnimationsFinished() &#123;</span><br><span class="line">          </span><br><span class="line">            if (mLocalesToSetNext == null || mLocalesToSetNext.equals(mLocalesSetLast)) &#123;</span><br><span class="line">                // All animations finished, but the locale list did not change</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LocalePicker.updateLocales(mLocalesToSetNext); //当动画结束的时候，调用真正的更新</span><br><span class="line">            mLocalesSetLast = mLocalesToSetNext;</span><br><span class="line">            new CreateShortcut.ShortcutsUpdateTask(mContext).execute();</span><br><span class="line"></span><br><span class="line">            mLocalesToSetNext = null;</span><br><span class="line"></span><br><span class="line">            mNumberFormatter = NumberFormat.getNumberInstance(Locale.getDefault());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>LocalePicker.updateLocales(mLocalesToSetNext);当动画结束时，调用系统方法，更新locale，LocalePicker的位置：</li>
</ol>
<p><code>android\frameworks\base\core\java\com\android\internal\app\LocalePicker.java</code></p>
<p>请求系统来更新系统的语言设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Requests the system to update the system locale. Note that the system looks halted</span><br><span class="line"> * for a while during the Locale migration, so the caller need to take care of it.</span><br><span class="line"> *</span><br><span class="line"> * @see #updateLocales(LocaleList)</span><br><span class="line"> */</span><br><span class="line">public static void updateLocale(Locale locale) &#123;</span><br><span class="line">    updateLocales(new LocaleList(locale));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void updateLocales(LocaleList locales) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        final IActivityManager am = ActivityManager.getService();</span><br><span class="line">        final Configuration config = am.getConfiguration();</span><br><span class="line"></span><br><span class="line">        config.setLocales(locales);</span><br><span class="line">        config.userSetLocale = true;</span><br><span class="line">        //1.am</span><br><span class="line">        am.updatePersistentConfiguration(config);</span><br><span class="line">        // Trigger the dirty bit for the Settings Provider.</span><br><span class="line">        //2.backupmanager</span><br><span class="line">        BackupManager.dataChanged(&quot;com.android.providers.settings&quot;);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        // Intentionally left blank</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过<code>am.updatePersistentConfiguration(config);</code>来进行配置更新和持久化，am的真正实现为 ActivityManagerService.java，先确认权限，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void updatePersistentConfiguration(Configuration values) &#123;</span><br><span class="line">    enforceCallingPermission(CHANGE_CONFIGURATION, &quot;updatePersistentConfiguration()&quot;);</span><br><span class="line">    enforceWriteSettingsPermission(&quot;updatePersistentConfiguration()&quot;);</span><br><span class="line">    if (values == null) &#123;</span><br><span class="line">        throw new NullPointerException(&quot;Configuration must not be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int userId = UserHandle.getCallingUserId();</span><br><span class="line"></span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line">        updatePersistentConfigurationLocked(values, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void updatePersistentConfigurationLocked(Configuration values, @UserIdInt int userId) &#123;</span><br><span class="line">    final long origId = Binder.clearCallingIdentity();</span><br><span class="line">    try &#123;</span><br><span class="line">        updateConfigurationLocked(values, null, false, true, userId, false /* deferResume */);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>详细分析updateConfigurationLocked：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Do either or both things: (1) change the current configuration, and (2)</span><br><span class="line"> * make sure the given activity is running with the (now) current</span><br><span class="line"> * configuration.  Returns true if the activity has been left running, or</span><br><span class="line"> * false if &lt;var&gt;starting&lt;/var&gt; is being destroyed to match the new</span><br><span class="line"> * configuration.</span><br><span class="line"> *</span><br><span class="line"> * @param userId is only used when persistent parameter is set to true to persist configuration</span><br><span class="line"> *               for that particular user</span><br><span class="line"> */</span><br><span class="line">private boolean updateConfigurationLocked(Configuration values, ActivityRecord starting,</span><br><span class="line">        boolean initLocale, boolean persistent, int userId, boolean deferResume,</span><br><span class="line">        UpdateConfigurationResult result) &#123;</span><br><span class="line">    int changes = 0;</span><br><span class="line">    boolean kept = true;</span><br><span class="line"></span><br><span class="line">    if (mWindowManager != null) &#123;</span><br><span class="line">        mWindowManager.deferSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (values != null) &#123;</span><br><span class="line">            //1.1更新全局的配置信息</span><br><span class="line">            changes = updateGlobalConfiguration(values, initLocale, persistent, userId,</span><br><span class="line">                    deferResume);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kept = ensureConfigAndVisibilityAfterUpdate(starting, changes);</span><br><span class="line">        //1.2当前的activity是否被开始destroy，以便重新创建</span><br><span class="line">       </span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (mWindowManager != null) &#123;</span><br><span class="line">            mWindowManager.continueSurfaceLayout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (result != null) &#123;</span><br><span class="line">        result.changes = changes;</span><br><span class="line">        result.activityRelaunched = !kept;</span><br><span class="line">    &#125;</span><br><span class="line">    return kept;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>updateGlobalConfiguration：更新默认的global配置，并通知各个监听器，比较长的代码，注释解读：该方法主要做了以下事情</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private int updateGlobalConfiguration(@NonNull Configuration values, boolean initLocale,</span><br><span class="line">        boolean persistent, int userId, boolean deferResume) &#123;</span><br><span class="line">    mTempConfig.setTo(getGlobalConfiguration());</span><br><span class="line">    final int changes = mTempConfig.updateFrom(values);</span><br><span class="line">    </span><br><span class="line">    if (changes == 0) &#123;</span><br><span class="line">        //如果没有变化，则return，return之前，由于 Activity.setRequestedOrientation 导致WindowManagerService.mWaitingForConfig被设置为true，从而使窗口被锁住，所以如果没有变化的话，performDisplayOverrideConfigUpdate来解冻窗口</span><br><span class="line">        performDisplayOverrideConfigUpdate(values, deferResume, DEFAULT_DISPLAY);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    .............</span><br><span class="line">    EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</span><br><span class="line"></span><br><span class="line">    if (!initLocale &amp;&amp; !values.getLocales().isEmpty() &amp;&amp; values.userSetLocale) &#123;</span><br><span class="line">        final LocaleList locales = values.getLocales();</span><br><span class="line">        int bestLocaleIndex = 0;</span><br><span class="line">        if (locales.size() &gt; 1) &#123;</span><br><span class="line">            if (mSupportedSystemLocales == null) &#123;</span><br><span class="line">                mSupportedSystemLocales = Resources.getSystem().getAssets().getLocales();</span><br><span class="line">            &#125;</span><br><span class="line">            bestLocaleIndex = Math.max(0, locales.getFirstMatchIndex(mSupportedSystemLocales));</span><br><span class="line">        &#125;</span><br><span class="line">        SystemProperties.set(&quot;persist.sys.locale&quot;,</span><br><span class="line">                locales.get(bestLocaleIndex).toLanguageTag());//设置保存</span><br><span class="line">        LocaleList.setDefault(locales, bestLocaleIndex);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(SEND_LOCALE_TO_MOUNT_DAEMON_MSG,</span><br><span class="line">                locales.get(bestLocaleIndex)));//1.1.1 发送SEND_LOCALE_TO_MOUNT_DAEMON_MSG消息，主要用于通知storageManager.setField(StorageManager.SYSTEM_LOCALE_KEY, l.toLanguageTag());存储管理，将系统语言更新</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mConfigurationSeq = Math.max(++mConfigurationSeq, 1);</span><br><span class="line">    mTempConfig.seq = mConfigurationSeq;</span><br><span class="line"></span><br><span class="line">    //1.1.2 调用mStackSupervisor的回掉Update stored global config and notify everyone about the change.</span><br><span class="line">    mStackSupervisor.onConfigurationChanged(mTempConfig);</span><br><span class="line">   </span><br><span class="line">    Slog.i(TAG, &quot;Config changes=&quot; + Integer.toHexString(changes) + &quot; &quot; + mTempConfig);</span><br><span class="line">    //1.1.3 TODO(multi-display): Update UsageEvents#Event to include displayId.主要是event</span><br><span class="line">    mUsageStatsService.reportConfigurationChange(mTempConfig,</span><br><span class="line">            mUserController.getCurrentUserIdLocked());</span><br><span class="line"></span><br><span class="line">    // TODO: If our config changes, should we auto dismiss any currently showing dialogs?</span><br><span class="line">    mShowDialogs = shouldShowDialogs(mTempConfig);</span><br><span class="line"></span><br><span class="line">    AttributeCache ac = AttributeCache.instance();</span><br><span class="line">    if (ac != null) &#123;</span><br><span class="line">        ac.updateConfiguration(mTempConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make sure all resources in our process are updated right now, so that anyone who is going</span><br><span class="line">    // to retrieve resource values after we return will be sure to get the new ones. This is</span><br><span class="line">    // especially important during boot, where the first config change needs to guarantee all</span><br><span class="line">    //1.1.4 resources have that config before following boot code is executed.重要流程</span><br><span class="line">    mSystemThread.applyConfigurationToResources(mTempConfig);</span><br><span class="line"></span><br><span class="line">    //1.1.5 We need another copy of global config because we&apos;re scheduling some calls instead of</span><br><span class="line">    // running them in place. We need to be sure that object we send will be handled unchanged.</span><br><span class="line">    final Configuration configCopy = new Configuration(mTempConfig);</span><br><span class="line">    if (persistent &amp;&amp; Settings.System.hasInterestingConfigurationChanges(changes)) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</span><br><span class="line">        msg.obj = configCopy;</span><br><span class="line">        msg.arg1 = userId;</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">        //主要更新ContentResolver</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i = mLruProcesses.size() - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">        ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">        try &#123;</span><br><span class="line">            if (app.thread != null) &#123;</span><br><span class="line">                if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, &quot;Sending to proc &quot;</span><br><span class="line">                        + app.processName + &quot; new config &quot; + configCopy);</span><br><span class="line">                app.thread.scheduleConfigurationChanged(configCopy);</span><br><span class="line">                //重要流程，遍历</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //ACTION_CONFIGURATION_CHANGED intent</span><br><span class="line">    Intent intent = new Intent(Intent.ACTION_CONFIGURATION_CHANGED);</span><br><span class="line">    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">            | Intent.FLAG_RECEIVER_FOREGROUND</span><br><span class="line">            | Intent.FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS);</span><br><span class="line">    broadcastIntentLocked(null, null, intent, null, null, 0, null, null, null,</span><br><span class="line">            AppOpsManager.OP_NONE, null, false, false, MY_PID, SYSTEM_UID,</span><br><span class="line">            UserHandle.USER_ALL);</span><br><span class="line">    if ((changes &amp; ActivityInfo.CONFIG_LOCALE) != 0) &#123;</span><br><span class="line">         // ACTION_LOCALE_CHANGED intent</span><br><span class="line">        intent = new Intent(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND</span><br><span class="line">                | Intent.FLAG_RECEIVER_INCLUDE_BACKGROUND</span><br><span class="line">                | Intent.FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS);</span><br><span class="line">        if (initLocale || !mProcessesReady) &#123;</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line">        broadcastIntentLocked(null, null, intent, null, null, 0, null, null, null,</span><br><span class="line">                AppOpsManager.OP_NONE, null, false, false, MY_PID, SYSTEM_UID,</span><br><span class="line">                UserHandle.USER_ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Override configuration of the default display duplicates global config, so we need to</span><br><span class="line">    // update it also. This will also notify WindowManager about changes.</span><br><span class="line">    performDisplayOverrideConfigUpdate(mStackSupervisor.getConfiguration(), deferResume,</span><br><span class="line">            DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    return changes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上方法主要做了以下几件事情：</p>
<ul>
<li><p>设置persist.sys.locale，持久化保存</p>
</li>
<li><p>发送SEND_LOCALE_TO_MOUNT_DAEMON_MSG消息通知，storageManager</p>
</li>
<li><p>调用mStackSupervisor的回调mStackSupervisor.onConfigurationChanged(mTempConfig);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Notify that parent config changed and we need to update full configuration.</span><br><span class="line"> * @see #mFullConfiguration</span><br><span class="line"> */</span><br><span class="line">void onConfigurationChanged(Configuration newParentConfig) &#123;</span><br><span class="line">    mFullConfiguration.setTo(newParentConfig);</span><br><span class="line">    mFullConfiguration.updateFrom(mOverrideConfiguration);</span><br><span class="line">    for (int i = getChildCount() - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        final ConfigurationContainer child = getChildAt(i);</span><br><span class="line">        child.onConfigurationChanged(mFullConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mUsageStatsService.reportConfigurationChange(mTempConfig,mUserController.getCurrentUserIdLocked()); 报告UsageEvents</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void reportConfigurationChange(Configuration config, int userId) &#123;</span><br><span class="line">    if (config == null) &#123;</span><br><span class="line">        Slog.w(TAG, &quot;Configuration event reported with a null config&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = new UsageEvents.Event();</span><br><span class="line">    event.mPackage = &quot;android&quot;;</span><br><span class="line"></span><br><span class="line">    // This will later be converted to system time.</span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = UsageEvents.Event.CONFIGURATION_CHANGE;</span><br><span class="line">    event.mConfiguration = new Configuration(config);</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, 0, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mSystemThread.applyConfigurationToResources(mTempConfig); </p>
<p>ActivityThread.Java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public final void applyConfigurationToResources(Configuration config) &#123;</span><br><span class="line">       synchronized (mResourcesManager) &#123;</span><br><span class="line">           mResourcesManager.applyConfigurationToResourcesLocked(config, null);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ResourcesManager.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public final boolean applyConfigurationToResourcesLocked(@NonNull Configuration config,</span><br><span class="line">                                                           @Nullable CompatibilityInfo compat) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          Trace.traceBegin(Trace.TRACE_TAG_RESOURCES,</span><br><span class="line">                  &quot;ResourcesManager#applyConfigurationToResourcesLocked&quot;);</span><br><span class="line"></span><br><span class="line">          if (!mResConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">              if (DEBUG || DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Skipping new config: curSeq=&quot;</span><br><span class="line">                      + mResConfiguration.seq + &quot;, newSeq=&quot; + config.seq);</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          int changes = mResConfiguration.updateFrom(config);</span><br><span class="line">          // Things might have changed in display manager, so clear the cached displays.</span><br><span class="line">          mAdjustedDisplays.clear();</span><br><span class="line"></span><br><span class="line">          DisplayMetrics defaultDisplayMetrics = getDisplayMetrics();</span><br><span class="line"></span><br><span class="line">          if (compat != null &amp;&amp; (mResCompatibilityInfo == null ||</span><br><span class="line">                  !mResCompatibilityInfo.equals(compat))) &#123;</span><br><span class="line">              mResCompatibilityInfo = compat;</span><br><span class="line">              changes |= ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                      | ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                      | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          Resources.updateSystemConfiguration(config, defaultDisplayMetrics, compat);</span><br><span class="line"></span><br><span class="line">          ApplicationPackageManager.configurationChanged();</span><br><span class="line">          //Slog.i(TAG, &quot;Configuration changed in &quot; + currentPackageName());</span><br><span class="line"></span><br><span class="line">          Configuration tmpConfig = null;</span><br><span class="line"></span><br><span class="line">          for (int i = mResourceImpls.size() - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">              ResourcesKey key = mResourceImpls.keyAt(i);</span><br><span class="line">              WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.valueAt(i);</span><br><span class="line">              ResourcesImpl r = weakImplRef != null ? weakImplRef.get() : null;</span><br><span class="line">              if (r != null) &#123;</span><br><span class="line">                  if (DEBUG || DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Changing resources &quot;</span><br><span class="line">                          + r + &quot; config to: &quot; + config);</span><br><span class="line">                  int displayId = key.mDisplayId;</span><br><span class="line">                  boolean isDefaultDisplay = (displayId == Display.DEFAULT_DISPLAY);</span><br><span class="line">                  DisplayMetrics dm = defaultDisplayMetrics;</span><br><span class="line">                  final boolean hasOverrideConfiguration = key.hasOverrideConfiguration();</span><br><span class="line">                  if (!isDefaultDisplay || hasOverrideConfiguration) &#123;</span><br><span class="line">                      if (tmpConfig == null) &#123;</span><br><span class="line">                          tmpConfig = new Configuration();</span><br><span class="line">                      &#125;</span><br><span class="line">                      tmpConfig.setTo(config);</span><br><span class="line"></span><br><span class="line">                      // Get new DisplayMetrics based on the DisplayAdjustments given</span><br><span class="line">                      // to the ResourcesImpl. Update a copy if the CompatibilityInfo</span><br><span class="line">                      // changed, because the ResourcesImpl object will handle the</span><br><span class="line">                      // update internally.</span><br><span class="line">                      DisplayAdjustments daj = r.getDisplayAdjustments();</span><br><span class="line">                      if (compat != null) &#123;</span><br><span class="line">                          daj = new DisplayAdjustments(daj);</span><br><span class="line">                          daj.setCompatibilityInfo(compat);</span><br><span class="line">                      &#125;</span><br><span class="line">                      dm = getDisplayMetrics(displayId, daj);</span><br><span class="line"></span><br><span class="line">                      if (!isDefaultDisplay) &#123;</span><br><span class="line">                          applyNonDefaultDisplayMetricsToConfiguration(dm, tmpConfig);</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      if (hasOverrideConfiguration) &#123;</span><br><span class="line">                          tmpConfig.updateFrom(key.mOverrideConfiguration);</span><br><span class="line">                      &#125;</span><br><span class="line">                      r.updateConfiguration(tmpConfig, dm, compat);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      r.updateConfiguration(config, dm, compat);</span><br><span class="line">                  &#125;</span><br><span class="line">                  //Slog.i(TAG, &quot;Updated app resources &quot; + v.getKey()</span><br><span class="line">                  //        + &quot; &quot; + r + &quot;: &quot; + r.getConfiguration());</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  //Slog.i(TAG, &quot;Removing old resources &quot; + v.getKey());</span><br><span class="line">                  mResourceImpls.removeAt(i);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return changes != 0;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Resources.updateSystemConfiguration(config, defaultDisplayMetrics, compat); 更新资源配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if ((configChanges &amp; ActivityInfo.CONFIG_LOCALE) != 0) &#123;</span><br><span class="line">                    if (locales.size() &gt; 1) &#123;</span><br><span class="line">                        // The LocaleList has changed. We must query the AssetManager&apos;s available</span><br><span class="line">                        // Locales and figure out the best matching Locale in the new LocaleList.</span><br><span class="line">                        String[] availableLocales = mAssets.getNonSystemLocales();</span><br><span class="line">                        if (LocaleList.isPseudoLocalesOnly(availableLocales)) &#123;</span><br><span class="line">                            // No app defined locales, so grab the system locales.</span><br><span class="line">                            availableLocales = mAssets.getLocales();</span><br><span class="line">                            if (LocaleList.isPseudoLocalesOnly(availableLocales)) &#123;</span><br><span class="line">                                availableLocales = null;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (availableLocales != null) &#123;</span><br><span class="line">                            final Locale bestLocale = locales.getFirstMatchWithEnglishSupported(</span><br><span class="line">                                    availableLocales);</span><br><span class="line">                            if (bestLocale != null &amp;&amp; bestLocale != locales.get(0)) &#123;</span><br><span class="line">                                mConfiguration.setLocales(new LocaleList(bestLocale, locales));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationPackageManager.configurationChanged();清空缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static void configurationChanged() &#123;</span><br><span class="line">        synchronized (sSync) &#123;</span><br><span class="line">            sIconCache.clear();</span><br><span class="line">            sStringCache.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app.thread.scheduleConfigurationChanged(configCopy);遍历每个activityThread，应用新的配置</p>
<p>ActivityThread.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleConfigurationChanged(Configuration config) &#123;</span><br><span class="line">    updatePendingConfiguration(config);</span><br><span class="line">    sendMessage(H.CONFIGURATION_CHANGED, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CONFIGURATION_CHANGED:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case CONFIGURATION_CHANGED:</span><br><span class="line">           Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;configChanged&quot;);</span><br><span class="line">           mCurDefaultDisplayDpi = ((Configuration)msg.obj).densityDpi;</span><br><span class="line">           mUpdatingSystemConfig = true;</span><br><span class="line">           try &#123;</span><br><span class="line">               handleConfigurationChanged((Configuration) msg.obj, null);</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               mUpdatingSystemConfig = false;</span><br><span class="line">           &#125;</span><br><span class="line">           Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">           break;</span><br></pre></td></tr></table></figure>

<p>ActivityThread.handleConfigurationChanged</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">final void handleConfigurationChanged(Configuration config, CompatibilityInfo compat) &#123;</span><br><span class="line"></span><br><span class="line">        int configDiff = 0;</span><br><span class="line"></span><br><span class="line">        // This flag tracks whether the new configuration is fundamentally equivalent to the</span><br><span class="line">        // existing configuration. This is necessary to determine whether non-activity</span><br><span class="line">        // callbacks should receive notice when the only changes are related to non-public fields.</span><br><span class="line">        // We do not gate calling &#123;@link #performActivityConfigurationChanged&#125; based on this flag</span><br><span class="line">        // as that method uses the same check on the activity config override as well.</span><br><span class="line">        final boolean equivalent = config != null &amp;&amp; mConfiguration != null</span><br><span class="line">                &amp;&amp; (0 == mConfiguration.diffPublicOnly(config));</span><br><span class="line"></span><br><span class="line">        synchronized (mResourcesManager) &#123;</span><br><span class="line">            if (mPendingConfiguration != null) &#123;</span><br><span class="line">                if (!mPendingConfiguration.isOtherSeqNewer(config)) &#123;</span><br><span class="line">                    config = mPendingConfiguration;</span><br><span class="line">                    mCurDefaultDisplayDpi = config.densityDpi;</span><br><span class="line">                    updateDefaultDensity();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingConfiguration = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (config == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Handle configuration changed: &quot;</span><br><span class="line">                    + config);</span><br><span class="line"></span><br><span class="line">            mResourcesManager.applyConfigurationToResourcesLocked(config, compat);</span><br><span class="line">            updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                    mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">            if (mConfiguration == null) &#123;</span><br><span class="line">                mConfiguration = new Configuration();</span><br><span class="line">            &#125;</span><br><span class="line">            if (!mConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            configDiff = mConfiguration.updateFrom(config);</span><br><span class="line">            config = applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line"></span><br><span class="line">            final Theme systemTheme = getSystemContext().getTheme();</span><br><span class="line">            if ((systemTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">                systemTheme.rebase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            final Theme systemUiTheme = getSystemUiContext().getTheme();</span><br><span class="line">            if ((systemUiTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">                systemUiTheme.rebase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(false, config);</span><br><span class="line"></span><br><span class="line">        freeTextLayoutCachesIfNeeded(configDiff);</span><br><span class="line"></span><br><span class="line">        if (callbacks != null) &#123;</span><br><span class="line">            final int N = callbacks.size();</span><br><span class="line">            for (int i=0; i&lt;N; i++) &#123;</span><br><span class="line">                ComponentCallbacks2 cb = callbacks.get(i);</span><br><span class="line">                if (cb instanceof Activity) &#123;</span><br><span class="line">                    // If callback is an Activity - call corresponding method to consider override</span><br><span class="line">                    // config and avoid onConfigurationChanged if it hasn&apos;t changed.</span><br><span class="line">                    Activity a = (Activity) cb;</span><br><span class="line">                    performConfigurationChangedForActivity(mActivities.get(a.getActivityToken()),</span><br><span class="line">                            config);</span><br><span class="line">                &#125; else if (!equivalent) &#123;</span><br><span class="line">                    performConfigurationChanged(cb, config);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>

<p> app.thread.scheduleConfigurationChanged(configCopy);</p>
<p>回到</p>
<p>ActivityThread.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleConfigurationChanged(Configuration config) &#123;</span><br><span class="line">    updatePendingConfiguration(config);</span><br><span class="line">    sendMessage(H.CONFIGURATION_CHANGED, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CONFIGURATION_CHANGED:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">case CONFIGURATION_CHANGED:</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;configChanged&quot;);</span><br><span class="line">    mCurDefaultDisplayDpi = ((Configuration)msg.obj).densityDpi;</span><br><span class="line">    mUpdatingSystemConfig = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        handleConfigurationChanged((Configuration) msg.obj, null);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mUpdatingSystemConfig = false;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    break;</span><br></pre></td></tr></table></figure>

<p>ActivityThread.handleConfigurationChanged</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">final void handleConfigurationChanged(Configuration config, CompatibilityInfo compat) &#123;</span><br><span class="line"></span><br><span class="line">       int configDiff = 0;</span><br><span class="line"></span><br><span class="line">       // This flag tracks whether the new configuration is fundamentally equivalent to the</span><br><span class="line">       // existing configuration. This is necessary to determine whether non-activity</span><br><span class="line">       // callbacks should receive notice when the only changes are related to non-public fields.</span><br><span class="line">       // We do not gate calling &#123;@link #performActivityConfigurationChanged&#125; based on this flag</span><br><span class="line">       // as that method uses the same check on the activity config override as well.</span><br><span class="line">       final boolean equivalent = config != null &amp;&amp; mConfiguration != null</span><br><span class="line">               &amp;&amp; (0 == mConfiguration.diffPublicOnly(config));</span><br><span class="line"></span><br><span class="line">       synchronized (mResourcesManager) &#123;</span><br><span class="line">           if (mPendingConfiguration != null) &#123;</span><br><span class="line">               if (!mPendingConfiguration.isOtherSeqNewer(config)) &#123;</span><br><span class="line">                   config = mPendingConfiguration;</span><br><span class="line">                   mCurDefaultDisplayDpi = config.densityDpi;</span><br><span class="line">                   updateDefaultDensity();</span><br><span class="line">               &#125;</span><br><span class="line">               mPendingConfiguration = null;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (config == null) &#123;</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Handle configuration changed: &quot;</span><br><span class="line">                   + config);</span><br><span class="line"></span><br><span class="line">           mResourcesManager.applyConfigurationToResourcesLocked(config, compat);</span><br><span class="line">           updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                   mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">           if (mConfiguration == null) &#123;</span><br><span class="line">               mConfiguration = new Configuration();</span><br><span class="line">           &#125;</span><br><span class="line">           if (!mConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           configDiff = mConfiguration.updateFrom(config);</span><br><span class="line">           config = applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line"></span><br><span class="line">           final Theme systemTheme = getSystemContext().getTheme();</span><br><span class="line">           if ((systemTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">               systemTheme.rebase();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           final Theme systemUiTheme = getSystemUiContext().getTheme();</span><br><span class="line">           if ((systemUiTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">               systemUiTheme.rebase();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(false, config);</span><br><span class="line"></span><br><span class="line">       freeTextLayoutCachesIfNeeded(configDiff);</span><br><span class="line"></span><br><span class="line">       if (callbacks != null) &#123;</span><br><span class="line">           final int N = callbacks.size();</span><br><span class="line">           for (int i=0; i&lt;N; i++) &#123;</span><br><span class="line">               ComponentCallbacks2 cb = callbacks.get(i);</span><br><span class="line">               if (cb instanceof Activity) &#123;</span><br><span class="line">                   // If callback is an Activity - call corresponding method to consider override</span><br><span class="line">                   // config and avoid onConfigurationChanged if it hasn&apos;t changed.</span><br><span class="line">                   Activity a = (Activity) cb;</span><br><span class="line">                   performConfigurationChangedForActivity(mActivities.get(a.getActivityToken()),</span><br><span class="line">                           config);</span><br><span class="line">               &#125; else if (!equivalent) &#123;</span><br><span class="line">                   performConfigurationChanged(cb, config);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中调用log打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">01-09 03:12:27.360: I/linlian(5221): LocaleDragAndDropAdapter.updateLocalesWhenAnimationStops()</span><br><span class="line">01-09 03:12:27.420: I/linlian(5221): LocaleDragAndDropAdapter.onAnimationsFinished()</span><br><span class="line">01-09 03:12:27.420: I/linlian(5221): LocaleDragAndDropAdapter.onAnimationsFinished()mLocalesToSetNext=[en_US,zh_CN_#Hans]</span><br><span class="line">动画结束，准备更新locale</span><br><span class="line">01-09 03:12:27.421: I/linlian(5221): LocalePicker.updateLocale()config=&#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.7&#125;</span><br><span class="line">01-09 03:12:27.422: I/linlian(714): ActivityManagerService.updateGlobalConfiguration changes=8196</span><br><span class="line">01-09 03:12:27.422: I/linlian(714): ActivityManagerService.updateGlobalConfiguration values=&#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.7&#125;</span><br><span class="line">01-09 03:12:27.432: I/linlian(714): ActivityManagerService.updateGlobalConfiguration locales=[en_US,zh_CN_#Hans]</span><br><span class="line">更新locale排序为 英语，简体中文</span><br><span class="line">01-09 03:12:27.432: I/linlian(714): ActivityManagerService.updateGlobalConfiguration bestLocaleIndex=0</span><br><span class="line">01-09 03:12:27.433: I/linlian(714): ActivityManagerService.updateGlobalConfiguration locales=Config changes=2004 &#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.8&#125;</span><br><span class="line">遍历当前的ProcessRecord，开机的有 设置，短信，launcher，acore,latin输入法</span><br><span class="line">01-09 03:12:27.457: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;9538ed4 5221:com.android.settings/1000&#125;</span><br><span class="line">01-09 03:12:27.457: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;a10987d 2720:com.android.mms/u0a17&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;5353372 2324:com.android.launcher3/u0a16&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;97fd3c3 5277:android.process.acore/u0a2&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;e22e5a6 1686:com.android.inputmethod.latin/u0a50&#125;</span><br><span class="line">.........编译APP，会被多次调用 handleConfigurationChanged 会被多次调用</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): ActivityThread.handleConfigurationChanged()</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): java.lang.RuntimeException</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread.handleConfigurationChanged(ActivityThread.java:4972)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1705)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread.main(ActivityThread.java:6503)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2324): ActivityThread.handleConfigurationChanged()</span><br><span class="line">log穿插着ProcessRecord</span><br><span class="line">01-09 03:12:27.471: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;351e46c 2749:com.android.onetimeinitializer/u0a19&#125;</span><br><span class="line">01-09 03:12:27.471: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;4ff5a35 2396:com.android.managedprovisioning/u0a15&#125;</span><br><span class="line">01-09 03:12:27.472: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;833beca 2520:com.android.exchange/u0a48&#125;</span><br><span class="line">01-09 03:12:27.472: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;c65f83b 2702:com.android.gallery3d/u0a49&#125;</span><br><span class="line"></span><br><span class="line">当前的应用</span><br><span class="line">01-09 03:12:27.559: I/linlian(5221): ActivityThread.handleConfigurationChanged()Activity a=com.android.settings.SubSettings@e58e930</span><br></pre></td></tr></table></figure>


        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/15/gitbook/">gitbook知识服务共享平台搭建</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-15
        </span><span class="post-category">
            <a href="/categories/SERVER/">SERVER</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="git-服务器搭建"><a href="#git-服务器搭建" class="headerlink" title="git 服务器搭建"></a>git 服务器搭建</h1><p>主要参考<a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137583770360579bc4b458f044ce7afed3df579123eca000" target="_blank" rel="noopener">廖雪峰搭建git服务器</a>一文主要注意的几个点：</p>
<ol>
<li><p>创建的 home/git/.ssh/ 目录的权限和 home/git/.ssh/authorized_keys 的权限问题</p>
<figure class="highlight plain"><figcaption><span>1 git git 1234 2018-03-10 17:43 authorized_keys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@guoyzh-ubuntu:/home/git/.ssh# ls -all</span><br><span class="line">......</span><br><span class="line">-rw-r--r-- 1 git git 1234 2018-03-10 17:43 authorized_keys</span><br><span class="line"></span><br><span class="line"> drwxr-xr-x  2 git  git  4096 2018-03-10 17:43 .ssh</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/ssh/sshd_config 文件可用于配置验证方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"># Package generated configuration file</span><br><span class="line"># See the sshd_config(5) manpage for details</span><br><span class="line"></span><br><span class="line"># What ports, IPs and protocols we listen for</span><br><span class="line">Port 22</span><br><span class="line"># Use these options to restrict which interfaces/protocols sshd will bind to</span><br><span class="line">#ListenAddress ::</span><br><span class="line">#ListenAddress 0.0.0.0</span><br><span class="line">Protocol 2</span><br><span class="line"># HostKeys for protocol version 2</span><br><span class="line">HostKey /etc/ssh/ssh_host_rsa_key</span><br><span class="line">HostKey /etc/ssh/ssh_host_dsa_key</span><br><span class="line">#Privilege Separation is turned on for security</span><br><span class="line">UsePrivilegeSeparation yes</span><br><span class="line"></span><br><span class="line"># Lifetime and size of ephemeral version 1 server key</span><br><span class="line">KeyRegenerationInterval 3600</span><br><span class="line">ServerKeyBits 768</span><br><span class="line"></span><br><span class="line"># Logging</span><br><span class="line">SyslogFacility AUTH</span><br><span class="line">LogLevel DEBUG3</span><br><span class="line"></span><br><span class="line"># Authentication:</span><br><span class="line">LoginGraceTime 120</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">StrictModes yes</span><br><span class="line"></span><br><span class="line">RSAAuthentication no</span><br><span class="line">PubkeyAuthentication yes   #使用公钥验证</span><br><span class="line">AuthorizedKeysFile	/home/git/.ssh/authorized_keys #公钥文件地址，使我们创建的，并且需要把各个用户的公钥收集起来，然后黏贴到这个文件中</span><br><span class="line"># Don&apos;t read the user&apos;s ~/.rhosts and ~/.shosts files</span><br><span class="line">IgnoreRhosts yes</span><br><span class="line"># For this to work you will also need host keys in /etc/ssh_known_hosts</span><br><span class="line">RhostsRSAAuthentication no</span><br><span class="line"># similar for protocol version 2</span><br><span class="line">HostbasedAuthentication no</span><br><span class="line"># Uncomment if you don&apos;t trust ~/.ssh/known_hosts for RhostsRSAAuthentication</span><br><span class="line">#IgnoreUserKnownHosts yes</span><br><span class="line"></span><br><span class="line"># To enable empty passwords, change to yes (NOT RECOMMENDED)</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"></span><br><span class="line"># Change to yes to enable challenge-response passwords (beware issues with</span><br><span class="line"># some PAM modules and threads)</span><br><span class="line">ChallengeResponseAuthentication no</span><br><span class="line"></span><br><span class="line"># Change to no to disable tunnelled clear text passwords</span><br><span class="line">#PasswordAuthentication no  #允许使用密码验证</span><br><span class="line"></span><br><span class="line"># Kerberos options</span><br><span class="line">#KerberosAuthentication no</span><br><span class="line">#KerberosGetAFSToken no</span><br><span class="line">#KerberosOrLocalPasswd yes</span><br><span class="line">#KerberosTicketCleanup yes</span><br><span class="line"></span><br><span class="line"># GSSAPI options</span><br><span class="line">#GSSAPIAuthentication no</span><br><span class="line">#GSSAPICleanupCredentials yes</span><br><span class="line"></span><br><span class="line">X11Forwarding yes</span><br><span class="line">X11DisplayOffset 10</span><br><span class="line">PrintMotd no</span><br><span class="line">PrintLastLog yes</span><br><span class="line">TCPKeepAlive yes</span><br><span class="line">#UseLogin no</span><br><span class="line"></span><br><span class="line">#MaxStartups 10:30:60</span><br><span class="line">#Banner /etc/issue.net</span><br><span class="line"></span><br><span class="line"># Allow client to pass locale environment variables</span><br><span class="line">AcceptEnv LANG LC_*</span><br><span class="line"></span><br><span class="line">Subsystem sftp /usr/lib/openssh/sftp-server</span><br><span class="line"></span><br><span class="line"># Set this to &apos;yes&apos; to enable PAM authentication, account processing,</span><br><span class="line"># and session processing. If this is enabled, PAM authentication will</span><br><span class="line"># be allowed through the ChallengeResponseAuthentication and</span><br><span class="line"># PasswordAuthentication.  Depending on your PAM configuration,</span><br><span class="line"># PAM authentication via ChallengeResponseAuthentication may bypass</span><br><span class="line"># the setting of &quot;PermitRootLogin without-password&quot;.</span><br><span class="line"># If you just want the PAM account and session checks to run without</span><br><span class="line"># PAM authentication, then enable this but set PasswordAuthentication</span><br><span class="line"># and ChallengeResponseAuthentication to &apos;no&apos;.</span><br><span class="line">UsePAM yes</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置不允许通过shell登录git用户账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">guoyzh:x:1000:1000:guoyzh,,,:/home/guoyzh:/bin/bash</span><br><span class="line">sshd:x:115:65534::/var/run/sshd:/usr/sbin/nologin</span><br><span class="line">huangyc:x:1001:0:huangyc,,,,:/home/huangyc:/bin/bash</span><br><span class="line">git:x:1002:1002:,,,:/home/git:/usr/bin/git-shell  #改成/usr/bin/git-shell</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试ssh 登录，查找问题的时候可以使用如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh -vT git@10.24.9.244</span><br><span class="line">OpenSSH_7.5p1, OpenSSL 1.0.2k  26 Jan 2017</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: Connecting to 10.24.9.244 [10.24.9.244] port 22.</span><br><span class="line">debug1: Connection established.</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他用户使用 <code>git clone git@10.24.9.244:/home/gitrepo/zoweedoc.git</code>即可clone仓库</p>
</li>
</ol>
<h1 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h1><p>为了不破坏服务器上的环境，安装了个虚拟机来做下面的事情</p>
<p>虚拟机安装：</p>
<p>1.安装VMware workstations</p>
<p>2.下载Ubuntu镜像</p>
<h2 id="安装npm-nodejs"><a href="#安装npm-nodejs" class="headerlink" title="安装npm,nodejs"></a>安装npm,nodejs</h2><p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境，其使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。<br>Node.js 的包管理器 npm，是全球最大的开源库生态系统，功能及其强大。 </p>
<ol>
<li><p>安装nvm</p>
<p> sudo git clone <a href="https://github.com/cnpm/nvm.git" target="_blank" rel="noopener">https://github.com/cnpm/nvm.git</a></p>
<p> <code>vim ~/.bashrc</code></p>
<p>添加 source ~/git/nvm/nvm.sh  配置终端启动时自动执行 <code>source ~/git/nvm/nvm.sh</code></p>
</li>
<li><p>通过nvm安装node</p>
<p><code>nvm ls-remote</code> 查看远程版本</p>
<p>最新的release版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ nvm --version</span><br><span class="line">0.26.1</span><br></pre></td></tr></table></figure>

<p>先安裝一個</p>
<p>nvm install v9.8.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-03-13 20:23:26 (1.91 MB/s) - ‘/home/lynn/git/nvm/bin/node-v9.8.0-linux-x64/node-v9.8.0-linux-x64.tar.gz’ saved [18071050/18071050]</span><br><span class="line"></span><br><span class="line">WARNING: checksums are currently disabled for node.js v4.0 and later</span><br><span class="line">Now using node v9.8.0 (npm v5.6.0)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Node.js 的包管理器 npm，但是据说比较慢，可以用cnpm来加速</p>
<p><code>npm install koa --registry=http://registry.npm.taobao.org</code></p>
</li>
<li><p>关闭终端后，输入npm无效了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~/git/nvm$ nvm use v9.8.0</span><br><span class="line">Now using node v9.8.0 (npm v5.6.0)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="gitbook"><a href="#gitbook" class="headerlink" title="gitbook"></a>gitbook</h2><h3 id="安装gitbook"><a href="#安装gitbook" class="headerlink" title="安装gitbook"></a>安装gitbook</h3><p>利用npm安装gitbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> npm install gitbook-cli -g</span><br><span class="line">/home/lynn/git/nvm/versions/node/v9.8.0/bin/gitbook -&gt; /home/lynn/git/nvm/versions/node/v9.8.0/lib/node_modules/gitbook-cli/bin/gitbook.js</span><br><span class="line">+ gitbook-cli@2.3.2</span><br><span class="line">added 578 packages in 116.801s</span><br></pre></td></tr></table></figure>

<h3 id="添加demo-gitbook"><a href="#添加demo-gitbook" class="headerlink" title="添加demo gitbook"></a>添加demo gitbook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir demo</span><br><span class="line">cd demo</span><br><span class="line">gitbook init</span><br><span class="line">.......</span><br><span class="line">warn: no summary file in this book </span><br><span class="line">info: create README.md </span><br><span class="line">info: create SUMMARY.md </span><br><span class="line">info: initialization is finished</span><br></pre></td></tr></table></figure>

<p>自动生成了readme 和summary</p>
<h3 id="生成html静态网页"><a href="#生成html静态网页" class="headerlink" title="生成html静态网页"></a>生成html静态网页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitbook build</span><br></pre></td></tr></table></figure>

<p>多了一个<code>_book</code>的目录</p>
<p>打开index.html就可以查看书籍内容</p>
<h3 id="启动服务gitbook-serve"><a href="#启动服务gitbook-serve" class="headerlink" title="启动服务gitbook serve"></a>启动服务gitbook serve</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~/gitbook/zoweedoc$ gitbook serve</span><br><span class="line">Live reload server started on port: 35729</span><br><span class="line">Press CTRL+C to quit ...</span><br><span class="line"></span><br><span class="line">info: 7 plugins are installed </span><br><span class="line">info: loading plugin &quot;livereload&quot;... OK </span><br><span class="line">info: loading plugin &quot;highlight&quot;... OK </span><br><span class="line">info: loading plugin &quot;search&quot;... OK </span><br><span class="line">info: loading plugin &quot;lunr&quot;... OK </span><br><span class="line">info: loading plugin &quot;sharing&quot;... OK </span><br><span class="line">info: loading plugin &quot;fontsettings&quot;... OK </span><br><span class="line">info: loading plugin &quot;theme-default&quot;... OK </span><br><span class="line">info: found 1 pages </span><br><span class="line">info: found 11 asset files </span><br><span class="line">info: &gt;&gt; generation finished with success in 1.9s ! </span><br><span class="line"></span><br><span class="line">Starting server ...</span><br><span class="line">Serving book on http://localhost:4000</span><br></pre></td></tr></table></figure>

<p>可通过浏览器访问gitbook了</p>
<h1 id="push触发"><a href="#push触发" class="headerlink" title="push触发"></a>push触发</h1><p>现在我们可以生成gitbook了，如何在zoweedoc.git有push工作后，立即同步所有的更新，再出发gitbook的build，生成最新的网页代码呢？</p>
<h2 id="Git-钩子"><a href="#Git-钩子" class="headerlink" title="Git 钩子"></a>Git 钩子</h2><p>和其它版本控制系统一样，Git 能在特定的重要动作发生时触发自定义脚本。 有两组这样的钩子：客户端的和服务器端的。 客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。 你可以随心所欲地运用这些钩子。</p>
<ol>
<li>在服务器上建一个普通的Git仓库，用于存放网站</li>
<li>在源git的post-receive中执行git pull的操作，实现文档更新，然后可以重新build </li>
</ol>
<p>但是现在我们的git服务器环境太老了，很多东西没办法安装，上述用hook的方式进行更新，无法实现</p>
<p>采用在另外一台机子上，采用定时更新</p>
<h2 id="定时更新"><a href="#定时更新" class="headerlink" title="定时更新"></a>定时更新</h2><ul>
<li><p>查看当前定时任务</p>
<p>crontab -l</p>
</li>
<li><p>创建编辑定时任务</p>
<p>crontab -e</p>
</li>
<li><p>编辑定时任务</p>
<p><code>* */1 * * * /home/lynn/gitbook/syn.sh /home/lynn/gitbook/zoweedoc</code></p>
<p>脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">source ~/git/nvm/nvm.sh</span><br><span class="line">cd $1</span><br><span class="line">unset GIT_DIR</span><br><span class="line">git pull origin master</span><br><span class="line"></span><br><span class="line">nvm use v9.8.0</span><br><span class="line">gitbook serve</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看定時任務執行情況</p>
<p>看 /var/log/cron这个文件就可以，可以用tail -f /var/log/cron观察</p>
</li>
<li><p>定時任務有沒有啟動排查的</p>
<ul>
<li><p>确认服务器是否开机定时任务计划服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:/var/log$ service crond status</span><br><span class="line">● crond.service</span><br><span class="line">   Loaded: not-found (Reason: No such file or directory)</span><br><span class="line">   Active: inactive (dead)</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ service crond start</span><br><span class="line">Failed to start crond.service: Unit crond.service not found.</span><br></pre></td></tr></table></figure>
</li>
<li><p>新的服务名字变了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo service cron  start #启动服务</span><br><span class="line">lynn@ubuntu:~$ service cron status</span><br><span class="line">● cron.service - Regular background program processing daemon</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/cron.service; enabled; vendor preset: ena</span><br><span class="line">   Active: active (running) since Wed 2018-03-14 00:49:42 PDT; 1h 47min ago</span><br><span class="line">     Docs: man:cron(8)</span><br><span class="line"> Main PID: 793 (cron)</span><br><span class="line">   CGroup: /system.slice/cron.service</span><br><span class="line">           └─793 /usr/sbin/cron -f</span><br><span class="line"></span><br><span class="line">Mar 14 02:15:01 ubuntu CRON[3456]: (CRON) info (No MTA installed, discarding out</span><br><span class="line">Mar 14 02:15:01 ubuntu CRON[3456]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3474]: pam_unix(cron:session): session opened for us</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3475]: (root) CMD (   cd / &amp;&amp; run-parts --report /et</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3474]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: pam_unix(cron:session): session opened for us</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3648]: (lynn) CMD (/home/lynn/gitbook/syn.sh /home/l</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: (CRON) info (No MTA installed, discarding out</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:36:28 ubuntu systemd[1]: Started Regular background program processing</span><br><span class="line">lines 1-18/18 (END)</span><br></pre></td></tr></table></figure>
</li>
<li><p>​</p>
</li>
</ul>
</li>
</ul>
<p>定时更新<a href="http://blog.csdn.net/csdn_yasin/article/details/70332796" target="_blank" rel="noopener">http://blog.csdn.net/csdn_yasin/article/details/70332796</a></p>
<p>查看执行情况</p>
<p><a href="http://blog.csdn.net/u013850277/article/details/54344805" target="_blank" rel="noopener">http://blog.csdn.net/u013850277/article/details/54344805</a></p>
<h2 id="访问虚拟机服务器IP"><a href="#访问虚拟机服务器IP" class="headerlink" title="访问虚拟机服务器IP"></a>访问虚拟机服务器IP</h2><h3 id="本机访问虚拟机服务器"><a href="#本机访问虚拟机服务器" class="headerlink" title="本机访问虚拟机服务器"></a>本机访问虚拟机服务器</h3><p>虚拟机通过ifconfig查询虚拟机IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ ifconfig</span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0c:29:5d:64:1f  </span><br><span class="line">          inet addr:192.168.32.128  Bcast:192.168.32.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::aae1:44b2:cc44:dbba/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:101881 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:33601 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:121150102 (121.1 MB)  TX bytes:2044329 (2.0 MB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:234 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:234 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:18513 (18.5 KB)  TX bytes:18513 (18.5 KB)</span><br></pre></td></tr></table></figure>

<p>本机可直接通过，访问虚拟机服务器，查看gitbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.32.128:4000/</span><br></pre></td></tr></table></figure>

<h3 id="其他机子如何访问"><a href="#其他机子如何访问" class="headerlink" title="其他机子如何访问"></a>其他机子如何访问</h3><ol>
<li>将虚拟机设置成NAT模式</li>
<li>启动虚拟网络编辑器，选择VMnet8，选择NAT模式，选择NAT设置</li>
<li>点击添加，主机端口8888，即希望别的机子访问的端口号<code>http://主机IP:8888/</code>，虚拟机地址，虚拟机实际IP地址，ifconfig查看，<code>192.168.32.128</code>，虚拟机端口，因为gitbook serve端口是4000，所以填4000</li>
<li>完成确定</li>
</ol>
<p>这样在其他主机就可以通过<code>http://主机IP:8888/</code>访问主机上虚拟机的4000端口服务了。</p>
<p>参考设置<a href="https://jingyan.baidu.com/article/8065f87fe9773b23312498a9.html" target="_blank" rel="noopener">如何配置其他主机访问虚拟机</a></p>
<h1 id="md文件编辑器"><a href="#md文件编辑器" class="headerlink" title="md文件编辑器"></a>md文件编辑器</h1><p>推荐使用typora，window版本的软件安装包地址 <code>\\10.24.9.247\360Downloads\.01应用组共享资料\09软件工具\typora-setup-x64.exe</code> </p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/02/27/google VR pana and video/">Google VR SDK 示例 360 media</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-27
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Google-VR-SDK-示例代码全景和视频"><a href="#Google-VR-SDK-示例代码全景和视频" class="headerlink" title="Google VR SDK 示例代码全景和视频"></a>Google VR SDK 示例代码全景和视频</h1><p>Google的SDK示例代码中有两个应用 simplepanowidget和simlevrvideo展示了如何内嵌一个360度的图片或者是视频。</p>
<h2 id="什么是360-media"><a href="#什么是360-media" class="headerlink" title="什么是360 media"></a>什么是360 media</h2><p>360度媒介，包括360度全景图片和360度全景视频。通过他们，可以加强传统应用的沉浸式体验。例如可以在旅游类应用中添加这种视图查看器作为海底世界游览体验，在家装应用中，让消费者可以先体验一下虚拟的效果。</p>
<p>这些360度媒介支持立体变化并与Google cardboard等vr平台兼容，也支持在浏览器中或者移动应用中查看而不需要特定的vr硬件支持。</p>
<ul>
<li><p>常见格式</p>
<p>360度媒体的格式可以是 mono或者是stereo。图片和视频通常需要存储在equirectangular-panoramic (equirect-pano)格式中，可以理解为柱体全景格式，这种格式为大部分拍摄解决方案所支持的格式。</p>
<p>Mono 360使用一张全景，stero 360使用两张堆积的全景图片。stero在全景之上，还有一个景深的这样一个概念，我们对前景和背景的距离深度有了一个感官的体验。</p>
</li>
<li><p>360度图片</p>
<p>可以以png,jpeg,gif的格式进行存储，建议使用jpeg来提高压缩率</p>
<p>为了最大限度的提高兼容性和性能，需要的尺寸是2次幂，2024，4096这样</p>
<p>mono图片，单张的方案，需要2:1的宽高比 例如4096*4096</p>
<p>stereo图片，左右两张堆积方案的，需要1:1的宽高比 4096*4096</p>
</li>
<li><p>360度视频</p>
<p>以h2642编码的mp4s格式存储</p>
<p>mono方案提供2:1宽高比</p>
<p>stereo提供1:1宽高比</p>
<p>一些比较老的设备无法对大雨1080p(1920*1080)的视频进行解码，如果要进行兼容，建议提供提供monoscopic 1920 * 1080的视频和stereo 2048 * 2048的的视频</p>
</li>
<li><p>如何内嵌和显示这些媒体</p>
<ul>
<li><a href="https://developers.google.com/vr/android/samples/vrview" target="_blank" rel="noopener">VR View on Android</a></li>
<li><a href="https://developers.google.com/vr/concepts/vrview-web" target="_blank" rel="noopener">VR View on the Web</a></li>
</ul>
<p>另外也有ios平台等</p>
</li>
</ul>
<h2 id="如何拍摄到全景的媒体"><a href="#如何拍摄到全景的媒体" class="headerlink" title="如何拍摄到全景的媒体"></a>如何拍摄到全景的媒体</h2><ul>
<li><p>实景拍摄</p>
<ul>
<li><a href="https://play.google.com/store/apps/details?id=com.google.vr.cyclops" target="_blank" rel="noopener">Cardboard Camera App</a>:    使用该应用可以快速的拍摄360全景图片，然后可以下载  <a href="https://support.google.com/cardboard/answer/6333620" target="_blank" rel="noopener">download</a>    这些图片然后使用    <a href="https://storage.googleapis.com/cardboard-camera-converter/index.html" target="_blank" rel="noopener">conversion tool</a>    来生成 stereo 360° 图片，就可以符合 Cardboard’s 图片要求了。</li>
<li><a href="https://theta360.com/" target="_blank" rel="noopener">Ricoh Theta</a>: 可用于拍摄 mono 360° 图片和视频 </li>
</ul>
</li>
<li><p>CG capture</p>
<p>cgi软件可根据生成全景图片和视频，一些热门的拍摄方案如下</p>
<ul>
<li><a href="https://assetstore.unity.com/packages/tools/camera/360-panorama-capture-38755" target="_blank" rel="noopener">360 Panorama Capture for Unity</a>:    A free, easy-to-use 360° capture plugin for <strong>Unity</strong>.</li>
<li><a href="https://docs.unrealengine.com/latest/INT/Platforms/VR/StereoPanoramicCapture/" target="_blank" rel="noopener">Unreal</a>: Stero panoramic capture in <strong>Unreal</strong>.</li>
<li>(Unsupported) <a href="https://github.com/zicher3d-org/domemaster-stereo-shader/" target="_blank" rel="noopener">Domemaster3D</a>:    A free solution for capturing mono and stereo 360° images from Maya / Autodesk 3ds Max.</li>
<li><a href="https://drive.google.com/drive/folders/0B0lYKpimsJgWfjFwa2xLQlVGNnJXcGxvbmNJbzIwUkRWQ2YtOHB5blNMNjlXSUlxbmJNVVU" target="_blank" rel="noopener">Renderman</a>:    Open-source library for capturing 360° content.开源库</li>
<li><a href="https://developers.google.com/vr/jump/rendering-ods-content.pdf" target="_blank" rel="noopener">Rendering Omnidirectional Stereo Content</a>:    A whitepaper for anyone interested in writing their own 360° capture    solutions.</li>
</ul>
</li>
<li><p>YouTube下载，在YouTube上搜索monoscopic的视频，然后通过 <a href="http://youtubemp4.to/" target="_blank" rel="noopener">http://youtubemp4.to/</a> 来下载mp4格式的文件</p>
</li>
</ul>
<h2 id="全景图片walkthrough"><a href="#全景图片walkthrough" class="headerlink" title="全景图片walkthrough"></a>全景图片walkthrough</h2><p>根据Gsensor的数据展示不同的方位景物；</p>
<p>全屏模式 和 cardboard 模式切换</p>
<ul>
<li><p>代码概览</p>
<p>在layout XML文件中，嵌入，该组件自身就集成了全屏，立体模式，退出等模式的切换按钮</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.google.vr.sdk.widgets.pano.VrPanoramaView</span><br><span class="line">          android:id=&quot;@+id/pano_view&quot;</span><br><span class="line">          android:layout_margin=&quot;5dip&quot;</span><br><span class="line">          android:layout_width=&quot;match_parent&quot;</span><br><span class="line">          android:scrollbars=&quot;@null&quot;</span><br><span class="line">          android:layout_height=&quot;250dip&quot;/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>activitie 代码</p>
<p>初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  @Override</span><br><span class="line">  protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">    super.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.main_layout);</span><br><span class="line">.......</span><br><span class="line">    panoWidgetView = (VrPanoramaView) findViewById(R.id.pano_view);</span><br><span class="line">    panoWidgetView.setEventListener(new ActivityEventListener());</span><br><span class="line"></span><br><span class="line">    // Initial launch of the app or an Activity recreation due to rotation.</span><br><span class="line">    handleIntent(getIntent());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中ActivityEventListener继承自VrPanoramaEventListener，用于监听来自widget的事件，例如当widget加载完图片后的onLoadSuccess回调。或者加载失败后的onLoadError回调。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Listen to the important events from widget.</span><br><span class="line">   */</span><br><span class="line">  private class ActivityEventListener extends VrPanoramaEventListener &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Called by pano widget on the UI thread when it&apos;s done loading the image.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadSuccess() &#123;</span><br><span class="line">      loadImageSuccessful = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called by pano widget on the UI thread on any asynchronous error.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadError(String errorMessage) &#123;</span><br><span class="line">      loadImageSuccessful = false;</span><br><span class="line">      Toast.makeText(</span><br><span class="line">          SimpleVrPanoramaActivity.this, &quot;Error loading pano: &quot; + errorMessage, Toast.LENGTH_LONG)</span><br><span class="line">          .show();</span><br><span class="line">      Log.e(TAG, &quot;Error loading pano: &quot; + errorMessage);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在线程中加载图片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Helper class to manage threading.</span><br><span class="line">   */</span><br><span class="line">  class ImageLoaderTask extends AsyncTask&lt;Pair&lt;Uri, Options&gt;, Void, Boolean&gt; &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Reads the bitmap from disk in the background and waits until it&apos;s loaded by pano widget.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected Boolean doInBackground(Pair&lt;Uri, Options&gt;... fileInformation) &#123;</span><br><span class="line">      Options panoOptions = null;  // It&apos;s safe to use null VrPanoramaView.Options.</span><br><span class="line">      InputStream istr = null;</span><br><span class="line">      if (fileInformation == null || fileInformation.length &lt; 1</span><br><span class="line">          || fileInformation[0] == null || fileInformation[0].first == null) &#123;</span><br><span class="line">        AssetManager assetManager = getAssets();</span><br><span class="line">        try &#123;</span><br><span class="line">          istr = assetManager.open(&quot;andes.jpg&quot;);／／打开assert文件</span><br><span class="line">          panoOptions = new Options();</span><br><span class="line">          panoOptions.inputType = Options.TYPE_STEREO_OVER_UNDER;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">          Log.e(TAG, &quot;Could not decode default bitmap: &quot; + e);</span><br><span class="line">          return false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          istr = new FileInputStream(new File(fileInformation[0].first.getPath()));</span><br><span class="line">          panoOptions = fileInformation[0].second;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">          Log.e(TAG, &quot;Could not load file: &quot; + e);</span><br><span class="line">          return false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      panoWidgetView.loadImageFromBitmap(BitmapFactory.decodeStream(istr), panoOptions);／／将读取的iostream进行加载</span><br><span class="line">      try &#123;</span><br><span class="line">        istr.close();</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        Log.e(TAG, &quot;Could not close input stream: &quot; + e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<h2 id="全景视频walkthrough"><a href="#全景视频walkthrough" class="headerlink" title="全景视频walkthrough"></a>全景视频walkthrough</h2><p>全景视频的视图和全景图片的非常相似，使用上也差不多，展现出来的，就是一个是视频画面生动的效果</p>
<p>XML集成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.google.vr.sdk.widgets.video.VrVideoView</span><br><span class="line">          android:id=&quot;@+id/video_view&quot;</span><br><span class="line">          android:layout_width=&quot;match_parent&quot;</span><br><span class="line">          android:scrollbars=&quot;@null&quot;</span><br><span class="line">          android:layout_height=&quot;250dip&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Bind input and output objects for the view.</span><br><span class="line">   videoWidgetView = (VrVideoView) findViewById(R.id.video_view);</span><br><span class="line">   videoWidgetView.setEventListener(new ActivityEventListener());</span><br></pre></td></tr></table></figure>

<p>其中ActivityEventListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Listen to the important events from widget.</span><br><span class="line">   */</span><br><span class="line">  private class ActivityEventListener extends VrVideoEventListener  &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Called by video widget on the UI thread when it&apos;s done loading the video.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadSuccess() &#123;</span><br><span class="line">    ／／加载成功的时候，根据视频的长度，设置进度条最大值</span><br><span class="line">      Log.i(TAG, &quot;Successfully loaded video &quot; + videoWidgetView.getDuration());</span><br><span class="line">      loadVideoStatus = LOAD_VIDEO_STATUS_SUCCESS;</span><br><span class="line">      seekBar.setMax((int) videoWidgetView.getDuration());</span><br><span class="line">      updateStatusText();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called by video widget on the UI thread on any asynchronous error.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadError(String errorMessage) &#123;</span><br><span class="line">      // An error here is normally due to being unable to decode the video format.</span><br><span class="line">      loadVideoStatus = LOAD_VIDEO_STATUS_ERROR;</span><br><span class="line">      Toast.makeText(</span><br><span class="line">          SimpleVrVideoActivity.this, &quot;Error loading video: &quot; + errorMessage, Toast.LENGTH_LONG)</span><br><span class="line">          .show();</span><br><span class="line">      Log.e(TAG, &quot;Error loading video: &quot; + errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onClick() &#123;</span><br><span class="line">      togglePause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Update the UI every frame.每一帧更新进度条</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onNewFrame() &#123;</span><br><span class="line">      updateStatusText();</span><br><span class="line">      seekBar.setProgress((int) videoWidgetView.getCurrentPosition());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Make the video play in a loop. This method could also be used to move to the next video in</span><br><span class="line">     * a playlist.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onCompletion() &#123;</span><br><span class="line">      videoWidgetView.seekTo(0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>加载视频的线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Helper class to manage threading.</span><br><span class="line">   */</span><br><span class="line">  class VideoLoaderTask extends AsyncTask&lt;Pair&lt;Uri, Options&gt;, Void, Boolean&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Boolean doInBackground(Pair&lt;Uri, Options&gt;... fileInformation) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">         if (fileInformation == null || fileInformation.length &lt; 1</span><br><span class="line">          || fileInformation[0] == null || fileInformation[0].first == null) &#123;</span><br><span class="line">          // No intent was specified, so we default to playing the local stereo-over-under video.</span><br><span class="line">          Options options = new Options();</span><br><span class="line">          options.inputType = Options.TYPE_STEREO_OVER_UNDER;</span><br><span class="line">          videoWidgetView.loadVideoFromAsset(&quot;congo.mp4&quot;, options);直接根据文件名加载</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">          videoWidgetView.loadVideo(fileInformation[0].first, fileInformation[0].second);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        // An error here is normally due to being unable to locate the file.</span><br><span class="line">        loadVideoStatus = LOAD_VIDEO_STATUS_ERROR;</span><br><span class="line">        // Since this is a background thread, we need to switch to the main thread to show a toast.</span><br><span class="line">        videoWidgetView.post(new Runnable() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public void run() &#123;</span><br><span class="line">            Toast</span><br><span class="line">                .makeText(SimpleVrVideoActivity.this, &quot;Error opening file. &quot;, Toast.LENGTH_LONG)</span><br><span class="line">                .show();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Log.e(TAG, &quot;Could not open video: &quot; + e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这两个应用主要展示 VrPanoramaView 和VrVideoView的基本用法</p>
<h2 id="番外示例video360和videoplayer"><a href="#番外示例video360和videoplayer" class="headerlink" title="番外示例video360和videoplayer"></a>番外示例video360和videoplayer</h2><h3 id="sdk-video360"><a href="#sdk-video360" class="headerlink" title="sdk-video360"></a>sdk-video360</h3><p>video360要求设备最低版本为android 24，android N 7.0以上</p>
<p>可以渲染全景视频的播放器。 根据intent中的文件uri来进行进行视频播放。应用中定义了两个activity，一个只能在2d的launcher中显示图标，另外一个只能在专属的Daydream Home中显示图标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- This is a 2D Version of the video player. --&gt;</span><br><span class="line">   &lt;activity</span><br><span class="line">       android:name=&quot;.VideoActivity&quot;</span><br><span class="line">       android:icon=&quot;@drawable/icon&quot;</span><br><span class="line">       android:label=&quot;@string/app_name&quot;</span><br><span class="line">       android:launchMode=&quot;singleTask&quot;</span><br><span class="line">       android:screenOrientation=&quot;portrait&quot;&gt;</span><br><span class="line">     &lt;!-- This Activity only shows up in the 2D launcher.  --&gt;</span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">         &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line">         &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">     &lt;/intent-filter&gt;</span><br><span class="line">   &lt;/activity&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- This is a standard Daydream Activity.  --&gt;</span><br><span class="line">   &lt;activity</span><br><span class="line">       android:name=&quot;.VrVideoActivity&quot;</span><br><span class="line">       android:configChanges=&quot;orientation|keyboardHidden|screenSize|uiMode|navigation&quot;</span><br><span class="line">       android:enableVrMode=&quot;@string/gvr_vr_mode_component&quot;</span><br><span class="line">       android:label=&quot;@string/app_name&quot;</span><br><span class="line">       android:launchMode=&quot;singleTask&quot;</span><br><span class="line">       android:resizeableActivity=&quot;false&quot;</span><br><span class="line">       android:screenOrientation=&quot;landscape&quot;</span><br><span class="line">       android:theme=&quot;@style/VrActivityTheme&quot;&gt;</span><br><span class="line"></span><br><span class="line">     &lt;!-- The VR icon to be used in Daydream Home comes in two parts: a foreground icon and a</span><br><span class="line">          background icon. The foreground icon is also used by the 2D Activity. --&gt;</span><br><span class="line">     &lt;meta-data</span><br><span class="line">         android:name=&quot;com.google.android.vr.icon&quot;</span><br><span class="line">         android:resource=&quot;@drawable/icon&quot; /&gt;</span><br><span class="line">     &lt;meta-data</span><br><span class="line">         android:name=&quot;com.google.android.vr.icon_background&quot;</span><br><span class="line">         android:resource=&quot;@drawable/vr_icon_background&quot; /&gt;</span><br><span class="line"></span><br><span class="line">     &lt;!-- This Activity only shows up in Daydream Home and not the 2D Launcher. --&gt;</span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">       &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line">       &lt;category android:name=&quot;com.google.intent.category.DAYDREAM&quot;/&gt;</span><br><span class="line">     &lt;/intent-filter&gt;</span><br><span class="line">   &lt;/activity&gt;</span><br></pre></td></tr></table></figure>

<p>其中activity的大部分代码都是和权限相关的，真正的视频解析加载在MediaLoader中，从类的说明中可以看到，可以通过adb命令来传递intent来打开视频：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Example intents compatible with adb are:</span><br><span class="line">*   &lt;ul&gt;</span><br><span class="line">*     &lt;li&gt;</span><br><span class="line">*       A top-bottom stereo image in the VR Activity.</span><br><span class="line">*       &lt;b&gt;adb shell am start -a android.intent.action.VIEW  \</span><br><span class="line">*          -n com.google.vr.sdk.samples.video360/.VrVideoActivity \</span><br><span class="line">*          -d &quot;file:///sdcard/IMAGE.JPG&quot; \</span><br><span class="line">*          --ei stereoFormat 2</span><br><span class="line">*       &lt;/b&gt;</span><br><span class="line">*     &lt;/li&gt;</span><br><span class="line">*     &lt;li&gt;</span><br><span class="line">*       A monoscopic video in the 2D Activity.</span><br><span class="line">*       &lt;b&gt;adb shell am start -a android.intent.action.VIEW  \</span><br><span class="line">*          -n com.google.vr.sdk.samples.video360/.VideoActivity \</span><br><span class="line">*          -d &quot;file:///sdcard/VIDEO.MP4&quot; \</span><br><span class="line">*          --ei stereoFormat 0</span><br><span class="line">*       &lt;/b&gt;</span><br><span class="line">*     &lt;/li&gt;</span><br><span class="line">*   &lt;/ul&gt;</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;This sample does not validiate that a given file is readable by the Android media decoders.</span><br><span class="line">* You should validate that the file plays on your target devices via</span><br><span class="line">* &lt;b&gt;adb shell am start -a android.intent.action.VIEW -t video/mpeg -d &quot;file:///VIDEO.MP4&quot;&lt;/b&gt;</span><br></pre></td></tr></table></figure>

<p>我们从YouTube上下载了一个monoscopic的视频，放在sdcard的目录下，通过运行命令可播放对应的全景视频</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">F:\09androidsdk&gt;adb shell am start -a android.intent.action.VIEW -n com.google.v</span><br><span class="line">r.sdk.samples.video360/.VideoActivity -d &quot;file://storage/sdcard/monoscopicVideo.</span><br><span class="line">mp4&quot; --ei stereoFormat 0</span><br><span class="line">Starting: Intent &#123; act=android.intent.action.VIEW dat=file://storage/sdcard/mono</span><br><span class="line">scopicVideo.mp4 cmp=com.google.vr.sdk.samples.video360/.VideoActivity (has extra</span><br><span class="line">s) &#125;</span><br></pre></td></tr></table></figure>

<p>该命令启用的是VideoActivity来播放全景视频，参数stereoFormat 0表示，视频类型为单个摄像头帧拍摄的全景视频。1表示用左右眼的方式渲染的，如果在非vr的显示中显示的话，则只显示左眼部分。2表示上下部分分割的左右眼渲染方式，如果在非vr显示中显示的话，只显示上部分内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/** Standard media where a single camera frame takes up the entire media frame. */</span><br><span class="line">  public static final int MEDIA_MONOSCOPIC = 0;</span><br><span class="line">  /**</span><br><span class="line">   * Stereo media where the left &amp; right halves of the frame are rendered for the left &amp; right eyes,</span><br><span class="line">   * respectively. If the stereo media is rendered in a non-VR display, only the left half is used.</span><br><span class="line">   */</span><br><span class="line">  public static final int MEDIA_STEREO_LEFT_RIGHT = 1;</span><br><span class="line">  /**</span><br><span class="line">   * Stereo media where the top &amp; bottom halves of the frame are rendered for the left &amp; right eyes,</span><br><span class="line">   * respectively. If the stereo media is rendered in a non-VR display, only the top half is used.</span><br><span class="line">   */</span><br><span class="line">  public static final int MEDIA_STEREO_TOP_BOTTOM = 2;</span><br></pre></td></tr></table></figure>

<p>播放器demo在8996上 android6.0无法运行。</p>
<p><strong>在8953上可以运行播放3d stereo视频，视频播放不正常，叠加不正确。</strong></p>
<p>但是切换成cardboard模式的点击 眼镜 标示的图标按钮后，切换到VrVideoActivity提示：</p>
<blockquote>
<p>手机不兼容：手机必须与Daydream兼容，请访问Daydream帮助中心了解详情。</p>
</blockquote>
<p>在moto     z和pixel等兼容手机上可正常运行，实现左右眼形变播放，中间会弹出和daydream控制器的配对的等。</p>
<p>对应配合Daydream viewer应该就可以看到立体视频效果。</p>
<p><em>TODO: 如何与Daydream平台进行兼容，需要做哪些工作，目前官网上列出的课兼容手机有华为mate，三星galaxy note8，pixel，moto z等手机。</em></p>
<h3 id="sdk-videoplayer"><a href="#sdk-videoplayer" class="headerlink" title="sdk-videoplayer"></a>sdk-videoplayer</h3><p>通过 Asynchronous Reprojection Video Surface API来播放视频，也是一个播放器。</p>
<p>在5516上，运行出错，暂时不研究了</p>

        </div></article>
      <nav class="pagination"><a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    <a class="next" href="/page/3/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">lynn8570</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
