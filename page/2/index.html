<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="android"><meta name="keywords" content="android"><link rel="alternate" href="/default" title="Lynn8570's Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="https://lynn8570.github.io/page/2/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>Lynn8570's Blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Lynn8570's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Lynn8570's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/svg路径动画/">svg路径动画</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Svg-路径动画效果"><a href="#Svg-路径动画效果" class="headerlink" title="Svg 路径动画效果"></a>Svg 路径动画效果</h1><p>项目地址：<a href="https://github.com/geftimov/android-pathview" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://github.com/geftimov/android-pathview/blob/master/art/fill-after-resize-new.gif" alt="svg path动画"></p>
<h2 id="什么是svg"><a href="#什么是svg" class="headerlink" title="什么是svg"></a>什么是svg</h2><p>Scalable Vector Graphics (SVG)可缩放的矢量图形，应用几个定义<a href="https://en.wikipedia.org/wiki/Scalable_Vector_Graphics" target="_blank" rel="noopener">wiki</a></p>
<blockquote>
<ul>
<li>SVG 指可伸缩矢量图形 (Scalable Vector Graphics)</li>
<li>SVG 用来定义用于网络的基于<a href="https://baike.baidu.com/item/%E7%9F%A2%E9%87%8F/1400417" target="_blank" rel="noopener">矢量</a>的图形</li>
<li>SVG 使用 XML 格式定义图形</li>
<li>SVG 图像在放大或改变尺寸的情况下其图形质量不会有所损失</li>
<li>SVG 是万维网<a href="https://baike.baidu.com/item/%E8%81%94%E7%9B%9F/4799014" target="_blank" rel="noopener">联盟</a>的标准</li>
<li>SVG 与诸如 <a href="https://baike.baidu.com/item/DOM/50288" target="_blank" rel="noopener">DOM</a>和 <a href="https://baike.baidu.com/item/XSL" target="_blank" rel="noopener">XSL</a> 之类的<a href="https://baike.baidu.com/item/W3C" target="_blank" rel="noopener">W3C</a>标准是一个整体</li>
</ul>
</blockquote>
<h2 id="PathView做了什么"><a href="#PathView做了什么" class="headerlink" title="PathView做了什么"></a>PathView做了什么</h2><p>通过XML方式获取svg资源id </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.eftimoff.androipathview.PathView</span><br><span class="line">        android:id=&quot;@+id/pathView&quot;</span><br><span class="line">        android:layout_width=&quot;350dp&quot;</span><br><span class="line">        android:layout_height=&quot;350dp&quot;</span><br><span class="line">        app:svg=&quot;@raw/monitor&quot;  //在res/raw文件夹中，</span><br><span class="line">        app:pathColor=&quot;@android:color/white&quot;</span><br><span class="line">        app:pathWidth=&quot;2dp&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>在onSizeChanged的时候加载svg文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  protected void onSizeChanged(final int w, final int h, int oldw, int oldh) &#123;</span><br><span class="line">      super.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line"></span><br><span class="line">      if (mLoader != null) &#123;</span><br><span class="line">          try &#123;</span><br><span class="line">              mLoader.join();//必须在loader运行完毕后，再运行</span><br><span class="line">          &#125; catch (InterruptedException e) &#123;</span><br><span class="line">              Log.e(LOG_TAG, &quot;Unexpected error&quot;, e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (svgResourceId != 0) &#123;</span><br><span class="line">          mLoader = new Thread(new Runnable() &#123;</span><br><span class="line">              @Override</span><br><span class="line">              public void run() &#123;</span><br><span class="line"></span><br><span class="line">                  svgUtils.load(getContext(), svgResourceId);通过svg包加载资源文件到 mSvg</span><br><span class="line"></span><br><span class="line">                  synchronized (mSvgLock) &#123;</span><br><span class="line">                      width = w - getPaddingLeft() - getPaddingRight();</span><br><span class="line">                      height = h - getPaddingTop() - getPaddingBottom();</span><br><span class="line">                      paths = svgUtils.getPathsForViewport(width, height);</span><br><span class="line">                      updatePathsPhaseLocked();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, &quot;SVG Loader&quot;);</span><br><span class="line">          mLoader.start();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中load主要是加载资源文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Loading the svg from the resources.</span><br><span class="line"> *</span><br><span class="line"> * @param context     Context object to get the resources.</span><br><span class="line"> * @param svgResource int resource id of the svg.</span><br><span class="line"> */</span><br><span class="line">public void load(Context context, int svgResource) &#123;</span><br><span class="line">    if (mSvg != null) </span><br><span class="line">        return;</span><br><span class="line">    try &#123;</span><br><span class="line">        mSvg = SVG.getFromResource(context, svgResource);//通过 com.caverock.androidsvg api加载</span><br><span class="line">        mSvg.setDocumentPreserveAspectRatio(PreserveAspectRatio.UNSCALED);</span><br><span class="line">    &#125; catch (SVGParseException e) &#123;</span><br><span class="line">        Log.e(LOG_TAG, &quot;Could not load specified SVG resource&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getPathsForViewport，将</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Render the svg to canvas and catch all the paths while rendering.</span><br><span class="line"> *</span><br><span class="line"> * @param width  - the width to scale down the view to,</span><br><span class="line"> * @param height - the height to scale down the view to,</span><br><span class="line"> * @return All the paths from the svg.</span><br><span class="line"> */</span><br><span class="line">public List&lt;SvgPath&gt; getPathsForViewport(final int width, final int height) &#123;</span><br><span class="line">    final float strokeWidth = mSourcePaint.getStrokeWidth();</span><br><span class="line">    Canvas canvas = new Canvas() &#123;</span><br><span class="line">        private final Matrix mMatrix = new Matrix();</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getWidth() &#123;</span><br><span class="line">            return width;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getHeight() &#123;</span><br><span class="line">            return height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void drawPath(Path path, Paint paint) &#123;</span><br><span class="line">            Path dst = new Path();</span><br><span class="line"></span><br><span class="line">            //noinspection deprecation</span><br><span class="line">            getMatrix(mMatrix);</span><br><span class="line">            path.transform(mMatrix, dst);//将path中的点进行mMatrix变化后，并将最终的path写到dst path中</span><br><span class="line">            paint.setAntiAlias(true);//抗锯齿</span><br><span class="line">            paint.setStyle(Paint.Style.STROKE);</span><br><span class="line">            paint.setStrokeWidth(strokeWidth);</span><br><span class="line">            mPaths.add(new SvgPath(dst, paint));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    rescaleCanvas(width, height, strokeWidth, canvas);</span><br><span class="line"></span><br><span class="line">    return mPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rescaleCanvas：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Rescale the canvas with specific width and height.</span><br><span class="line">    *</span><br><span class="line">    * @param width       The width of the canvas.</span><br><span class="line">    * @param height      The height of the canvas.</span><br><span class="line">    * @param strokeWidth Width of the path to add to scaling.</span><br><span class="line">    * @param canvas      The canvas to be drawn.</span><br><span class="line">    */</span><br><span class="line">   private void rescaleCanvas(int width, int height, float strokeWidth, Canvas canvas) &#123;</span><br><span class="line">       if (mSvg == null) </span><br><span class="line">           return;</span><br><span class="line">       final RectF viewBox = mSvg.getDocumentViewBox();</span><br><span class="line"></span><br><span class="line">       final float scale = Math.min(width</span><br><span class="line">                       / (viewBox.width() + strokeWidth),</span><br><span class="line">               height / (viewBox.height() + strokeWidth));</span><br><span class="line"></span><br><span class="line">       canvas.translate((width - viewBox.width() * scale) / 2.0f,</span><br><span class="line">               (height - viewBox.height() * scale) / 2.0f);</span><br><span class="line">       canvas.scale(scale, scale);</span><br><span class="line"></span><br><span class="line">       mSvg.renderToCanvas(canvas);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>对于Matrix的学习扩展，请参阅<a href="https://blog.csdn.net/abcdef314159/article/details/52813313" target="_blank" rel="noopener">Matrix源码详解</a></p>
<p><a href="https://github.com/GcsSloop/AndroidNote/blob/master/CustomView/Advance/[09]Matrix_Basic.md" target="_blank" rel="noopener">matrix原理</a></p>
<p>动画影响的属性是percentage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Default constructor.</span><br><span class="line">  *</span><br><span class="line">  * @param pathView The view that must be animated.</span><br><span class="line">  */</span><br><span class="line"> public AnimatorBuilder(final PathView pathView) &#123;</span><br><span class="line">     anim = ObjectAnimator.ofFloat(pathView, &quot;percentage&quot;, 0.0f, 1.0f);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过影响percentage的值，从而影响</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Animate this property. It is the percentage of the path that is drawn.</span><br><span class="line"> * It must be [0,1].</span><br><span class="line"> *</span><br><span class="line"> * @param percentage float the percentage of the path.</span><br><span class="line"> */</span><br><span class="line">public void setPercentage(float percentage) &#123;</span><br><span class="line">    if (percentage &lt; 0.0f || percentage &gt; 1.0f) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;setPercentage not between 0.0f and 1.0f&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    progress = percentage;</span><br><span class="line">    synchronized (mSvgLock) &#123;</span><br><span class="line">        updatePathsPhaseLocked();//更新path</span><br><span class="line">    &#125;</span><br><span class="line">    invalidate();再重新绘制</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据progress，更新svgPath</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This refreshes the paths before draw and resize.</span><br><span class="line"> */</span><br><span class="line">private void updatePathsPhaseLocked() &#123;</span><br><span class="line">    final int count = paths.size();</span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        SvgUtils.SvgPath svgPath = paths.get(i);</span><br><span class="line">        svgPath.path.reset();</span><br><span class="line">        svgPath.measure.getSegment(0.0f, svgPath.length * progress, svgPath.path, true);</span><br><span class="line">        //Given a start and stop distance, return in dst the intervening segment(s). If the segment is zero-length, return false, else return true. startD and stopD are pinned to legal values (0..getLength()). If startD &lt;= stopD then return false (and leave dst untouched). Begin the segment with a moveTo if startWithMoveTo is true</span><br><span class="line">        // Required only for Android 4.4 and earlier</span><br><span class="line">        svgPath.path.rLineTo(0.0f, 0.0f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从而实现，path动画</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/wave动画效果/">wave动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Wave动画效果"><a href="#Wave动画效果" class="headerlink" title="Wave动画效果"></a>Wave动画效果</h1><p>项目地址：<a href="https://github.com/tangqi92/WaveLoadingView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/8f83a9935a2b79ed9c63749a1b1b907e2cae850a/687474703a2f2f3778696b66632e636f6d312e7a302e676c622e636c6f7564646e2e636f6d2f776176656c6f6164696e67766965772e706e67" alt="image"></p>
<p>实现波浪wave效果，以及水位位置调整。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="外部形状"><a href="#外部形状" class="headerlink" title="外部形状"></a>外部形状</h3><p>外部形状可以是圆形，三角形，整个图形的绘制区域由canvas决定</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void initBoarderPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBoarderPain = new Paint();</span><br><span class="line">    mBoarderPain.setAntiAlias(true);</span><br><span class="line">    mBoarderPain.setStyle(Paint.Style.STROKE);//描边</span><br><span class="line">    mBoarderPain.setStrokeWidth(DEFAULT_BOARD_WIDTH);</span><br><span class="line">    mBoarderPain.setColor(Color.RED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void initBgPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBgPaint = new Paint();</span><br><span class="line">    mBgPaint.setAntiAlias(true);</span><br><span class="line">    mBgPaint.setColor(getResources().getColor(R.color.voicebg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>怎么画波浪呢？</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void initWavePaint() &#123;</span><br><span class="line">       mWavePain = new Paint();</span><br><span class="line">       mWavePain.setAntiAlias(true);</span><br><span class="line">       mWavePain.setColor(getResources().getColor(R.color.voicefr));</span><br><span class="line">       updateWaveShader();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中updateWaveShader，使用的着色器是BitmapShader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void updateWaveShader() &#123;</span><br><span class="line">       if (getWaveBitmap() != null) &#123;</span><br><span class="line">           mWaveShader = new BitmapShader(getWaveBitmap(), Shader.TileMode.REPEAT, Shader.TileMode.CLAMP);//x坐标repeat模式，y方向上最后一个像素重复</span><br><span class="line">           mWavePain.setShader(mWaveShader);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePain.setShader(null);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>而getWaveBitmap()的任务是获得一个画有两个波浪的图形</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private Bitmap getWaveBitmap() &#123;//返回一个波形的图案，两条线</span><br><span class="line"></span><br><span class="line">    int wavecount = 1;//容纳多少个完整波形</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    int width = getMeasuredWidth();</span><br><span class="line">    int height = getMeasuredHeight();</span><br><span class="line">    Log.i(&quot;linlian&quot;, &quot;width=&quot; + width + &quot; height=&quot; + height);</span><br><span class="line">    if (width &gt; 0 &amp;&amp; height &gt; 0) &#123;</span><br><span class="line"></span><br><span class="line">        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">        Canvas waveLineCanvas = new Canvas(bitmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //坐标点数组，x从0-width，y=Asin(Wx+Q)+H</span><br><span class="line">        // W = 2*PI/width</span><br><span class="line">        // A = height</span><br><span class="line">        // h = height</span><br><span class="line">        // Q = 0</span><br><span class="line">        final int endX = width + 1;</span><br><span class="line">        final int endY = height + 1;</span><br><span class="line">        float W = (float) (2f * Math.PI * wavecount / width);</span><br><span class="line">        float A = height / 10f;//波浪幅度在整体的10分之一</span><br><span class="line">        float H = height / 2;//默认水位在一半的位置</span><br><span class="line">        float[] waveY = new float[endX];</span><br><span class="line"></span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveY[x] = (float) (A * Math.sin(W * x)) + H;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int xShift = width / 4;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavebg));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[(x + xShift) % endX], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavefr));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line"></span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[x], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置好图形着色器之后，在view的onDraw方法上，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePain);//画波浪图形</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何实现动画效果呢"><a href="#如何实现动画效果呢" class="headerlink" title="如何实现动画效果呢"></a>如何实现动画效果呢</h3><p>通过属性动画来实现，改变waveXshift的值，从0到1变化，两秒，重复变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void initAnimation() &#123;</span><br><span class="line">       mShaderMatrix = new Matrix();</span><br><span class="line">       ObjectAnimator waveXshiftAnimator = ObjectAnimator.ofFloat(this, &quot;waveXshift&quot;, 0f, 1f); </span><br><span class="line">       waveXshiftAnimator.setRepeatCount(ValueAnimator.INFINITE);</span><br><span class="line">       waveXshiftAnimator.setDuration(2000);</span><br><span class="line">       waveXshiftAnimator.setInterpolator(new LinearInterpolator());</span><br><span class="line">       mAnimatorset = new AnimatorSet();</span><br><span class="line">       mAnimatorset.play(waveXshiftAnimator);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>属性变化的时候，重新绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void setWaveXshift(float mWaveXshift) &#123;</span><br><span class="line">    if (this.mWaveXshift != mWaveXshift) &#123;</span><br><span class="line">        this.mWaveXshift = mWaveXshift;</span><br><span class="line">        //变化的是重新绘制view，实现动画效果</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中，实现图像的水平移动 mWaveXshift * getWidth();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (mWaveShader != null) &#123;</span><br><span class="line">           if (mWavePaint.getShader() == null) &#123;</span><br><span class="line">               mWavePaint.setShader(mWaveShader);</span><br><span class="line">           &#125;</span><br><span class="line">           float dx = mWaveXshift * getWidth();</span><br><span class="line">           mShaderMatrix.setTranslate(dx, 0);//平移波浪，实现推进效果</span><br><span class="line">           mWaveShader.setLocalMatrix(mShaderMatrix);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePaint.setShader(null);</span><br><span class="line">       &#125;</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePaint);//画波浪</span><br></pre></td></tr></table></figure>

<p>重新实现的代码可以参考</p>
<p><a href="https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java" target="_blank" rel="noopener">https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/12/animation summary/">动画收集summary</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-12
        </span><span class="post-category">
            <a href="/categories/BLOG/">BLOG</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="动画收集"><a href="#动画收集" class="headerlink" title="动画收集"></a>动画收集</h1><p>最近挖了一个坑，关于动画效果的收集和分析，慢慢补缺补漏吧</p>
<p><a href="https://github.com/lynn8570/AnimationCollect" target="_blank" rel="noopener">https://github.com/lynn8570/AnimationCollect</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/12/hexo note/">Hexo 小记</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-12
        </span><span class="post-category">
            <a href="/categories/BLOG/">BLOG</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="搬迁到hexo啦"><a href="#搬迁到hexo啦" class="headerlink" title="搬迁到hexo啦"></a>搬迁到hexo啦</h1><p>把以前的blog从HUGO迁移成hexo啦</p>
<p>hexo文档</p>
<p><a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">https://hexo.io/zh-cn/docs/index.html</a></p>
<p>用了even 主题</p>
<p><a href="https://github.com/ahonn/hexo-theme-even" target="_blank" rel="noopener">https://github.com/ahonn/hexo-theme-even</a></p>
<h2 id="如何添加新文章"><a href="#如何添加新文章" class="headerlink" title="如何添加新文章"></a>如何添加新文章</h2><ul>
<li><code>hexo\source\_posts</code> 下添加新文章，新的md文件</li>
<li><code>hexo server</code> 本地查看效果</li>
<li><code>hexo g</code>生成静态文件</li>
<li><code>hexo d</code> 部署到GitHub上</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/26/Android locale change procedure/">安卓语言切换流程</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-26
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h1><ol>
<li><p>在settings应用中，通过LocaleDragAndDropAdapter来实现语言列表拖拽切换语言的，在拖拽结束后会调用updateLocalesWhenAnimationStops表示当动画结束后，进行locale的更新操作</p>
<p>​</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">    public void updateLocalesWhenAnimationStops(final LocaleList localeList) &#123;</span><br><span class="line">    //在动画借宿后，更新locale设置</span><br><span class="line">    if (localeList.equals(mLocalesToSetNext)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This will only update the Settings application to make things feel more responsive,</span><br><span class="line">    // the system will be updated later, when animation stopped.</span><br><span class="line">    LocaleList.setDefault(localeList);</span><br><span class="line"></span><br><span class="line">    mLocalesToSetNext = localeList;</span><br><span class="line">    final RecyclerView.ItemAnimator itemAnimator = mParentView.getItemAnimator();</span><br><span class="line">    itemAnimator.isRunning(new RecyclerView.ItemAnimator.ItemAnimatorFinishedListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onAnimationsFinished() &#123;</span><br><span class="line">          </span><br><span class="line">            if (mLocalesToSetNext == null || mLocalesToSetNext.equals(mLocalesSetLast)) &#123;</span><br><span class="line">                // All animations finished, but the locale list did not change</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LocalePicker.updateLocales(mLocalesToSetNext); //当动画结束的时候，调用真正的更新</span><br><span class="line">            mLocalesSetLast = mLocalesToSetNext;</span><br><span class="line">            new CreateShortcut.ShortcutsUpdateTask(mContext).execute();</span><br><span class="line"></span><br><span class="line">            mLocalesToSetNext = null;</span><br><span class="line"></span><br><span class="line">            mNumberFormatter = NumberFormat.getNumberInstance(Locale.getDefault());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>LocalePicker.updateLocales(mLocalesToSetNext);当动画结束时，调用系统方法，更新locale，LocalePicker的位置：</li>
</ol>
<p><code>android\frameworks\base\core\java\com\android\internal\app\LocalePicker.java</code></p>
<p>请求系统来更新系统的语言设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Requests the system to update the system locale. Note that the system looks halted</span><br><span class="line"> * for a while during the Locale migration, so the caller need to take care of it.</span><br><span class="line"> *</span><br><span class="line"> * @see #updateLocales(LocaleList)</span><br><span class="line"> */</span><br><span class="line">public static void updateLocale(Locale locale) &#123;</span><br><span class="line">    updateLocales(new LocaleList(locale));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void updateLocales(LocaleList locales) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        final IActivityManager am = ActivityManager.getService();</span><br><span class="line">        final Configuration config = am.getConfiguration();</span><br><span class="line"></span><br><span class="line">        config.setLocales(locales);</span><br><span class="line">        config.userSetLocale = true;</span><br><span class="line">        //1.am</span><br><span class="line">        am.updatePersistentConfiguration(config);</span><br><span class="line">        // Trigger the dirty bit for the Settings Provider.</span><br><span class="line">        //2.backupmanager</span><br><span class="line">        BackupManager.dataChanged(&quot;com.android.providers.settings&quot;);</span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        // Intentionally left blank</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过<code>am.updatePersistentConfiguration(config);</code>来进行配置更新和持久化，am的真正实现为 ActivityManagerService.java，先确认权限，</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void updatePersistentConfiguration(Configuration values) &#123;</span><br><span class="line">    enforceCallingPermission(CHANGE_CONFIGURATION, &quot;updatePersistentConfiguration()&quot;);</span><br><span class="line">    enforceWriteSettingsPermission(&quot;updatePersistentConfiguration()&quot;);</span><br><span class="line">    if (values == null) &#123;</span><br><span class="line">        throw new NullPointerException(&quot;Configuration must not be null&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    int userId = UserHandle.getCallingUserId();</span><br><span class="line"></span><br><span class="line">    synchronized(this) &#123;</span><br><span class="line">        updatePersistentConfigurationLocked(values, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void updatePersistentConfigurationLocked(Configuration values, @UserIdInt int userId) &#123;</span><br><span class="line">    final long origId = Binder.clearCallingIdentity();</span><br><span class="line">    try &#123;</span><br><span class="line">        updateConfigurationLocked(values, null, false, true, userId, false /* deferResume */);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>详细分析updateConfigurationLocked：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> /**</span><br><span class="line"> * Do either or both things: (1) change the current configuration, and (2)</span><br><span class="line"> * make sure the given activity is running with the (now) current</span><br><span class="line"> * configuration.  Returns true if the activity has been left running, or</span><br><span class="line"> * false if &lt;var&gt;starting&lt;/var&gt; is being destroyed to match the new</span><br><span class="line"> * configuration.</span><br><span class="line"> *</span><br><span class="line"> * @param userId is only used when persistent parameter is set to true to persist configuration</span><br><span class="line"> *               for that particular user</span><br><span class="line"> */</span><br><span class="line">private boolean updateConfigurationLocked(Configuration values, ActivityRecord starting,</span><br><span class="line">        boolean initLocale, boolean persistent, int userId, boolean deferResume,</span><br><span class="line">        UpdateConfigurationResult result) &#123;</span><br><span class="line">    int changes = 0;</span><br><span class="line">    boolean kept = true;</span><br><span class="line"></span><br><span class="line">    if (mWindowManager != null) &#123;</span><br><span class="line">        mWindowManager.deferSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        if (values != null) &#123;</span><br><span class="line">            //1.1更新全局的配置信息</span><br><span class="line">            changes = updateGlobalConfiguration(values, initLocale, persistent, userId,</span><br><span class="line">                    deferResume);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        kept = ensureConfigAndVisibilityAfterUpdate(starting, changes);</span><br><span class="line">        //1.2当前的activity是否被开始destroy，以便重新创建</span><br><span class="line">       </span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (mWindowManager != null) &#123;</span><br><span class="line">            mWindowManager.continueSurfaceLayout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (result != null) &#123;</span><br><span class="line">        result.changes = changes;</span><br><span class="line">        result.activityRelaunched = !kept;</span><br><span class="line">    &#125;</span><br><span class="line">    return kept;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>updateGlobalConfiguration：更新默认的global配置，并通知各个监听器，比较长的代码，注释解读：该方法主要做了以下事情</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private int updateGlobalConfiguration(@NonNull Configuration values, boolean initLocale,</span><br><span class="line">        boolean persistent, int userId, boolean deferResume) &#123;</span><br><span class="line">    mTempConfig.setTo(getGlobalConfiguration());</span><br><span class="line">    final int changes = mTempConfig.updateFrom(values);</span><br><span class="line">    </span><br><span class="line">    if (changes == 0) &#123;</span><br><span class="line">        //如果没有变化，则return，return之前，由于 Activity.setRequestedOrientation 导致WindowManagerService.mWaitingForConfig被设置为true，从而使窗口被锁住，所以如果没有变化的话，performDisplayOverrideConfigUpdate来解冻窗口</span><br><span class="line">        performDisplayOverrideConfigUpdate(values, deferResume, DEFAULT_DISPLAY);</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    .............</span><br><span class="line">    EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</span><br><span class="line"></span><br><span class="line">    if (!initLocale &amp;&amp; !values.getLocales().isEmpty() &amp;&amp; values.userSetLocale) &#123;</span><br><span class="line">        final LocaleList locales = values.getLocales();</span><br><span class="line">        int bestLocaleIndex = 0;</span><br><span class="line">        if (locales.size() &gt; 1) &#123;</span><br><span class="line">            if (mSupportedSystemLocales == null) &#123;</span><br><span class="line">                mSupportedSystemLocales = Resources.getSystem().getAssets().getLocales();</span><br><span class="line">            &#125;</span><br><span class="line">            bestLocaleIndex = Math.max(0, locales.getFirstMatchIndex(mSupportedSystemLocales));</span><br><span class="line">        &#125;</span><br><span class="line">        SystemProperties.set(&quot;persist.sys.locale&quot;,</span><br><span class="line">                locales.get(bestLocaleIndex).toLanguageTag());//设置保存</span><br><span class="line">        LocaleList.setDefault(locales, bestLocaleIndex);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        mHandler.sendMessage(mHandler.obtainMessage(SEND_LOCALE_TO_MOUNT_DAEMON_MSG,</span><br><span class="line">                locales.get(bestLocaleIndex)));//1.1.1 发送SEND_LOCALE_TO_MOUNT_DAEMON_MSG消息，主要用于通知storageManager.setField(StorageManager.SYSTEM_LOCALE_KEY, l.toLanguageTag());存储管理，将系统语言更新</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mConfigurationSeq = Math.max(++mConfigurationSeq, 1);</span><br><span class="line">    mTempConfig.seq = mConfigurationSeq;</span><br><span class="line"></span><br><span class="line">    //1.1.2 调用mStackSupervisor的回掉Update stored global config and notify everyone about the change.</span><br><span class="line">    mStackSupervisor.onConfigurationChanged(mTempConfig);</span><br><span class="line">   </span><br><span class="line">    Slog.i(TAG, &quot;Config changes=&quot; + Integer.toHexString(changes) + &quot; &quot; + mTempConfig);</span><br><span class="line">    //1.1.3 TODO(multi-display): Update UsageEvents#Event to include displayId.主要是event</span><br><span class="line">    mUsageStatsService.reportConfigurationChange(mTempConfig,</span><br><span class="line">            mUserController.getCurrentUserIdLocked());</span><br><span class="line"></span><br><span class="line">    // TODO: If our config changes, should we auto dismiss any currently showing dialogs?</span><br><span class="line">    mShowDialogs = shouldShowDialogs(mTempConfig);</span><br><span class="line"></span><br><span class="line">    AttributeCache ac = AttributeCache.instance();</span><br><span class="line">    if (ac != null) &#123;</span><br><span class="line">        ac.updateConfiguration(mTempConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Make sure all resources in our process are updated right now, so that anyone who is going</span><br><span class="line">    // to retrieve resource values after we return will be sure to get the new ones. This is</span><br><span class="line">    // especially important during boot, where the first config change needs to guarantee all</span><br><span class="line">    //1.1.4 resources have that config before following boot code is executed.重要流程</span><br><span class="line">    mSystemThread.applyConfigurationToResources(mTempConfig);</span><br><span class="line"></span><br><span class="line">    //1.1.5 We need another copy of global config because we&apos;re scheduling some calls instead of</span><br><span class="line">    // running them in place. We need to be sure that object we send will be handled unchanged.</span><br><span class="line">    final Configuration configCopy = new Configuration(mTempConfig);</span><br><span class="line">    if (persistent &amp;&amp; Settings.System.hasInterestingConfigurationChanges(changes)) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</span><br><span class="line">        msg.obj = configCopy;</span><br><span class="line">        msg.arg1 = userId;</span><br><span class="line">        mHandler.sendMessage(msg);</span><br><span class="line">        //主要更新ContentResolver</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for (int i = mLruProcesses.size() - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">        ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">        try &#123;</span><br><span class="line">            if (app.thread != null) &#123;</span><br><span class="line">                if (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, &quot;Sending to proc &quot;</span><br><span class="line">                        + app.processName + &quot; new config &quot; + configCopy);</span><br><span class="line">                app.thread.scheduleConfigurationChanged(configCopy);</span><br><span class="line">                //重要流程，遍历</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //ACTION_CONFIGURATION_CHANGED intent</span><br><span class="line">    Intent intent = new Intent(Intent.ACTION_CONFIGURATION_CHANGED);</span><br><span class="line">    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">            | Intent.FLAG_RECEIVER_FOREGROUND</span><br><span class="line">            | Intent.FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS);</span><br><span class="line">    broadcastIntentLocked(null, null, intent, null, null, 0, null, null, null,</span><br><span class="line">            AppOpsManager.OP_NONE, null, false, false, MY_PID, SYSTEM_UID,</span><br><span class="line">            UserHandle.USER_ALL);</span><br><span class="line">    if ((changes &amp; ActivityInfo.CONFIG_LOCALE) != 0) &#123;</span><br><span class="line">         // ACTION_LOCALE_CHANGED intent</span><br><span class="line">        intent = new Intent(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND</span><br><span class="line">                | Intent.FLAG_RECEIVER_INCLUDE_BACKGROUND</span><br><span class="line">                | Intent.FLAG_RECEIVER_VISIBLE_TO_INSTANT_APPS);</span><br><span class="line">        if (initLocale || !mProcessesReady) &#123;</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">        &#125;</span><br><span class="line">        broadcastIntentLocked(null, null, intent, null, null, 0, null, null, null,</span><br><span class="line">                AppOpsManager.OP_NONE, null, false, false, MY_PID, SYSTEM_UID,</span><br><span class="line">                UserHandle.USER_ALL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Override configuration of the default display duplicates global config, so we need to</span><br><span class="line">    // update it also. This will also notify WindowManager about changes.</span><br><span class="line">    performDisplayOverrideConfigUpdate(mStackSupervisor.getConfiguration(), deferResume,</span><br><span class="line">            DEFAULT_DISPLAY);</span><br><span class="line"></span><br><span class="line">    return changes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上方法主要做了以下几件事情：</p>
<ul>
<li><p>设置persist.sys.locale，持久化保存</p>
</li>
<li><p>发送SEND_LOCALE_TO_MOUNT_DAEMON_MSG消息通知，storageManager</p>
</li>
<li><p>调用mStackSupervisor的回调mStackSupervisor.onConfigurationChanged(mTempConfig);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Notify that parent config changed and we need to update full configuration.</span><br><span class="line"> * @see #mFullConfiguration</span><br><span class="line"> */</span><br><span class="line">void onConfigurationChanged(Configuration newParentConfig) &#123;</span><br><span class="line">    mFullConfiguration.setTo(newParentConfig);</span><br><span class="line">    mFullConfiguration.updateFrom(mOverrideConfiguration);</span><br><span class="line">    for (int i = getChildCount() - 1; i &gt;= 0; --i) &#123;</span><br><span class="line">        final ConfigurationContainer child = getChildAt(i);</span><br><span class="line">        child.onConfigurationChanged(mFullConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mUsageStatsService.reportConfigurationChange(mTempConfig,mUserController.getCurrentUserIdLocked()); 报告UsageEvents</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void reportConfigurationChange(Configuration config, int userId) &#123;</span><br><span class="line">    if (config == null) &#123;</span><br><span class="line">        Slog.w(TAG, &quot;Configuration event reported with a null config&quot;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = new UsageEvents.Event();</span><br><span class="line">    event.mPackage = &quot;android&quot;;</span><br><span class="line"></span><br><span class="line">    // This will later be converted to system time.</span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = UsageEvents.Event.CONFIGURATION_CHANGE;</span><br><span class="line">    event.mConfiguration = new Configuration(config);</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, 0, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mSystemThread.applyConfigurationToResources(mTempConfig); </p>
<p>ActivityThread.Java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public final void applyConfigurationToResources(Configuration config) &#123;</span><br><span class="line">       synchronized (mResourcesManager) &#123;</span><br><span class="line">           mResourcesManager.applyConfigurationToResourcesLocked(config, null);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>ResourcesManager.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">public final boolean applyConfigurationToResourcesLocked(@NonNull Configuration config,</span><br><span class="line">                                                           @Nullable CompatibilityInfo compat) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">          Trace.traceBegin(Trace.TRACE_TAG_RESOURCES,</span><br><span class="line">                  &quot;ResourcesManager#applyConfigurationToResourcesLocked&quot;);</span><br><span class="line"></span><br><span class="line">          if (!mResConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">              if (DEBUG || DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Skipping new config: curSeq=&quot;</span><br><span class="line">                      + mResConfiguration.seq + &quot;, newSeq=&quot; + config.seq);</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          int changes = mResConfiguration.updateFrom(config);</span><br><span class="line">          // Things might have changed in display manager, so clear the cached displays.</span><br><span class="line">          mAdjustedDisplays.clear();</span><br><span class="line"></span><br><span class="line">          DisplayMetrics defaultDisplayMetrics = getDisplayMetrics();</span><br><span class="line"></span><br><span class="line">          if (compat != null &amp;&amp; (mResCompatibilityInfo == null ||</span><br><span class="line">                  !mResCompatibilityInfo.equals(compat))) &#123;</span><br><span class="line">              mResCompatibilityInfo = compat;</span><br><span class="line">              changes |= ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                      | ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                      | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          Resources.updateSystemConfiguration(config, defaultDisplayMetrics, compat);</span><br><span class="line"></span><br><span class="line">          ApplicationPackageManager.configurationChanged();</span><br><span class="line">          //Slog.i(TAG, &quot;Configuration changed in &quot; + currentPackageName());</span><br><span class="line"></span><br><span class="line">          Configuration tmpConfig = null;</span><br><span class="line"></span><br><span class="line">          for (int i = mResourceImpls.size() - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">              ResourcesKey key = mResourceImpls.keyAt(i);</span><br><span class="line">              WeakReference&lt;ResourcesImpl&gt; weakImplRef = mResourceImpls.valueAt(i);</span><br><span class="line">              ResourcesImpl r = weakImplRef != null ? weakImplRef.get() : null;</span><br><span class="line">              if (r != null) &#123;</span><br><span class="line">                  if (DEBUG || DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Changing resources &quot;</span><br><span class="line">                          + r + &quot; config to: &quot; + config);</span><br><span class="line">                  int displayId = key.mDisplayId;</span><br><span class="line">                  boolean isDefaultDisplay = (displayId == Display.DEFAULT_DISPLAY);</span><br><span class="line">                  DisplayMetrics dm = defaultDisplayMetrics;</span><br><span class="line">                  final boolean hasOverrideConfiguration = key.hasOverrideConfiguration();</span><br><span class="line">                  if (!isDefaultDisplay || hasOverrideConfiguration) &#123;</span><br><span class="line">                      if (tmpConfig == null) &#123;</span><br><span class="line">                          tmpConfig = new Configuration();</span><br><span class="line">                      &#125;</span><br><span class="line">                      tmpConfig.setTo(config);</span><br><span class="line"></span><br><span class="line">                      // Get new DisplayMetrics based on the DisplayAdjustments given</span><br><span class="line">                      // to the ResourcesImpl. Update a copy if the CompatibilityInfo</span><br><span class="line">                      // changed, because the ResourcesImpl object will handle the</span><br><span class="line">                      // update internally.</span><br><span class="line">                      DisplayAdjustments daj = r.getDisplayAdjustments();</span><br><span class="line">                      if (compat != null) &#123;</span><br><span class="line">                          daj = new DisplayAdjustments(daj);</span><br><span class="line">                          daj.setCompatibilityInfo(compat);</span><br><span class="line">                      &#125;</span><br><span class="line">                      dm = getDisplayMetrics(displayId, daj);</span><br><span class="line"></span><br><span class="line">                      if (!isDefaultDisplay) &#123;</span><br><span class="line">                          applyNonDefaultDisplayMetricsToConfiguration(dm, tmpConfig);</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      if (hasOverrideConfiguration) &#123;</span><br><span class="line">                          tmpConfig.updateFrom(key.mOverrideConfiguration);</span><br><span class="line">                      &#125;</span><br><span class="line">                      r.updateConfiguration(tmpConfig, dm, compat);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      r.updateConfiguration(config, dm, compat);</span><br><span class="line">                  &#125;</span><br><span class="line">                  //Slog.i(TAG, &quot;Updated app resources &quot; + v.getKey()</span><br><span class="line">                  //        + &quot; &quot; + r + &quot;: &quot; + r.getConfiguration());</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  //Slog.i(TAG, &quot;Removing old resources &quot; + v.getKey());</span><br><span class="line">                  mResourceImpls.removeAt(i);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          return changes != 0;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">          Trace.traceEnd(Trace.TRACE_TAG_RESOURCES);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>Resources.updateSystemConfiguration(config, defaultDisplayMetrics, compat); 更新资源配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">if ((configChanges &amp; ActivityInfo.CONFIG_LOCALE) != 0) &#123;</span><br><span class="line">                    if (locales.size() &gt; 1) &#123;</span><br><span class="line">                        // The LocaleList has changed. We must query the AssetManager&apos;s available</span><br><span class="line">                        // Locales and figure out the best matching Locale in the new LocaleList.</span><br><span class="line">                        String[] availableLocales = mAssets.getNonSystemLocales();</span><br><span class="line">                        if (LocaleList.isPseudoLocalesOnly(availableLocales)) &#123;</span><br><span class="line">                            // No app defined locales, so grab the system locales.</span><br><span class="line">                            availableLocales = mAssets.getLocales();</span><br><span class="line">                            if (LocaleList.isPseudoLocalesOnly(availableLocales)) &#123;</span><br><span class="line">                                availableLocales = null;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        if (availableLocales != null) &#123;</span><br><span class="line">                            final Locale bestLocale = locales.getFirstMatchWithEnglishSupported(</span><br><span class="line">                                    availableLocales);</span><br><span class="line">                            if (bestLocale != null &amp;&amp; bestLocale != locales.get(0)) &#123;</span><br><span class="line">                                mConfiguration.setLocales(new LocaleList(bestLocale, locales));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>ApplicationPackageManager.configurationChanged();清空缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">static void configurationChanged() &#123;</span><br><span class="line">        synchronized (sSync) &#123;</span><br><span class="line">            sIconCache.clear();</span><br><span class="line">            sStringCache.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app.thread.scheduleConfigurationChanged(configCopy);遍历每个activityThread，应用新的配置</p>
<p>ActivityThread.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleConfigurationChanged(Configuration config) &#123;</span><br><span class="line">    updatePendingConfiguration(config);</span><br><span class="line">    sendMessage(H.CONFIGURATION_CHANGED, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CONFIGURATION_CHANGED:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">case CONFIGURATION_CHANGED:</span><br><span class="line">           Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;configChanged&quot;);</span><br><span class="line">           mCurDefaultDisplayDpi = ((Configuration)msg.obj).densityDpi;</span><br><span class="line">           mUpdatingSystemConfig = true;</span><br><span class="line">           try &#123;</span><br><span class="line">               handleConfigurationChanged((Configuration) msg.obj, null);</span><br><span class="line">           &#125; finally &#123;</span><br><span class="line">               mUpdatingSystemConfig = false;</span><br><span class="line">           &#125;</span><br><span class="line">           Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">           break;</span><br></pre></td></tr></table></figure>

<p>ActivityThread.handleConfigurationChanged</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">final void handleConfigurationChanged(Configuration config, CompatibilityInfo compat) &#123;</span><br><span class="line"></span><br><span class="line">        int configDiff = 0;</span><br><span class="line"></span><br><span class="line">        // This flag tracks whether the new configuration is fundamentally equivalent to the</span><br><span class="line">        // existing configuration. This is necessary to determine whether non-activity</span><br><span class="line">        // callbacks should receive notice when the only changes are related to non-public fields.</span><br><span class="line">        // We do not gate calling &#123;@link #performActivityConfigurationChanged&#125; based on this flag</span><br><span class="line">        // as that method uses the same check on the activity config override as well.</span><br><span class="line">        final boolean equivalent = config != null &amp;&amp; mConfiguration != null</span><br><span class="line">                &amp;&amp; (0 == mConfiguration.diffPublicOnly(config));</span><br><span class="line"></span><br><span class="line">        synchronized (mResourcesManager) &#123;</span><br><span class="line">            if (mPendingConfiguration != null) &#123;</span><br><span class="line">                if (!mPendingConfiguration.isOtherSeqNewer(config)) &#123;</span><br><span class="line">                    config = mPendingConfiguration;</span><br><span class="line">                    mCurDefaultDisplayDpi = config.densityDpi;</span><br><span class="line">                    updateDefaultDensity();</span><br><span class="line">                &#125;</span><br><span class="line">                mPendingConfiguration = null;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (config == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Handle configuration changed: &quot;</span><br><span class="line">                    + config);</span><br><span class="line"></span><br><span class="line">            mResourcesManager.applyConfigurationToResourcesLocked(config, compat);</span><br><span class="line">            updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                    mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">            if (mConfiguration == null) &#123;</span><br><span class="line">                mConfiguration = new Configuration();</span><br><span class="line">            &#125;</span><br><span class="line">            if (!mConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            configDiff = mConfiguration.updateFrom(config);</span><br><span class="line">            config = applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line"></span><br><span class="line">            final Theme systemTheme = getSystemContext().getTheme();</span><br><span class="line">            if ((systemTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">                systemTheme.rebase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            final Theme systemUiTheme = getSystemUiContext().getTheme();</span><br><span class="line">            if ((systemUiTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">                systemUiTheme.rebase();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(false, config);</span><br><span class="line"></span><br><span class="line">        freeTextLayoutCachesIfNeeded(configDiff);</span><br><span class="line"></span><br><span class="line">        if (callbacks != null) &#123;</span><br><span class="line">            final int N = callbacks.size();</span><br><span class="line">            for (int i=0; i&lt;N; i++) &#123;</span><br><span class="line">                ComponentCallbacks2 cb = callbacks.get(i);</span><br><span class="line">                if (cb instanceof Activity) &#123;</span><br><span class="line">                    // If callback is an Activity - call corresponding method to consider override</span><br><span class="line">                    // config and avoid onConfigurationChanged if it hasn&apos;t changed.</span><br><span class="line">                    Activity a = (Activity) cb;</span><br><span class="line">                    performConfigurationChangedForActivity(mActivities.get(a.getActivityToken()),</span><br><span class="line">                            config);</span><br><span class="line">                &#125; else if (!equivalent) &#123;</span><br><span class="line">                    performConfigurationChanged(cb, config);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>

<p> app.thread.scheduleConfigurationChanged(configCopy);</p>
<p>回到</p>
<p>ActivityThread.java</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void scheduleConfigurationChanged(Configuration config) &#123;</span><br><span class="line">    updatePendingConfiguration(config);</span><br><span class="line">    sendMessage(H.CONFIGURATION_CHANGED, config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CONFIGURATION_CHANGED:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">case CONFIGURATION_CHANGED:</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;configChanged&quot;);</span><br><span class="line">    mCurDefaultDisplayDpi = ((Configuration)msg.obj).densityDpi;</span><br><span class="line">    mUpdatingSystemConfig = true;</span><br><span class="line">    try &#123;</span><br><span class="line">        handleConfigurationChanged((Configuration) msg.obj, null);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        mUpdatingSystemConfig = false;</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    break;</span><br></pre></td></tr></table></figure>

<p>ActivityThread.handleConfigurationChanged</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">final void handleConfigurationChanged(Configuration config, CompatibilityInfo compat) &#123;</span><br><span class="line"></span><br><span class="line">       int configDiff = 0;</span><br><span class="line"></span><br><span class="line">       // This flag tracks whether the new configuration is fundamentally equivalent to the</span><br><span class="line">       // existing configuration. This is necessary to determine whether non-activity</span><br><span class="line">       // callbacks should receive notice when the only changes are related to non-public fields.</span><br><span class="line">       // We do not gate calling &#123;@link #performActivityConfigurationChanged&#125; based on this flag</span><br><span class="line">       // as that method uses the same check on the activity config override as well.</span><br><span class="line">       final boolean equivalent = config != null &amp;&amp; mConfiguration != null</span><br><span class="line">               &amp;&amp; (0 == mConfiguration.diffPublicOnly(config));</span><br><span class="line"></span><br><span class="line">       synchronized (mResourcesManager) &#123;</span><br><span class="line">           if (mPendingConfiguration != null) &#123;</span><br><span class="line">               if (!mPendingConfiguration.isOtherSeqNewer(config)) &#123;</span><br><span class="line">                   config = mPendingConfiguration;</span><br><span class="line">                   mCurDefaultDisplayDpi = config.densityDpi;</span><br><span class="line">                   updateDefaultDensity();</span><br><span class="line">               &#125;</span><br><span class="line">               mPendingConfiguration = null;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (config == null) &#123;</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Handle configuration changed: &quot;</span><br><span class="line">                   + config);</span><br><span class="line"></span><br><span class="line">           mResourcesManager.applyConfigurationToResourcesLocked(config, compat);</span><br><span class="line">           updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),</span><br><span class="line">                   mResourcesManager.getConfiguration().getLocales());</span><br><span class="line"></span><br><span class="line">           if (mConfiguration == null) &#123;</span><br><span class="line">               mConfiguration = new Configuration();</span><br><span class="line">           &#125;</span><br><span class="line">           if (!mConfiguration.isOtherSeqNewer(config) &amp;&amp; compat == null) &#123;</span><br><span class="line">               return;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           configDiff = mConfiguration.updateFrom(config);</span><br><span class="line">           config = applyCompatConfiguration(mCurDefaultDisplayDpi);</span><br><span class="line"></span><br><span class="line">           final Theme systemTheme = getSystemContext().getTheme();</span><br><span class="line">           if ((systemTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">               systemTheme.rebase();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           final Theme systemUiTheme = getSystemUiContext().getTheme();</span><br><span class="line">           if ((systemUiTheme.getChangingConfigurations() &amp; configDiff) != 0) &#123;</span><br><span class="line">               systemUiTheme.rebase();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(false, config);</span><br><span class="line"></span><br><span class="line">       freeTextLayoutCachesIfNeeded(configDiff);</span><br><span class="line"></span><br><span class="line">       if (callbacks != null) &#123;</span><br><span class="line">           final int N = callbacks.size();</span><br><span class="line">           for (int i=0; i&lt;N; i++) &#123;</span><br><span class="line">               ComponentCallbacks2 cb = callbacks.get(i);</span><br><span class="line">               if (cb instanceof Activity) &#123;</span><br><span class="line">                   // If callback is an Activity - call corresponding method to consider override</span><br><span class="line">                   // config and avoid onConfigurationChanged if it hasn&apos;t changed.</span><br><span class="line">                   Activity a = (Activity) cb;</span><br><span class="line">                   performConfigurationChangedForActivity(mActivities.get(a.getActivityToken()),</span><br><span class="line">                           config);</span><br><span class="line">               &#125; else if (!equivalent) &#123;</span><br><span class="line">                   performConfigurationChanged(cb, config);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中调用log打印</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">01-09 03:12:27.360: I/linlian(5221): LocaleDragAndDropAdapter.updateLocalesWhenAnimationStops()</span><br><span class="line">01-09 03:12:27.420: I/linlian(5221): LocaleDragAndDropAdapter.onAnimationsFinished()</span><br><span class="line">01-09 03:12:27.420: I/linlian(5221): LocaleDragAndDropAdapter.onAnimationsFinished()mLocalesToSetNext=[en_US,zh_CN_#Hans]</span><br><span class="line">动画结束，准备更新locale</span><br><span class="line">01-09 03:12:27.421: I/linlian(5221): LocalePicker.updateLocale()config=&#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.7&#125;</span><br><span class="line">01-09 03:12:27.422: I/linlian(714): ActivityManagerService.updateGlobalConfiguration changes=8196</span><br><span class="line">01-09 03:12:27.422: I/linlian(714): ActivityManagerService.updateGlobalConfiguration values=&#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.7&#125;</span><br><span class="line">01-09 03:12:27.432: I/linlian(714): ActivityManagerService.updateGlobalConfiguration locales=[en_US,zh_CN_#Hans]</span><br><span class="line">更新locale排序为 英语，简体中文</span><br><span class="line">01-09 03:12:27.432: I/linlian(714): ActivityManagerService.updateGlobalConfiguration bestLocaleIndex=0</span><br><span class="line">01-09 03:12:27.433: I/linlian(714): ActivityManagerService.updateGlobalConfiguration locales=Config changes=2004 &#123;1.0 ?mcc?mnc [en_US,zh_CN_#Hans] ldltr sw320dp w320dp h509dp 240dpi nrml long port finger -keyb/v/h -nav/h appBounds=Rect(0, 0 - 480, 800) s.8&#125;</span><br><span class="line">遍历当前的ProcessRecord，开机的有 设置，短信，launcher，acore,latin输入法</span><br><span class="line">01-09 03:12:27.457: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;9538ed4 5221:com.android.settings/1000&#125;</span><br><span class="line">01-09 03:12:27.457: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;a10987d 2720:com.android.mms/u0a17&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;5353372 2324:com.android.launcher3/u0a16&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;97fd3c3 5277:android.process.acore/u0a2&#125;</span><br><span class="line">01-09 03:12:27.458: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;e22e5a6 1686:com.android.inputmethod.latin/u0a50&#125;</span><br><span class="line">.........编译APP，会被多次调用 handleConfigurationChanged 会被多次调用</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): ActivityThread.handleConfigurationChanged()</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): java.lang.RuntimeException</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread.handleConfigurationChanged(ActivityThread.java:4972)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1705)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.os.Looper.loop(Looper.java:164)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at android.app.ActivityThread.main(ActivityThread.java:6503)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:438)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2720): 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:807)</span><br><span class="line">01-09 03:12:27.459: I/linlian(2324): ActivityThread.handleConfigurationChanged()</span><br><span class="line">log穿插着ProcessRecord</span><br><span class="line">01-09 03:12:27.471: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;351e46c 2749:com.android.onetimeinitializer/u0a19&#125;</span><br><span class="line">01-09 03:12:27.471: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;4ff5a35 2396:com.android.managedprovisioning/u0a15&#125;</span><br><span class="line">01-09 03:12:27.472: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;833beca 2520:com.android.exchange/u0a48&#125;</span><br><span class="line">01-09 03:12:27.472: I/linlian(714): ActivityManagerService.ProcessRecord app=ProcessRecord&#123;c65f83b 2702:com.android.gallery3d/u0a49&#125;</span><br><span class="line"></span><br><span class="line">当前的应用</span><br><span class="line">01-09 03:12:27.559: I/linlian(5221): ActivityThread.handleConfigurationChanged()Activity a=com.android.settings.SubSettings@e58e930</span><br></pre></td></tr></table></figure>


        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/26/gradle properties/">gradle properties</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-26
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>Android studio gradle更新同步一直报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error:Unable to resolve dependency for &apos;:app@debug/compileClasspath&apos;: Could not https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/3.2.0-alpha07/gradle-3.2.0-alpha07.pom </span><br><span class="line"></span><br><span class="line">Received status code 400 from server: Bad Request</span><br></pre></td></tr></table></figure>

<p>浏览器访问下载没有问题，但是Android studio下载一直失败。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://dl.google.com/dl/android/maven2/com/android/tools/build/gradle/3.2.0-alpha07/gradle-3.2.0-alpha07.pom</span><br></pre></td></tr></table></figure>

<p>查了代理设置</p>
<p>setting-http proxy -设置成 no proxy没有问题</p>
<p>折腾了后来发现，<code>gradle.properties</code>文件被设置了，删除掉代理设置，可gradle sync OK</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/03/15/gitbook/">gitbook知识服务共享平台搭建</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-15
        </span><span class="post-category">
            <a href="/categories/SERVER/">SERVER</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="git-服务器搭建"><a href="#git-服务器搭建" class="headerlink" title="git 服务器搭建"></a>git 服务器搭建</h1><p>主要参考<a href="https://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/00137583770360579bc4b458f044ce7afed3df579123eca000" target="_blank" rel="noopener">廖雪峰搭建git服务器</a>一文主要注意的几个点：</p>
<ol>
<li><p>创建的 home/git/.ssh/ 目录的权限和 home/git/.ssh/authorized_keys 的权限问题</p>
<figure class="highlight plain"><figcaption><span>1 git git 1234 2018-03-10 17:43 authorized_keys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@guoyzh-ubuntu:/home/git/.ssh# ls -all</span><br><span class="line">......</span><br><span class="line">-rw-r--r-- 1 git git 1234 2018-03-10 17:43 authorized_keys</span><br><span class="line"></span><br><span class="line"> drwxr-xr-x  2 git  git  4096 2018-03-10 17:43 .ssh</span><br></pre></td></tr></table></figure>
</li>
<li><p>/etc/ssh/sshd_config 文件可用于配置验证方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"># Package generated configuration file</span><br><span class="line"># See the sshd_config(5) manpage for details</span><br><span class="line"></span><br><span class="line"># What ports, IPs and protocols we listen for</span><br><span class="line">Port 22</span><br><span class="line"># Use these options to restrict which interfaces/protocols sshd will bind to</span><br><span class="line">#ListenAddress ::</span><br><span class="line">#ListenAddress 0.0.0.0</span><br><span class="line">Protocol 2</span><br><span class="line"># HostKeys for protocol version 2</span><br><span class="line">HostKey /etc/ssh/ssh_host_rsa_key</span><br><span class="line">HostKey /etc/ssh/ssh_host_dsa_key</span><br><span class="line">#Privilege Separation is turned on for security</span><br><span class="line">UsePrivilegeSeparation yes</span><br><span class="line"></span><br><span class="line"># Lifetime and size of ephemeral version 1 server key</span><br><span class="line">KeyRegenerationInterval 3600</span><br><span class="line">ServerKeyBits 768</span><br><span class="line"></span><br><span class="line"># Logging</span><br><span class="line">SyslogFacility AUTH</span><br><span class="line">LogLevel DEBUG3</span><br><span class="line"></span><br><span class="line"># Authentication:</span><br><span class="line">LoginGraceTime 120</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">StrictModes yes</span><br><span class="line"></span><br><span class="line">RSAAuthentication no</span><br><span class="line">PubkeyAuthentication yes   #使用公钥验证</span><br><span class="line">AuthorizedKeysFile	/home/git/.ssh/authorized_keys #公钥文件地址，使我们创建的，并且需要把各个用户的公钥收集起来，然后黏贴到这个文件中</span><br><span class="line"># Don&apos;t read the user&apos;s ~/.rhosts and ~/.shosts files</span><br><span class="line">IgnoreRhosts yes</span><br><span class="line"># For this to work you will also need host keys in /etc/ssh_known_hosts</span><br><span class="line">RhostsRSAAuthentication no</span><br><span class="line"># similar for protocol version 2</span><br><span class="line">HostbasedAuthentication no</span><br><span class="line"># Uncomment if you don&apos;t trust ~/.ssh/known_hosts for RhostsRSAAuthentication</span><br><span class="line">#IgnoreUserKnownHosts yes</span><br><span class="line"></span><br><span class="line"># To enable empty passwords, change to yes (NOT RECOMMENDED)</span><br><span class="line">PermitEmptyPasswords no</span><br><span class="line"></span><br><span class="line"># Change to yes to enable challenge-response passwords (beware issues with</span><br><span class="line"># some PAM modules and threads)</span><br><span class="line">ChallengeResponseAuthentication no</span><br><span class="line"></span><br><span class="line"># Change to no to disable tunnelled clear text passwords</span><br><span class="line">#PasswordAuthentication no  #允许使用密码验证</span><br><span class="line"></span><br><span class="line"># Kerberos options</span><br><span class="line">#KerberosAuthentication no</span><br><span class="line">#KerberosGetAFSToken no</span><br><span class="line">#KerberosOrLocalPasswd yes</span><br><span class="line">#KerberosTicketCleanup yes</span><br><span class="line"></span><br><span class="line"># GSSAPI options</span><br><span class="line">#GSSAPIAuthentication no</span><br><span class="line">#GSSAPICleanupCredentials yes</span><br><span class="line"></span><br><span class="line">X11Forwarding yes</span><br><span class="line">X11DisplayOffset 10</span><br><span class="line">PrintMotd no</span><br><span class="line">PrintLastLog yes</span><br><span class="line">TCPKeepAlive yes</span><br><span class="line">#UseLogin no</span><br><span class="line"></span><br><span class="line">#MaxStartups 10:30:60</span><br><span class="line">#Banner /etc/issue.net</span><br><span class="line"></span><br><span class="line"># Allow client to pass locale environment variables</span><br><span class="line">AcceptEnv LANG LC_*</span><br><span class="line"></span><br><span class="line">Subsystem sftp /usr/lib/openssh/sftp-server</span><br><span class="line"></span><br><span class="line"># Set this to &apos;yes&apos; to enable PAM authentication, account processing,</span><br><span class="line"># and session processing. If this is enabled, PAM authentication will</span><br><span class="line"># be allowed through the ChallengeResponseAuthentication and</span><br><span class="line"># PasswordAuthentication.  Depending on your PAM configuration,</span><br><span class="line"># PAM authentication via ChallengeResponseAuthentication may bypass</span><br><span class="line"># the setting of &quot;PermitRootLogin without-password&quot;.</span><br><span class="line"># If you just want the PAM account and session checks to run without</span><br><span class="line"># PAM authentication, then enable this but set PasswordAuthentication</span><br><span class="line"># and ChallengeResponseAuthentication to &apos;no&apos;.</span><br><span class="line">UsePAM yes</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置不允许通过shell登录git用户账号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">guoyzh:x:1000:1000:guoyzh,,,:/home/guoyzh:/bin/bash</span><br><span class="line">sshd:x:115:65534::/var/run/sshd:/usr/sbin/nologin</span><br><span class="line">huangyc:x:1001:0:huangyc,,,,:/home/huangyc:/bin/bash</span><br><span class="line">git:x:1002:1002:,,,:/home/git:/usr/bin/git-shell  #改成/usr/bin/git-shell</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试ssh 登录，查找问题的时候可以使用如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh -vT git@10.24.9.244</span><br><span class="line">OpenSSH_7.5p1, OpenSSL 1.0.2k  26 Jan 2017</span><br><span class="line">debug1: Reading configuration data /etc/ssh/ssh_config</span><br><span class="line">debug1: Connecting to 10.24.9.244 [10.24.9.244] port 22.</span><br><span class="line">debug1: Connection established.</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他用户使用 <code>git clone git@10.24.9.244:/home/gitrepo/zoweedoc.git</code>即可clone仓库</p>
</li>
</ol>
<h1 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h1><p>为了不破坏服务器上的环境，安装了个虚拟机来做下面的事情</p>
<p>虚拟机安装：</p>
<p>1.安装VMware workstations</p>
<p>2.下载Ubuntu镜像</p>
<h2 id="安装npm-nodejs"><a href="#安装npm-nodejs" class="headerlink" title="安装npm,nodejs"></a>安装npm,nodejs</h2><p>Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境，其使用了一个事件驱动、非阻塞式 I/O 的模型，使其轻量又高效。<br>Node.js 的包管理器 npm，是全球最大的开源库生态系统，功能及其强大。 </p>
<ol>
<li><p>安装nvm</p>
<p> sudo git clone <a href="https://github.com/cnpm/nvm.git" target="_blank" rel="noopener">https://github.com/cnpm/nvm.git</a></p>
<p> <code>vim ~/.bashrc</code></p>
<p>添加 source ~/git/nvm/nvm.sh  配置终端启动时自动执行 <code>source ~/git/nvm/nvm.sh</code></p>
</li>
<li><p>通过nvm安装node</p>
<p><code>nvm ls-remote</code> 查看远程版本</p>
<p>最新的release版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ nvm --version</span><br><span class="line">0.26.1</span><br></pre></td></tr></table></figure>

<p>先安裝一個</p>
<p>nvm install v9.8.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-03-13 20:23:26 (1.91 MB/s) - ‘/home/lynn/git/nvm/bin/node-v9.8.0-linux-x64/node-v9.8.0-linux-x64.tar.gz’ saved [18071050/18071050]</span><br><span class="line"></span><br><span class="line">WARNING: checksums are currently disabled for node.js v4.0 and later</span><br><span class="line">Now using node v9.8.0 (npm v5.6.0)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Node.js 的包管理器 npm，但是据说比较慢，可以用cnpm来加速</p>
<p><code>npm install koa --registry=http://registry.npm.taobao.org</code></p>
</li>
<li><p>关闭终端后，输入npm无效了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~/git/nvm$ nvm use v9.8.0</span><br><span class="line">Now using node v9.8.0 (npm v5.6.0)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="gitbook"><a href="#gitbook" class="headerlink" title="gitbook"></a>gitbook</h2><h3 id="安装gitbook"><a href="#安装gitbook" class="headerlink" title="安装gitbook"></a>安装gitbook</h3><p>利用npm安装gitbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> npm install gitbook-cli -g</span><br><span class="line">/home/lynn/git/nvm/versions/node/v9.8.0/bin/gitbook -&gt; /home/lynn/git/nvm/versions/node/v9.8.0/lib/node_modules/gitbook-cli/bin/gitbook.js</span><br><span class="line">+ gitbook-cli@2.3.2</span><br><span class="line">added 578 packages in 116.801s</span><br></pre></td></tr></table></figure>

<h3 id="添加demo-gitbook"><a href="#添加demo-gitbook" class="headerlink" title="添加demo gitbook"></a>添加demo gitbook</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir demo</span><br><span class="line">cd demo</span><br><span class="line">gitbook init</span><br><span class="line">.......</span><br><span class="line">warn: no summary file in this book </span><br><span class="line">info: create README.md </span><br><span class="line">info: create SUMMARY.md </span><br><span class="line">info: initialization is finished</span><br></pre></td></tr></table></figure>

<p>自动生成了readme 和summary</p>
<h3 id="生成html静态网页"><a href="#生成html静态网页" class="headerlink" title="生成html静态网页"></a>生成html静态网页</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitbook build</span><br></pre></td></tr></table></figure>

<p>多了一个<code>_book</code>的目录</p>
<p>打开index.html就可以查看书籍内容</p>
<h3 id="启动服务gitbook-serve"><a href="#启动服务gitbook-serve" class="headerlink" title="启动服务gitbook serve"></a>启动服务gitbook serve</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~/gitbook/zoweedoc$ gitbook serve</span><br><span class="line">Live reload server started on port: 35729</span><br><span class="line">Press CTRL+C to quit ...</span><br><span class="line"></span><br><span class="line">info: 7 plugins are installed </span><br><span class="line">info: loading plugin &quot;livereload&quot;... OK </span><br><span class="line">info: loading plugin &quot;highlight&quot;... OK </span><br><span class="line">info: loading plugin &quot;search&quot;... OK </span><br><span class="line">info: loading plugin &quot;lunr&quot;... OK </span><br><span class="line">info: loading plugin &quot;sharing&quot;... OK </span><br><span class="line">info: loading plugin &quot;fontsettings&quot;... OK </span><br><span class="line">info: loading plugin &quot;theme-default&quot;... OK </span><br><span class="line">info: found 1 pages </span><br><span class="line">info: found 11 asset files </span><br><span class="line">info: &gt;&gt; generation finished with success in 1.9s ! </span><br><span class="line"></span><br><span class="line">Starting server ...</span><br><span class="line">Serving book on http://localhost:4000</span><br></pre></td></tr></table></figure>

<p>可通过浏览器访问gitbook了</p>
<h1 id="push触发"><a href="#push触发" class="headerlink" title="push触发"></a>push触发</h1><p>现在我们可以生成gitbook了，如何在zoweedoc.git有push工作后，立即同步所有的更新，再出发gitbook的build，生成最新的网页代码呢？</p>
<h2 id="Git-钩子"><a href="#Git-钩子" class="headerlink" title="Git 钩子"></a>Git 钩子</h2><p>和其它版本控制系统一样，Git 能在特定的重要动作发生时触发自定义脚本。 有两组这样的钩子：客户端的和服务器端的。 客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。 你可以随心所欲地运用这些钩子。</p>
<ol>
<li>在服务器上建一个普通的Git仓库，用于存放网站</li>
<li>在源git的post-receive中执行git pull的操作，实现文档更新，然后可以重新build </li>
</ol>
<p>但是现在我们的git服务器环境太老了，很多东西没办法安装，上述用hook的方式进行更新，无法实现</p>
<p>采用在另外一台机子上，采用定时更新</p>
<h2 id="定时更新"><a href="#定时更新" class="headerlink" title="定时更新"></a>定时更新</h2><ul>
<li><p>查看当前定时任务</p>
<p>crontab -l</p>
</li>
<li><p>创建编辑定时任务</p>
<p>crontab -e</p>
</li>
<li><p>编辑定时任务</p>
<p><code>* */1 * * * /home/lynn/gitbook/syn.sh /home/lynn/gitbook/zoweedoc</code></p>
<p>脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">source ~/git/nvm/nvm.sh</span><br><span class="line">cd $1</span><br><span class="line">unset GIT_DIR</span><br><span class="line">git pull origin master</span><br><span class="line"></span><br><span class="line">nvm use v9.8.0</span><br><span class="line">gitbook serve</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看定時任務執行情況</p>
<p>看 /var/log/cron这个文件就可以，可以用tail -f /var/log/cron观察</p>
</li>
<li><p>定時任務有沒有啟動排查的</p>
<ul>
<li><p>确认服务器是否开机定时任务计划服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:/var/log$ service crond status</span><br><span class="line">● crond.service</span><br><span class="line">   Loaded: not-found (Reason: No such file or directory)</span><br><span class="line">   Active: inactive (dead)</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ service crond start</span><br><span class="line">Failed to start crond.service: Unit crond.service not found.</span><br></pre></td></tr></table></figure>
</li>
<li><p>新的服务名字变了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sudo service cron  start #启动服务</span><br><span class="line">lynn@ubuntu:~$ service cron status</span><br><span class="line">● cron.service - Regular background program processing daemon</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/cron.service; enabled; vendor preset: ena</span><br><span class="line">   Active: active (running) since Wed 2018-03-14 00:49:42 PDT; 1h 47min ago</span><br><span class="line">     Docs: man:cron(8)</span><br><span class="line"> Main PID: 793 (cron)</span><br><span class="line">   CGroup: /system.slice/cron.service</span><br><span class="line">           └─793 /usr/sbin/cron -f</span><br><span class="line"></span><br><span class="line">Mar 14 02:15:01 ubuntu CRON[3456]: (CRON) info (No MTA installed, discarding out</span><br><span class="line">Mar 14 02:15:01 ubuntu CRON[3456]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3474]: pam_unix(cron:session): session opened for us</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3475]: (root) CMD (   cd / &amp;&amp; run-parts --report /et</span><br><span class="line">Mar 14 02:17:01 ubuntu CRON[3474]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: pam_unix(cron:session): session opened for us</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3648]: (lynn) CMD (/home/lynn/gitbook/syn.sh /home/l</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: (CRON) info (No MTA installed, discarding out</span><br><span class="line">Mar 14 02:30:01 ubuntu CRON[3647]: pam_unix(cron:session): session closed for us</span><br><span class="line">Mar 14 02:36:28 ubuntu systemd[1]: Started Regular background program processing</span><br><span class="line">lines 1-18/18 (END)</span><br></pre></td></tr></table></figure>
</li>
<li><p>​</p>
</li>
</ul>
</li>
</ul>
<p>定时更新<a href="http://blog.csdn.net/csdn_yasin/article/details/70332796" target="_blank" rel="noopener">http://blog.csdn.net/csdn_yasin/article/details/70332796</a></p>
<p>查看执行情况</p>
<p><a href="http://blog.csdn.net/u013850277/article/details/54344805" target="_blank" rel="noopener">http://blog.csdn.net/u013850277/article/details/54344805</a></p>
<h2 id="访问虚拟机服务器IP"><a href="#访问虚拟机服务器IP" class="headerlink" title="访问虚拟机服务器IP"></a>访问虚拟机服务器IP</h2><h3 id="本机访问虚拟机服务器"><a href="#本机访问虚拟机服务器" class="headerlink" title="本机访问虚拟机服务器"></a>本机访问虚拟机服务器</h3><p>虚拟机通过ifconfig查询虚拟机IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">lynn@ubuntu:~$ ifconfig</span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0c:29:5d:64:1f  </span><br><span class="line">          inet addr:192.168.32.128  Bcast:192.168.32.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::aae1:44b2:cc44:dbba/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:101881 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:33601 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:121150102 (121.1 MB)  TX bytes:2044329 (2.0 MB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:234 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:234 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:18513 (18.5 KB)  TX bytes:18513 (18.5 KB)</span><br></pre></td></tr></table></figure>

<p>本机可直接通过，访问虚拟机服务器，查看gitbook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.32.128:4000/</span><br></pre></td></tr></table></figure>

<h3 id="其他机子如何访问"><a href="#其他机子如何访问" class="headerlink" title="其他机子如何访问"></a>其他机子如何访问</h3><ol>
<li>将虚拟机设置成NAT模式</li>
<li>启动虚拟网络编辑器，选择VMnet8，选择NAT模式，选择NAT设置</li>
<li>点击添加，主机端口8888，即希望别的机子访问的端口号<code>http://主机IP:8888/</code>，虚拟机地址，虚拟机实际IP地址，ifconfig查看，<code>192.168.32.128</code>，虚拟机端口，因为gitbook serve端口是4000，所以填4000</li>
<li>完成确定</li>
</ol>
<p>这样在其他主机就可以通过<code>http://主机IP:8888/</code>访问主机上虚拟机的4000端口服务了。</p>
<p>参考设置<a href="https://jingyan.baidu.com/article/8065f87fe9773b23312498a9.html" target="_blank" rel="noopener">如何配置其他主机访问虚拟机</a></p>
<h1 id="md文件编辑器"><a href="#md文件编辑器" class="headerlink" title="md文件编辑器"></a>md文件编辑器</h1><p>推荐使用typora，window版本的软件安装包地址 <code>\\10.24.9.247\360Downloads\.01应用组共享资料\09软件工具\typora-setup-x64.exe</code> </p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/02/27/google VR pana and video/">Google VR SDK 示例 360 media</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-27
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Google-VR-SDK-示例代码全景和视频"><a href="#Google-VR-SDK-示例代码全景和视频" class="headerlink" title="Google VR SDK 示例代码全景和视频"></a>Google VR SDK 示例代码全景和视频</h1><p>Google的SDK示例代码中有两个应用 simplepanowidget和simlevrvideo展示了如何内嵌一个360度的图片或者是视频。</p>
<h2 id="什么是360-media"><a href="#什么是360-media" class="headerlink" title="什么是360 media"></a>什么是360 media</h2><p>360度媒介，包括360度全景图片和360度全景视频。通过他们，可以加强传统应用的沉浸式体验。例如可以在旅游类应用中添加这种视图查看器作为海底世界游览体验，在家装应用中，让消费者可以先体验一下虚拟的效果。</p>
<p>这些360度媒介支持立体变化并与Google cardboard等vr平台兼容，也支持在浏览器中或者移动应用中查看而不需要特定的vr硬件支持。</p>
<ul>
<li><p>常见格式</p>
<p>360度媒体的格式可以是 mono或者是stereo。图片和视频通常需要存储在equirectangular-panoramic (equirect-pano)格式中，可以理解为柱体全景格式，这种格式为大部分拍摄解决方案所支持的格式。</p>
<p>Mono 360使用一张全景，stero 360使用两张堆积的全景图片。stero在全景之上，还有一个景深的这样一个概念，我们对前景和背景的距离深度有了一个感官的体验。</p>
</li>
<li><p>360度图片</p>
<p>可以以png,jpeg,gif的格式进行存储，建议使用jpeg来提高压缩率</p>
<p>为了最大限度的提高兼容性和性能，需要的尺寸是2次幂，2024，4096这样</p>
<p>mono图片，单张的方案，需要2:1的宽高比 例如4096*4096</p>
<p>stereo图片，左右两张堆积方案的，需要1:1的宽高比 4096*4096</p>
</li>
<li><p>360度视频</p>
<p>以h2642编码的mp4s格式存储</p>
<p>mono方案提供2:1宽高比</p>
<p>stereo提供1:1宽高比</p>
<p>一些比较老的设备无法对大雨1080p(1920*1080)的视频进行解码，如果要进行兼容，建议提供提供monoscopic 1920 * 1080的视频和stereo 2048 * 2048的的视频</p>
</li>
<li><p>如何内嵌和显示这些媒体</p>
<ul>
<li><a href="https://developers.google.com/vr/android/samples/vrview" target="_blank" rel="noopener">VR View on Android</a></li>
<li><a href="https://developers.google.com/vr/concepts/vrview-web" target="_blank" rel="noopener">VR View on the Web</a></li>
</ul>
<p>另外也有ios平台等</p>
</li>
</ul>
<h2 id="如何拍摄到全景的媒体"><a href="#如何拍摄到全景的媒体" class="headerlink" title="如何拍摄到全景的媒体"></a>如何拍摄到全景的媒体</h2><ul>
<li><p>实景拍摄</p>
<ul>
<li><a href="https://play.google.com/store/apps/details?id=com.google.vr.cyclops" target="_blank" rel="noopener">Cardboard Camera App</a>:    使用该应用可以快速的拍摄360全景图片，然后可以下载  <a href="https://support.google.com/cardboard/answer/6333620" target="_blank" rel="noopener">download</a>    这些图片然后使用    <a href="https://storage.googleapis.com/cardboard-camera-converter/index.html" target="_blank" rel="noopener">conversion tool</a>    来生成 stereo 360° 图片，就可以符合 Cardboard’s 图片要求了。</li>
<li><a href="https://theta360.com/" target="_blank" rel="noopener">Ricoh Theta</a>: 可用于拍摄 mono 360° 图片和视频 </li>
</ul>
</li>
<li><p>CG capture</p>
<p>cgi软件可根据生成全景图片和视频，一些热门的拍摄方案如下</p>
<ul>
<li><a href="https://assetstore.unity.com/packages/tools/camera/360-panorama-capture-38755" target="_blank" rel="noopener">360 Panorama Capture for Unity</a>:    A free, easy-to-use 360° capture plugin for <strong>Unity</strong>.</li>
<li><a href="https://docs.unrealengine.com/latest/INT/Platforms/VR/StereoPanoramicCapture/" target="_blank" rel="noopener">Unreal</a>: Stero panoramic capture in <strong>Unreal</strong>.</li>
<li>(Unsupported) <a href="https://github.com/zicher3d-org/domemaster-stereo-shader/" target="_blank" rel="noopener">Domemaster3D</a>:    A free solution for capturing mono and stereo 360° images from Maya / Autodesk 3ds Max.</li>
<li><a href="https://drive.google.com/drive/folders/0B0lYKpimsJgWfjFwa2xLQlVGNnJXcGxvbmNJbzIwUkRWQ2YtOHB5blNMNjlXSUlxbmJNVVU" target="_blank" rel="noopener">Renderman</a>:    Open-source library for capturing 360° content.开源库</li>
<li><a href="https://developers.google.com/vr/jump/rendering-ods-content.pdf" target="_blank" rel="noopener">Rendering Omnidirectional Stereo Content</a>:    A whitepaper for anyone interested in writing their own 360° capture    solutions.</li>
</ul>
</li>
<li><p>YouTube下载，在YouTube上搜索monoscopic的视频，然后通过 <a href="http://youtubemp4.to/" target="_blank" rel="noopener">http://youtubemp4.to/</a> 来下载mp4格式的文件</p>
</li>
</ul>
<h2 id="全景图片walkthrough"><a href="#全景图片walkthrough" class="headerlink" title="全景图片walkthrough"></a>全景图片walkthrough</h2><p>根据Gsensor的数据展示不同的方位景物；</p>
<p>全屏模式 和 cardboard 模式切换</p>
<ul>
<li><p>代码概览</p>
<p>在layout XML文件中，嵌入，该组件自身就集成了全屏，立体模式，退出等模式的切换按钮</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.google.vr.sdk.widgets.pano.VrPanoramaView</span><br><span class="line">          android:id=&quot;@+id/pano_view&quot;</span><br><span class="line">          android:layout_margin=&quot;5dip&quot;</span><br><span class="line">          android:layout_width=&quot;match_parent&quot;</span><br><span class="line">          android:scrollbars=&quot;@null&quot;</span><br><span class="line">          android:layout_height=&quot;250dip&quot;/&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>activitie 代码</p>
<p>初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  @Override</span><br><span class="line">  protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">    super.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.main_layout);</span><br><span class="line">.......</span><br><span class="line">    panoWidgetView = (VrPanoramaView) findViewById(R.id.pano_view);</span><br><span class="line">    panoWidgetView.setEventListener(new ActivityEventListener());</span><br><span class="line"></span><br><span class="line">    // Initial launch of the app or an Activity recreation due to rotation.</span><br><span class="line">    handleIntent(getIntent());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中ActivityEventListener继承自VrPanoramaEventListener，用于监听来自widget的事件，例如当widget加载完图片后的onLoadSuccess回调。或者加载失败后的onLoadError回调。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Listen to the important events from widget.</span><br><span class="line">   */</span><br><span class="line">  private class ActivityEventListener extends VrPanoramaEventListener &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Called by pano widget on the UI thread when it&apos;s done loading the image.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadSuccess() &#123;</span><br><span class="line">      loadImageSuccessful = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called by pano widget on the UI thread on any asynchronous error.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadError(String errorMessage) &#123;</span><br><span class="line">      loadImageSuccessful = false;</span><br><span class="line">      Toast.makeText(</span><br><span class="line">          SimpleVrPanoramaActivity.this, &quot;Error loading pano: &quot; + errorMessage, Toast.LENGTH_LONG)</span><br><span class="line">          .show();</span><br><span class="line">      Log.e(TAG, &quot;Error loading pano: &quot; + errorMessage);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在线程中加载图片</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Helper class to manage threading.</span><br><span class="line">   */</span><br><span class="line">  class ImageLoaderTask extends AsyncTask&lt;Pair&lt;Uri, Options&gt;, Void, Boolean&gt; &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Reads the bitmap from disk in the background and waits until it&apos;s loaded by pano widget.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected Boolean doInBackground(Pair&lt;Uri, Options&gt;... fileInformation) &#123;</span><br><span class="line">      Options panoOptions = null;  // It&apos;s safe to use null VrPanoramaView.Options.</span><br><span class="line">      InputStream istr = null;</span><br><span class="line">      if (fileInformation == null || fileInformation.length &lt; 1</span><br><span class="line">          || fileInformation[0] == null || fileInformation[0].first == null) &#123;</span><br><span class="line">        AssetManager assetManager = getAssets();</span><br><span class="line">        try &#123;</span><br><span class="line">          istr = assetManager.open(&quot;andes.jpg&quot;);／／打开assert文件</span><br><span class="line">          panoOptions = new Options();</span><br><span class="line">          panoOptions.inputType = Options.TYPE_STEREO_OVER_UNDER;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">          Log.e(TAG, &quot;Could not decode default bitmap: &quot; + e);</span><br><span class="line">          return false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          istr = new FileInputStream(new File(fileInformation[0].first.getPath()));</span><br><span class="line">          panoOptions = fileInformation[0].second;</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">          Log.e(TAG, &quot;Could not load file: &quot; + e);</span><br><span class="line">          return false;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      panoWidgetView.loadImageFromBitmap(BitmapFactory.decodeStream(istr), panoOptions);／／将读取的iostream进行加载</span><br><span class="line">      try &#123;</span><br><span class="line">        istr.close();</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        Log.e(TAG, &quot;Could not close input stream: &quot; + e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<h2 id="全景视频walkthrough"><a href="#全景视频walkthrough" class="headerlink" title="全景视频walkthrough"></a>全景视频walkthrough</h2><p>全景视频的视图和全景图片的非常相似，使用上也差不多，展现出来的，就是一个是视频画面生动的效果</p>
<p>XML集成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.google.vr.sdk.widgets.video.VrVideoView</span><br><span class="line">          android:id=&quot;@+id/video_view&quot;</span><br><span class="line">          android:layout_width=&quot;match_parent&quot;</span><br><span class="line">          android:scrollbars=&quot;@null&quot;</span><br><span class="line">          android:layout_height=&quot;250dip&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Bind input and output objects for the view.</span><br><span class="line">   videoWidgetView = (VrVideoView) findViewById(R.id.video_view);</span><br><span class="line">   videoWidgetView.setEventListener(new ActivityEventListener());</span><br></pre></td></tr></table></figure>

<p>其中ActivityEventListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Listen to the important events from widget.</span><br><span class="line">   */</span><br><span class="line">  private class ActivityEventListener extends VrVideoEventListener  &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Called by video widget on the UI thread when it&apos;s done loading the video.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadSuccess() &#123;</span><br><span class="line">    ／／加载成功的时候，根据视频的长度，设置进度条最大值</span><br><span class="line">      Log.i(TAG, &quot;Successfully loaded video &quot; + videoWidgetView.getDuration());</span><br><span class="line">      loadVideoStatus = LOAD_VIDEO_STATUS_SUCCESS;</span><br><span class="line">      seekBar.setMax((int) videoWidgetView.getDuration());</span><br><span class="line">      updateStatusText();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Called by video widget on the UI thread on any asynchronous error.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onLoadError(String errorMessage) &#123;</span><br><span class="line">      // An error here is normally due to being unable to decode the video format.</span><br><span class="line">      loadVideoStatus = LOAD_VIDEO_STATUS_ERROR;</span><br><span class="line">      Toast.makeText(</span><br><span class="line">          SimpleVrVideoActivity.this, &quot;Error loading video: &quot; + errorMessage, Toast.LENGTH_LONG)</span><br><span class="line">          .show();</span><br><span class="line">      Log.e(TAG, &quot;Error loading video: &quot; + errorMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onClick() &#123;</span><br><span class="line">      togglePause();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Update the UI every frame.每一帧更新进度条</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onNewFrame() &#123;</span><br><span class="line">      updateStatusText();</span><br><span class="line">      seekBar.setProgress((int) videoWidgetView.getCurrentPosition());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Make the video play in a loop. This method could also be used to move to the next video in</span><br><span class="line">     * a playlist.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public void onCompletion() &#123;</span><br><span class="line">      videoWidgetView.seekTo(0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>加载视频的线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Helper class to manage threading.</span><br><span class="line">   */</span><br><span class="line">  class VideoLoaderTask extends AsyncTask&lt;Pair&lt;Uri, Options&gt;, Void, Boolean&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected Boolean doInBackground(Pair&lt;Uri, Options&gt;... fileInformation) &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">         if (fileInformation == null || fileInformation.length &lt; 1</span><br><span class="line">          || fileInformation[0] == null || fileInformation[0].first == null) &#123;</span><br><span class="line">          // No intent was specified, so we default to playing the local stereo-over-under video.</span><br><span class="line">          Options options = new Options();</span><br><span class="line">          options.inputType = Options.TYPE_STEREO_OVER_UNDER;</span><br><span class="line">          videoWidgetView.loadVideoFromAsset(&quot;congo.mp4&quot;, options);直接根据文件名加载</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">          videoWidgetView.loadVideo(fileInformation[0].first, fileInformation[0].second);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        // An error here is normally due to being unable to locate the file.</span><br><span class="line">        loadVideoStatus = LOAD_VIDEO_STATUS_ERROR;</span><br><span class="line">        // Since this is a background thread, we need to switch to the main thread to show a toast.</span><br><span class="line">        videoWidgetView.post(new Runnable() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public void run() &#123;</span><br><span class="line">            Toast</span><br><span class="line">                .makeText(SimpleVrVideoActivity.this, &quot;Error opening file. &quot;, Toast.LENGTH_LONG)</span><br><span class="line">                .show();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Log.e(TAG, &quot;Could not open video: &quot; + e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这两个应用主要展示 VrPanoramaView 和VrVideoView的基本用法</p>
<h2 id="番外示例video360和videoplayer"><a href="#番外示例video360和videoplayer" class="headerlink" title="番外示例video360和videoplayer"></a>番外示例video360和videoplayer</h2><h3 id="sdk-video360"><a href="#sdk-video360" class="headerlink" title="sdk-video360"></a>sdk-video360</h3><p>video360要求设备最低版本为android 24，android N 7.0以上</p>
<p>可以渲染全景视频的播放器。 根据intent中的文件uri来进行进行视频播放。应用中定义了两个activity，一个只能在2d的launcher中显示图标，另外一个只能在专属的Daydream Home中显示图标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- This is a 2D Version of the video player. --&gt;</span><br><span class="line">   &lt;activity</span><br><span class="line">       android:name=&quot;.VideoActivity&quot;</span><br><span class="line">       android:icon=&quot;@drawable/icon&quot;</span><br><span class="line">       android:label=&quot;@string/app_name&quot;</span><br><span class="line">       android:launchMode=&quot;singleTask&quot;</span><br><span class="line">       android:screenOrientation=&quot;portrait&quot;&gt;</span><br><span class="line">     &lt;!-- This Activity only shows up in the 2D launcher.  --&gt;</span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">         &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line">         &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">     &lt;/intent-filter&gt;</span><br><span class="line">   &lt;/activity&gt;</span><br><span class="line"></span><br><span class="line">   &lt;!-- This is a standard Daydream Activity.  --&gt;</span><br><span class="line">   &lt;activity</span><br><span class="line">       android:name=&quot;.VrVideoActivity&quot;</span><br><span class="line">       android:configChanges=&quot;orientation|keyboardHidden|screenSize|uiMode|navigation&quot;</span><br><span class="line">       android:enableVrMode=&quot;@string/gvr_vr_mode_component&quot;</span><br><span class="line">       android:label=&quot;@string/app_name&quot;</span><br><span class="line">       android:launchMode=&quot;singleTask&quot;</span><br><span class="line">       android:resizeableActivity=&quot;false&quot;</span><br><span class="line">       android:screenOrientation=&quot;landscape&quot;</span><br><span class="line">       android:theme=&quot;@style/VrActivityTheme&quot;&gt;</span><br><span class="line"></span><br><span class="line">     &lt;!-- The VR icon to be used in Daydream Home comes in two parts: a foreground icon and a</span><br><span class="line">          background icon. The foreground icon is also used by the 2D Activity. --&gt;</span><br><span class="line">     &lt;meta-data</span><br><span class="line">         android:name=&quot;com.google.android.vr.icon&quot;</span><br><span class="line">         android:resource=&quot;@drawable/icon&quot; /&gt;</span><br><span class="line">     &lt;meta-data</span><br><span class="line">         android:name=&quot;com.google.android.vr.icon_background&quot;</span><br><span class="line">         android:resource=&quot;@drawable/vr_icon_background&quot; /&gt;</span><br><span class="line"></span><br><span class="line">     &lt;!-- This Activity only shows up in Daydream Home and not the 2D Launcher. --&gt;</span><br><span class="line">     &lt;intent-filter&gt;</span><br><span class="line">       &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line">       &lt;category android:name=&quot;com.google.intent.category.DAYDREAM&quot;/&gt;</span><br><span class="line">     &lt;/intent-filter&gt;</span><br><span class="line">   &lt;/activity&gt;</span><br></pre></td></tr></table></figure>

<p>其中activity的大部分代码都是和权限相关的，真正的视频解析加载在MediaLoader中，从类的说明中可以看到，可以通过adb命令来传递intent来打开视频：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;Example intents compatible with adb are:</span><br><span class="line">*   &lt;ul&gt;</span><br><span class="line">*     &lt;li&gt;</span><br><span class="line">*       A top-bottom stereo image in the VR Activity.</span><br><span class="line">*       &lt;b&gt;adb shell am start -a android.intent.action.VIEW  \</span><br><span class="line">*          -n com.google.vr.sdk.samples.video360/.VrVideoActivity \</span><br><span class="line">*          -d &quot;file:///sdcard/IMAGE.JPG&quot; \</span><br><span class="line">*          --ei stereoFormat 2</span><br><span class="line">*       &lt;/b&gt;</span><br><span class="line">*     &lt;/li&gt;</span><br><span class="line">*     &lt;li&gt;</span><br><span class="line">*       A monoscopic video in the 2D Activity.</span><br><span class="line">*       &lt;b&gt;adb shell am start -a android.intent.action.VIEW  \</span><br><span class="line">*          -n com.google.vr.sdk.samples.video360/.VideoActivity \</span><br><span class="line">*          -d &quot;file:///sdcard/VIDEO.MP4&quot; \</span><br><span class="line">*          --ei stereoFormat 0</span><br><span class="line">*       &lt;/b&gt;</span><br><span class="line">*     &lt;/li&gt;</span><br><span class="line">*   &lt;/ul&gt;</span><br><span class="line">*</span><br><span class="line">* &lt;p&gt;This sample does not validiate that a given file is readable by the Android media decoders.</span><br><span class="line">* You should validate that the file plays on your target devices via</span><br><span class="line">* &lt;b&gt;adb shell am start -a android.intent.action.VIEW -t video/mpeg -d &quot;file:///VIDEO.MP4&quot;&lt;/b&gt;</span><br></pre></td></tr></table></figure>

<p>我们从YouTube上下载了一个monoscopic的视频，放在sdcard的目录下，通过运行命令可播放对应的全景视频</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">F:\09androidsdk&gt;adb shell am start -a android.intent.action.VIEW -n com.google.v</span><br><span class="line">r.sdk.samples.video360/.VideoActivity -d &quot;file://storage/sdcard/monoscopicVideo.</span><br><span class="line">mp4&quot; --ei stereoFormat 0</span><br><span class="line">Starting: Intent &#123; act=android.intent.action.VIEW dat=file://storage/sdcard/mono</span><br><span class="line">scopicVideo.mp4 cmp=com.google.vr.sdk.samples.video360/.VideoActivity (has extra</span><br><span class="line">s) &#125;</span><br></pre></td></tr></table></figure>

<p>该命令启用的是VideoActivity来播放全景视频，参数stereoFormat 0表示，视频类型为单个摄像头帧拍摄的全景视频。1表示用左右眼的方式渲染的，如果在非vr的显示中显示的话，则只显示左眼部分。2表示上下部分分割的左右眼渲染方式，如果在非vr显示中显示的话，只显示上部分内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/** Standard media where a single camera frame takes up the entire media frame. */</span><br><span class="line">  public static final int MEDIA_MONOSCOPIC = 0;</span><br><span class="line">  /**</span><br><span class="line">   * Stereo media where the left &amp; right halves of the frame are rendered for the left &amp; right eyes,</span><br><span class="line">   * respectively. If the stereo media is rendered in a non-VR display, only the left half is used.</span><br><span class="line">   */</span><br><span class="line">  public static final int MEDIA_STEREO_LEFT_RIGHT = 1;</span><br><span class="line">  /**</span><br><span class="line">   * Stereo media where the top &amp; bottom halves of the frame are rendered for the left &amp; right eyes,</span><br><span class="line">   * respectively. If the stereo media is rendered in a non-VR display, only the top half is used.</span><br><span class="line">   */</span><br><span class="line">  public static final int MEDIA_STEREO_TOP_BOTTOM = 2;</span><br></pre></td></tr></table></figure>

<p>播放器demo在8996上 android6.0无法运行。</p>
<p><strong>在8953上可以运行播放3d stereo视频，视频播放不正常，叠加不正确。</strong></p>
<p>但是切换成cardboard模式的点击 眼镜 标示的图标按钮后，切换到VrVideoActivity提示：</p>
<blockquote>
<p>手机不兼容：手机必须与Daydream兼容，请访问Daydream帮助中心了解详情。</p>
</blockquote>
<p>在moto     z和pixel等兼容手机上可正常运行，实现左右眼形变播放，中间会弹出和daydream控制器的配对的等。</p>
<p>对应配合Daydream viewer应该就可以看到立体视频效果。</p>
<p><em>TODO: 如何与Daydream平台进行兼容，需要做哪些工作，目前官网上列出的课兼容手机有华为mate，三星galaxy note8，pixel，moto z等手机。</em></p>
<h3 id="sdk-videoplayer"><a href="#sdk-videoplayer" class="headerlink" title="sdk-videoplayer"></a>sdk-videoplayer</h3><p>通过 Asynchronous Reprojection Video Surface API来播放视频，也是一个播放器。</p>
<p>在5516上，运行出错，暂时不研究了</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/02/26/Understanding the Treasure Hunt sample game/">Understanding the Treasure Hunt sample game</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-26
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Google-VR-SDK-寻宝游戏code-overview"><a href="#Google-VR-SDK-寻宝游戏code-overview" class="headerlink" title="Google VR SDK 寻宝游戏code overview"></a>Google VR SDK 寻宝游戏code overview</h1><h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><ul>
<li>硬件要求：<ul>
<li>Daydream平台：可支持Daydream的手机：Galaxy note8，MotoZ force，pixel，Axon7 ZTE，Moto Z，Mate 9，LG v30等 和  Daydream Viewer</li>
<li>Cardboard平台，运行android 4.4 api19以上的手机和一个 Cardboard viewer</li>
</ul>
</li>
<li>软件要求：<ul>
<li>android sdk 25以上</li>
<li>Google VR SDK</li>
</ul>
</li>
</ul>
<h2 id="运行Google-VR-SDK"><a href="#运行Google-VR-SDK" class="headerlink" title="运行Google VR SDK"></a>运行Google VR SDK</h2><p>运行<strong>samples-sdk-treasurehunt</strong> </p>
<p>在android 4.4以上就可以运行，但是不一定能用，例如如果没有Gsensor数据等无法进行运动捕捉。虽然可以正常运行，但是无法进行体验。</p>
<h2 id="Manifest-文件"><a href="#Manifest-文件" class="headerlink" title="Manifest 文件"></a>Manifest 文件</h2><ul>
<li><p>VR应用属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest ...&gt;</span><br><span class="line">    &lt;uses-sdk android:minSdkVersion=&quot;19&quot; android:targetSdkVersion=&quot;24&quot;/&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;uses-feature android:glEsVersion=&quot;0x00020000&quot; android:required=&quot;true&quot; /&gt;</span><br><span class="line">    &lt;uses-feature android:name=&quot;android.software.vr.mode&quot; android:required=&quot;false&quot;/&gt;</span><br><span class="line">    &lt;uses-feature android:name=&quot;android.hardware.vr.high_performance&quot; android:required=&quot;false&quot;/&gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;uses-permission android:name=&quot;android.permission.READ_EXTERNAL_STORAGE&quot; /&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

<p>Google VR SDK 支持的最低版本为api 19, 另外Daydream 应用的target API 要24或者以上级别。需 OpenGL ES 2.0 支持，可正确渲染VR内容。<code>&lt;uses-feature android:name=&quot;android.software.vr.mode&quot; android:required=&quot;false&quot;/&gt;</code>和<code>&lt;uses-feature android:name=&quot;android.hardware.vr.high_performance&quot; android:required=&quot;false&quot;/&gt;</code> 由 Android N加入的新特性，前者表示需要使用Android VR模式，后者表示需要可支持Daydream的设备。</p>
<p>对于没有Google VR服务的设备，需要安装Google VR 服务，才可以将可支持Daydream的设备与对应的VR viewer配对。因此还需要添加<code>READ_EXTERNAL_STORAGE</code>权限。</p>
</li>
</ul>
<ul>
<li><p>VR Activity 属性</p>
<p>Activity也需要添加一些属性声明，才可兼容Daydream</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;.MyActivity&quot;</span><br><span class="line">    android:screenOrientation=&quot;landscape&quot;</span><br><span class="line">    android:enableVrMode=&quot;@string/gvr_vr_mode_component&quot;</span><br><span class="line">    android:theme=&quot;@style/VrActivityTheme&quot;</span><br><span class="line">    android:resizeableActivity=&quot;false&quot;</span><br><span class="line">    android:configChanges=&quot;density|keyboardHidden|navigation|orientation|screenSize|uiMode&quot;</span><br><span class="line">    ...&gt;</span><br></pre></td></tr></table></figure>

<p><code>enableVrMode</code>属性用于启用Android VR 模式，Android 7.0 N 引入的功能特性，用于支持高性能的移动 VR 应用。该属性表示，当启动Activity的时候，系统需要自动启动VR模式。</p>
<blockquote>
<p>启动 VR activity的时候，屏幕会有些轻微的闪烁，这是因为当启动VR模式的时候，Android需要切换到低持久性模式显示。</p>
</blockquote>
<p><code>android:theme=&quot;@style/VrActivityTheme&quot;</code>确保Activity在VR转换期间正常运行，<code>android:resizeableActivity=&quot;false&quot;</code>表明Activity不可调整显示大小，不与其他的Activity分屏。landscape表明屏幕需要横屏显示。</p>
<p><code>configChanges</code>可避免activity因为一些配置变化而造成activity的重新创建。</p>
<p>Google VR应用基本和要求：</p>
<p><a href="https://developers.google.com/vr/distribute/daydream/app-quality" target="_blank" rel="noopener">https://developers.google.com/vr/distribute/daydream/app-quality</a></p>
<ul>
<li><p>设计要求：</p>
<ol>
<li>物体对象需要放置在一定的距离，以便用户可以看清楚而不是看到两张图片。如果需要辅助文字，需要保证文字的可读性。建议物体对象需要放置在0.5米距离以上</li>
<li>需要维护头部动作位置追踪</li>
<li>地平线维持，不至于倾斜</li>
<li>相机操作需要用户启动，但可以不是一直直接的控制操作</li>
<li>app不干涉系统级别的复位行为</li>
<li>…….</li>
</ol>
</li>
<li><p>功能要求</p>
<ol>
<li><p>使用支持的VR SDK版本</p>
</li>
<li><p>使用Daydream API进行activity切换<code>daydreamApi.launchVrHomescreen();</code>  <code>daydreamApi.launchInVr(componentName);</code></p>
</li>
<li><p>不请求nfc权限，应用不能使用nfc权限，而是Daydream平台需要使用nfc功能来进行配对操作。</p>
</li>
<li><p>应用的manifest清单文件中，需要设置正确的VR activity样式：禁止android默认的windowmanager的切换动画；隐藏系统级的ui元素，例如系统状态栏，导航栏和键盘等；采用landscape，禁止方向转化；禁用多窗口支持。</p>
<p><code>android:theme=&quot;@style/VrActivityTheme&quot;</code>可用于禁止切换动画和隐藏系统ui;</p>
<p><code>android:enableVrMode=&quot;@string/gvr_vr_mode_component&quot;</code>可用于设置仅从Daydream Home或者另外一个VR activities来启动Activity，以便得到更快的切换。</p>
<p>示例的activity清单代码可查看前面的示例。</p>
<p>需要显示在VR Home中的Daydream activity需要设置<code>com.google.intent.category.DAYDREAM</code>，如果不想显示的VR Home中，只要设置<code>android.intent.action.VIEW</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    ... &gt;</span><br><span class="line">    ...</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line">        &lt;category android:name=&quot;com.google.intent.category.DAYDREAM&quot;/&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>根据平台设置硬件特性，对于Daydream的应用，以下硬件特性都是必须的。对于某些具有cardboard模式的VR则为可选的。</p>
<pre><code>android:glEsVersion=&quot;0x00020000&quot;
android.hardware.sensor.gyroscope
android.hardware.sensor.accelerometer
android.hardware.vr.high_performance
android.software.vr.mode</code></pre></li>
</ul>
</li>
</ul>
<pre><code>Examples

Application only supports Daydream:

&lt;uses-feature android:glEsVersion=&quot;0x00020000&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.accelerometer&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.gyroscope&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.vr.high_performance&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.software.vr.mode&quot; android:required=&quot;true&quot; /&gt;

Application supports both Daydream and Cardboard devices:

&lt;uses-feature android:glEsVersion=&quot;0x00020000&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.accelerometer&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.gyroscope&quot; android:required=&quot;true&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.vr.high_performance&quot; android:required=&quot;false&quot; /&gt;
&lt;uses-feature android:name=&quot;android.software.vr.mode&quot; android:required=&quot;false&quot; /&gt;

Application&apos;s VR mode is optional:

&lt;uses-feature android:glEsVersion=&quot;0x00020000&quot; android:required=&quot;false&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.accelerometer&quot; android:required=&quot;false&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.sensor.gyroscope&quot; android:required=&quot;false&quot; /&gt;
&lt;uses-feature android:name=&quot;android.hardware.vr.high_performance&quot; android:required=&quot;false&quot; /&gt;
&lt;uses-feature android:name=&quot;android.software.vr.mode&quot; android:required=&quot;false&quot; /&gt;</code></pre><ul>
<li><p>应用可以正常的暂停</p>
<p>这包括很多常见的操作场景暂停和恢复。例如用户通过控制器或者手机按键按下的Home按钮来立即暂停应用还有音频播放等。数据的保存和恢复。</p>
</li>
<li><p>应用可正常关闭</p>
</li>
</ul>
<ul>
<li><p>平台兼容性</p>
<p>每个activity都必须声明好支持的VR平台；Daydream还是cardboard。两个可兼容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Example of a Daydream/Cardboard Activity --&gt;</span><br><span class="line">&lt;activity ... &gt;</span><br><span class="line">    &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- This marks the Activity as a Daydream Activity and allows it</span><br><span class="line">             to be launched from the Daydream Home. --&gt;</span><br><span class="line">        &lt;category android:name=&quot;com.google.intent.category.DAYDREAM&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- This marks the Activity as a Cardboard Activity and allows it</span><br><span class="line">             to be launched from the Cardboard app. --&gt;</span><br><span class="line">        &lt;category android:name=&quot;com.google.intent.category.CARDBOARD&quot; /&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- This allows this Activity to be launched from the traditional</span><br><span class="line">             Android 2D launcher as well. Remove it if you do not want</span><br><span class="line">             this Activity to be launched directly from the 2D launcher. --&gt;</span><br><span class="line">        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;</span><br><span class="line">    &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="继承-GvrActivity"><a href="#继承-GvrActivity" class="headerlink" title="继承 GvrActivity"></a>继承 GvrActivity</h2><p>GvrActivity作为基类可对GoogleVR设备进行简单的集成，可以发布一些事件来与VR环境进行交互并且可以处理创建用于VR渲染的activity的一些通用的细节实现。GvrAcitivity使用的是sticky的沉浸式模式，因为GvrView只能在全屏模式下才可以进行渲染。封装的东西还是比较少的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">package com.google.vr.sdk.base;</span><br><span class="line"></span><br><span class="line">import android.app.Activity;</span><br><span class="line">import android.os.Bundle;</span><br><span class="line">import android.view.KeyEvent;</span><br><span class="line">import android.view.View;</span><br><span class="line">import android.view.ViewGroup.LayoutParams;</span><br><span class="line">import com.google.vr.cardboard.AndroidNCompat;</span><br><span class="line">import com.google.vr.cardboard.FullscreenMode;</span><br><span class="line">import com.google.vrtoolkit.cardboard.ScreenOnFlagHelper;</span><br><span class="line"></span><br><span class="line">public class GvrActivity extends Activity &#123;//直接集成的普通的activity</span><br><span class="line">    private FullscreenMode fullscreenMode;//全屏的flag设置和兼容模式</span><br><span class="line">    private final ScreenOnFlagHelper screenOnFlagHelper = new ScreenOnFlagHelper(this);</span><br><span class="line">    //在resume的启动sensor相关的监听</span><br><span class="line">    private GvrView cardboardView;</span><br><span class="line">    private boolean androidVrModeEnabled;</span><br><span class="line"></span><br><span class="line">    public GvrActivity() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setGvrView(GvrView gvrView) &#123;</span><br><span class="line">        this.setGvrView(gvrView, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setGvrView(GvrView gvrView, boolean enableVrModeFallbacks) &#123;</span><br><span class="line">        if (this.cardboardView != gvrView) &#123;</span><br><span class="line">            if (this.cardboardView != null) &#123;</span><br><span class="line">                this.cardboardView.setOnCardboardTriggerListener((Runnable)null);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.cardboardView = gvrView;</span><br><span class="line">            boolean enableAndroidVrMode = gvrView != null;</span><br><span class="line">            this.androidVrModeEnabled = AndroidNCompat.setVrModeEnabled(this, enableAndroidVrMode, enableVrModeFallbacks ? 1 : 0) &amp;&amp; enableAndroidVrMode;</span><br><span class="line">            if (gvrView != null) &#123;</span><br><span class="line">                gvrView.setOnCardboardTriggerListener(new Runnable() &#123;</span><br><span class="line">                    public void run() &#123;</span><br><span class="line">                        GvrActivity.this.onCardboardTrigger();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public GvrView getGvrView() &#123;</span><br><span class="line">        return this.cardboardView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onCardboardTrigger() &#123;//可重写</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void updateGvrViewerParams(GvrViewerParams newParams) &#123;</span><br><span class="line">        if (this.cardboardView != null) &#123;</span><br><span class="line">            this.cardboardView.updateGvrViewerParams(newParams);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        this.requestWindowFeature(1);</span><br><span class="line">        this.fullscreenMode = new FullscreenMode(this.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onResume() &#123;</span><br><span class="line">        super.onResume();</span><br><span class="line">        if (this.cardboardView != null) &#123;</span><br><span class="line">            this.cardboardView.onResume();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.fullscreenMode.goFullscreen();</span><br><span class="line">        this.screenOnFlagHelper.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onPause() &#123;</span><br><span class="line">        super.onPause();</span><br><span class="line">        if (this.cardboardView != null) &#123;</span><br><span class="line">            this.cardboardView.onPause();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        this.screenOnFlagHelper.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected void onDestroy() &#123;</span><br><span class="line">        if (this.cardboardView != null) &#123;</span><br><span class="line">            this.cardboardView.setOnCardboardTriggerListener((Runnable)null);</span><br><span class="line">            this.cardboardView.shutdown();</span><br><span class="line">            this.cardboardView = null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        super.onDestroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setContentView(View view) &#123;</span><br><span class="line">        if (view instanceof GvrView) &#123;</span><br><span class="line">            this.setGvrView((GvrView)view);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        super.setContentView(view);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setContentView(View view, LayoutParams params) &#123;</span><br><span class="line">        if (view instanceof GvrView) &#123;</span><br><span class="line">            this.setGvrView((GvrView)view);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        super.setContentView(view, params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onBackPressed() &#123;</span><br><span class="line">        super.onBackPressed();</span><br><span class="line">        this.cardboardView.onBackPressed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean onKeyDown(int keyCode, KeyEvent event) &#123;</span><br><span class="line">        return this.shouldSuppressKey(keyCode) || super.onKeyDown(keyCode, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean onKeyUp(int keyCode, KeyEvent event) &#123;</span><br><span class="line">        return this.shouldSuppressKey(keyCode) || super.onKeyUp(keyCode, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void onWindowFocusChanged(boolean hasFocus) &#123;</span><br><span class="line">        super.onWindowFocusChanged(hasFocus);</span><br><span class="line">        this.fullscreenMode.onWindowFocusChanged(hasFocus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setScreenAlwaysOn(boolean enabled) &#123;</span><br><span class="line">        this.screenOnFlagHelper.setScreenAlwaysOn(enabled);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private boolean shouldSuppressKey(int keyCode) &#123;</span><br><span class="line">        if (!this.androidVrModeEnabled) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return keyCode == 24 || keyCode == 25;//处理了音量加减键</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义GvrView"><a href="#定义GvrView" class="headerlink" title="定义GvrView"></a>定义GvrView</h2><p>GvrView主要用于VR渲染</p>
<ul>
<li>common_ui.xml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:id=&quot;@+id/ui_layout&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot; &gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;com.google.vr.sdk.base.GvrView</span><br><span class="line">        android:id=&quot;@+id/gvr_view&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:layout_alignParentTop=&quot;true&quot;</span><br><span class="line">        android:layout_alignParentLeft=&quot;true&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>初始化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public void initializeGvrView() &#123;</span><br><span class="line">  setContentView(R.layout.common_ui);//设置xml文件</span><br><span class="line"></span><br><span class="line">  GvrView gvrView = (GvrView) findViewById(R.id.gvr_view);</span><br><span class="line">  gvrView.setEGLConfigChooser(8, 8, 8, 8, 16, 8);</span><br><span class="line">  // Android设备往往支持多种EGL配置，可以使用不同数目的通道(channel)，也可以指定每个通道具有不同数目的位(bits)深度。因此， 在渲染器工作之前就应该指定EGL的配置。如果没有调用的话，那么默认的配置是 RGB_888 surface with a depth buffer depth of at least 16 bits. </span><br><span class="line"></span><br><span class="line">  gvrView.setRenderer(this);</span><br><span class="line">  gvrView.setTransitionViewEnabled(true);//提示页面</span><br><span class="line"></span><br><span class="line">  // Enable Cardboard-trigger feedback with Daydream headsets. This is a simple way of supporting</span><br><span class="line">  // Daydream controller input for basic interactions using the existing Cardboard trigger API.</span><br><span class="line">  //即使用现有的trigger API实现与daydream 头戴式设备的交互。</span><br><span class="line">  gvrView.enableCardboardTriggerEmulation();</span><br><span class="line"></span><br><span class="line">  if (gvrView.setAsyncReprojectionEnabled(true)) &#123;</span><br><span class="line">    // Async reprojection decouples the app framerate from the display framerate,</span><br><span class="line">    // allowing immersive interaction even at the throttled clockrates set by</span><br><span class="line">    // sustained performance mode.</span><br><span class="line">    AndroidCompat.setSustainedPerformanceMode(this, true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setGvrView(gvrView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="渲染视图"><a href="#渲染视图" class="headerlink" title="渲染视图"></a>渲染视图</h2><p>Google VR 支持两种renderers，GvrView.StereoRendere和GvrView.Renderer。demo中采用的是前者。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public interface StereoRenderer &#123;</span><br><span class="line">       @UsedByNative</span><br><span class="line">       void onNewFrame(HeadTransform var1);</span><br><span class="line"></span><br><span class="line">       @UsedByNative</span><br><span class="line">       void onDrawEye(Eye var1);</span><br><span class="line"></span><br><span class="line">       @UsedByNative</span><br><span class="line">       void onFinishFrame(Viewport var1);</span><br><span class="line"></span><br><span class="line">       void onSurfaceChanged(int var1, int var2);</span><br><span class="line"></span><br><span class="line">       void onSurfaceCreated(EGLConfig var1);</span><br><span class="line"></span><br><span class="line">       void onRendererShutdown();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public interface Renderer &#123;</span><br><span class="line">       @UsedByNative</span><br><span class="line">       void onDrawFrame(HeadTransform var1, Eye var2, Eye var3);</span><br><span class="line"></span><br><span class="line">       @UsedByNative</span><br><span class="line">       void onFinishFrame(Viewport var1);</span><br><span class="line"></span><br><span class="line">       void onSurfaceChanged(int var1, int var2);</span><br><span class="line"></span><br><span class="line">       void onSurfaceCreated(EGLConfig var1);</span><br><span class="line"></span><br><span class="line">       void onRendererShutdown();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>实现GvrView.StereoRendere接口饼设置gvrView.setRenderer(this);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class TreasureHuntActivity extends GvrActivity implements GvrView.StereoRendere&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    .....</span><br><span class="line">    private void init()&#123;</span><br><span class="line">        gvrView.setRenderer(this);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>void onNewFrame(HeadTransform var1);app 渲染的时候都会调用</li>
<li>void onDrawEye(Eye var1);eye参数不同的时候调用</li>
</ul>
<p>需要扩展相关OpenGL知识</p>
<h2 id="Render实现"><a href="#Render实现" class="headerlink" title="Render实现"></a>Render实现</h2><ul>
<li><p>onSurfaceCreated</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Creates the buffers we use to store information about the 3D world.</span><br><span class="line">  *</span><br><span class="line">  * &lt;p&gt;OpenGL doesn&apos;t use Java arrays, but rather needs data in a format it can understand.</span><br><span class="line">  * Hence we use ByteBuffers.</span><br><span class="line">  *</span><br><span class="line">  * @param config The EGL configuration used when creating the surface.</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> public void onSurfaceCreated(EGLConfig config) &#123;</span><br><span class="line">    GLES20.glClearColor(0.1f, 0.1f, 0.1f, 0.5f); // 黑色背景.</span><br><span class="line"></span><br><span class="line">   ／／初始化一些buffer</span><br><span class="line">   ByteBuffer bbVertices = ByteBuffer.allocateDirect(WorldLayoutData.CUBE_COORDS.length * 4);</span><br><span class="line">   bbVertices.order(ByteOrder.nativeOrder());</span><br><span class="line">   cubeVertices = bbVertices.asFloatBuffer();</span><br><span class="line">   cubeVertices.put(WorldLayoutData.CUBE_COORDS);</span><br><span class="line">   cubeVertices.position(0);</span><br><span class="line">   。。。。。。</span><br><span class="line">   int vertexShader = loadGLShader(GLES20.GL_VERTEX_SHADER, R.raw.light_vertex);</span><br><span class="line">   int gridShader = loadGLShader(GLES20.GL_FRAGMENT_SHADER, R.raw.grid_fragment);</span><br><span class="line">   int passthroughShader = loadGLShader(GLES20.GL_FRAGMENT_SHADER, R.raw.passthrough_fragment);／／从文件中加载</span><br><span class="line">   </span><br><span class="line">   更多需要扩展下GLES20的相关api</span><br><span class="line">   </span><br><span class="line">  // 另外起一个线程，来对音频文件进行解码</span><br><span class="line">   new Thread(</span><br><span class="line">           new Runnable() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public void run() &#123;</span><br><span class="line">               </span><br><span class="line">               gvrAudioEngine.preloadSoundFile(OBJECT_SOUND_FILE);//立体音频文件加载</span><br><span class="line">               sourceId = gvrAudioEngine.createSoundObject(OBJECT_SOUND_FILE);</span><br><span class="line">               gvrAudioEngine.setSoundObjectPosition(／／可设置声音发出的位置</span><br><span class="line">                   sourceId, modelPosition[0], modelPosition[1], modelPosition[2]);</span><br><span class="line">               gvrAudioEngine.playSound(sourceId, true /* looped playback */);</span><br><span class="line">               </span><br><span class="line">               gvrAudioEngine.preloadSoundFile(SUCCESS_SOUND_FILE);</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">       .start();</span><br><span class="line"> 	</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<ul>
<li><p>onNewFrame</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Prepares OpenGL ES before we draw a frame.</span><br><span class="line">   *</span><br><span class="line">   * @param headTransform The head transformation in the new frame.</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void onNewFrame(HeadTransform headTransform) &#123;</span><br><span class="line">    setCubeRotation();</span><br><span class="line"></span><br><span class="line">    // Build the camera matrix and apply it to the ModelView.</span><br><span class="line">    Matrix.setLookAtM(camera, 0, 0.0f, 0.0f, CAMERA_Z, 0.0f, 0.0f, 0.0f, 0.0f, 1.0f, 0.0f);</span><br><span class="line"></span><br><span class="line">    headTransform.getHeadView(headView, 0);</span><br><span class="line"></span><br><span class="line">    // Update the 3d audio engine with the most recent head rotation.</span><br><span class="line">    headTransform.getQuaternion(headRotation, 0);</span><br><span class="line">    gvrAudioEngine.setHeadRotation(</span><br><span class="line">        headRotation[0], headRotation[1], headRotation[2], headRotation[3]);</span><br><span class="line">    // Regular update call to GVR audio engine.</span><br><span class="line">    gvrAudioEngine.update();</span><br><span class="line"></span><br><span class="line">    checkGLError(&quot;onReadyToDraw&quot;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>public void onNewFrame(HeadTransform headTransform) 其中HeadTransform封装了头部位置动作信息，可获取<strong>四元数，坐标体系</strong>扩张（扩展知识）</p>
</li>
<li><p>onDrawEye</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Draws a frame for an eye.</span><br><span class="line"> *</span><br><span class="line"> * @param eye The eye to render. Includes all required transformations.</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public void onDrawEye(Eye eye) &#123;</span><br><span class="line">  GLES20.glEnable(GLES20.GL_DEPTH_TEST);</span><br><span class="line">  GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT | GLES20.GL_DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">  checkGLError(&quot;colorParam&quot;);</span><br><span class="line"></span><br><span class="line">  // Apply the eye transformation to the camera.</span><br><span class="line">  Matrix.multiplyMM(view, 0, eye.getEyeView(), 0, camera, 0);</span><br><span class="line"></span><br><span class="line">  // Set the position of the light</span><br><span class="line">  Matrix.multiplyMV(lightPosInEyeSpace, 0, view, 0, LIGHT_POS_IN_WORLD_SPACE, 0);</span><br><span class="line"></span><br><span class="line">  // Build the ModelView and ModelViewProjection matrices</span><br><span class="line">  // for calculating cube position and light.</span><br><span class="line">  float[] perspective = eye.getPerspective(Z_NEAR, Z_FAR);</span><br><span class="line">  Matrix.multiplyMM(modelView, 0, view, 0, modelCube, 0);</span><br><span class="line">  Matrix.multiplyMM(modelViewProjection, 0, perspective, 0, modelView, 0);</span><br><span class="line">  drawCube();</span><br><span class="line"></span><br><span class="line">  // Set modelView for the floor, so we draw floor in the correct location</span><br><span class="line">  Matrix.multiplyMM(modelView, 0, view, 0, modelFloor, 0);</span><br><span class="line">  Matrix.multiplyMM(modelViewProjection, 0, perspective, 0, modelView, 0);</span><br><span class="line">  drawFloor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Google VR 实现左右眼视觉变形操作。</p>
</li>
<li><p>响应</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Called when the Cardboard trigger is pulled.cardboard上的按钮，或者是屏幕点击事件都可以触发</span><br><span class="line">  */</span><br><span class="line"> @Override</span><br><span class="line"> public void onCardboardTrigger() &#123;</span><br><span class="line">   Log.i(TAG, &quot;onCardboardTrigger&quot;);</span><br><span class="line"></span><br><span class="line">   if (isLookingAtObject()) &#123;如果目标物体在视觉范围内，则</span><br><span class="line">     successSourceId = gvrAudioEngine.createStereoSound(SUCCESS_SOUND_FILE);</span><br><span class="line">     gvrAudioEngine.playSound(successSourceId, false /* looping disabled */);</span><br><span class="line">     hideObject();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // Always give user feedback.</span><br><span class="line">   vibrator.vibrate(50);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>音频</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gvrAudioEngine =</span><br><span class="line">    new GvrAudioEngine(this, GvrAudioEngine.RenderingMode.BINAURAL_HIGH_QUALITY);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>demo主要展示了GvrActivity，GvrView, GvrAudioEngine d的几个基本用法，SDK主要提供了左右眼形变后产生立体效果的这部分功能，已经声音引擎对应的使用，以及头部位置信息动作的封装。</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/02/25/android vr and ar/">Android vr ar</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-25
        </span><span class="post-category">
            <a href="/categories/ANDROID/">ANDROID</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Android-VR-AR"><a href="#Android-VR-AR" class="headerlink" title="Android VR-AR"></a>Android VR-AR</h1><p>如果接下来要做AR眼镜相关的项目，目前需要做一些知识储备。所以本文做为一个项目开始前的准备工作。了解目前已知行业先行者已经实现的技术是已经到了一个什么样的程度后，才知道我们要前进的方向。着重了解Google和目前接触到的一个比较完善的vr-ar系统公司睿悦Niburu。</p>
<h2 id="VR和AR的概念"><a href="#VR和AR的概念" class="headerlink" title="VR和AR的概念"></a>VR和AR的概念</h2><p>VR(Vritual Reality)虚拟现实，最直白的说就是纯虚拟的数字画面。理解起来就是，用户在VR中看到的所有东西都是虚拟的，但是这些虚拟的东西又需要让用户感觉到很真实。</p>
<p>AR(Argumented Reality)增强现实，虚拟数字画面+裸眼现实</p>
<p>此外现在还有一个概念提出来，MR(Mediatd Reality)介导现实，数字化现实+虚拟数字画面</p>
<ul>
<li><p>VR和AR的关系，可以理解为，VR为AR的一种极端情况。即假设我们把人眼的内容分为现实中真实的部分+数字投放的Argumentation（增强）部分。那么如果这种虚拟的部分越来越多以至于一种极端的情况，几乎没有的真实的部分，这种情况下叫：VR。所以这样理解起来，VR是AR的一个真子集。虚拟的东西占了全部，以至于越来越偏离了原来的现实原点。</p>
</li>
<li><p>MR 数字化的视觉感知。对本身现实的感知能力的大小。例如让你有能力看到更小的东西，例如让佩戴者像有了X射线般的超级视力，看到皮肤下的血管？？？超能力！！或者是在现实的景物傻姑娘加以渲染，置身奇幻世界等等。所以MR是视觉能力维度上的提升。</p>
<p><img src="https://pic3.zhimg.com/80/817549fc583ef153904ef2f324e3fa0f_hd.jpg" alt="知乎图示"></p>
<p>他们三者的关系像是：在AR之外，增加了数字化的感知能力。</p>
<p><img src="https://pic4.zhimg.com/80/f208e8d885ed7749c9b1c53988f85593_hd.jpg" alt="知乎图示"></p>
</li>
</ul>
<blockquote>
<p>以上整理自36kr，作者艾韬，易瞳科技CTO，师从Steve Mann。</p>
</blockquote>
<p>为什么不是同心圆，而是有偏离呢？全图其实还有：</p>
<p><img src="http://a.36krcnd.com/nil_class/6d8fab32-010b-4d77-bf31-20af3eb0358e/7B22.tmp.jpg!heading" alt></p>
<p>还有个Mixed，混合现实。如果我们把同心圆的原点认为是真实世界的原点。这几个概念给我们的感受是怎样的？</p>
<h2 id="市面上的AR-VR眼镜"><a href="#市面上的AR-VR眼镜" class="headerlink" title="市面上的AR-VR眼镜"></a>市面上的AR-VR眼镜</h2><ul>
<li>轻量级AR - Google Glass，单眼棱镜光学透视的设计方案，提示型系统</li>
<li>中量级AR - Hololens，双目棱镜光学透视方案，还有例如亮风台</li>
<li>重量级AR - HTC the Void 动态VR 眼镜，头戴VR显示，背上电脑，将真实的环境渲染成游戏场景。</li>
<li>纯VR - VR头盔</li>
</ul>
<h2 id="Google-VR-做了什么"><a href="#Google-VR-做了什么" class="headerlink" title="Google VR 做了什么"></a>Google VR 做了什么</h2><ul>
<li><p>DayDream</p>
<blockquote>
<p>Daydream是由谷歌2016年11月10日发布的一个vr平台，由一个头盔，一个控制杆盒很多兼容的智能手机组成。</p>
</blockquote>
<p><img src="http://7xl98n.com1.z0.glb.clouddn.com/QQ20180225-151253@2x.png" alt></p>
<p>我们可以使用google提供的VR SDK来开发Daydream app</p>
<ul>
<li><p>硬件</p>
<p>Daydream 或者 cardboard</p>
<p><img src="http://7xl98n.com1.z0.glb.clouddn.com/QQ20180225-153056@2x.png" alt></p>
</li>
<li><p>软件</p>
<p>android studio，Nougat（API 25）or higher, Google VR SDK</p>
</li>
<li><p>VR SDK sample</p>
<p>sdk-treasurehunt：示例应用，可以展示搜索和搜集物品。</p>
<p>sdk-controllerclient     主要演示接收和处理daydream的控制输入</p>
<p>sdk-simplepanowidget     可以载入全景视图的组件<br>sdk-simplevideowidget     可以渲染360度视频的视图组件 VRView<br>sdk-video360     可以渲染360度视频的视图组件，在可支持的手机上运行vr效果的播放器时候，<strong>屏幕会闪烁</strong><br>sdk-videoplayer     通过 Asynchronous Reprojection Video Surface API来播放视频，</p>
</li>
<li><p>Treasure Hunt 示例应用演练</p>
<p>这个应用体现的Google VR SDK的核心功能：<strong>Stereo rendering</strong> 立体渲染，将app的view进行立体渲染，从而创造出3D的体验；<strong>Spatial audio</strong> 空间音效，制造出声音从不同地方出来的效果，增强现实体验；<strong>Head movement tracking</strong>根据头部动作，更新视图；<strong>User input</strong>用户输入响应，接收Daydream controller或者Cardboard 按钮的输入。</p>
<p><em>Todo: <a href="https://developers.google.com/vr/android/samples/treasure-hunt" target="_blank" rel="noopener">Treasure Hunt walkthrough</a> 详细走一遍sample的代码</em> </p>
</li>
<li><p>开发GoogleVR项目步骤</p>
<ol>
<li><p>配置项目等级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// The Google VR SDK requires version 2.3.3 or higher.</span><br><span class="line">    classpath &apos;com.android.tools.build:gradle:2.3.3&apos;</span><br><span class="line"></span><br><span class="line">    // The Google VR NDK requires experimental version 0.9.3 or higher.</span><br><span class="line">    // classpath &apos;com.android.tools.build:gradle-experimental:0.9.3&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加依赖库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">     // Adds Google VR spatial audio support</span><br><span class="line">     compile &apos;com.google.vr:sdk-audio:1.80.0&apos;</span><br><span class="line"></span><br><span class="line">     // Required for all Google VR apps</span><br><span class="line">     compile &apos;com.google.vr:sdk-base:1.80.0&apos;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置ProGuard</p>
<p>如果需要使用proguard来减小apk文件大小的话，需要添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled true</span><br><span class="line">            proguardFiles.add(file(&apos;../../proguard-gvr.txt&apos;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来需要哪些知识储备：</p>
<ul>
<li><p>浏览一遍谷歌VR示例代码 Treasure Hunt，寻宝游戏</p>
</li>
<li><p>GoogleVRSDK视频和全景图片示例应用</p>
</li>
<li><p>GoogleVR设计和开发准则</p>
</li>
<li><p>android空间音频效果开发向导</p>
</li>
<li><p>Google VR API</p>
</li>
<li><p>Daydream，学习Daydream用户交互控制器相关操作，可查看Review the controller library in <strong>gvr-android-sdk</strong> &gt; <strong>libraries</strong> &gt;<br>  <strong>sdk-controller</strong> ，查阅 库api 控制器 API</p>
<blockquote>
<p>原文链接如下：</p>
</blockquote>
</li>
<li><p><a href="https://developers.google.com/vr/android/samples/treasure-hunt" target="_blank" rel="noopener">Treasure Hunt sample code walkthrough</a></p>
</li>
<li><p><a href="https://developers.google.com/vr/android/samples/vrview" target="_blank" rel="noopener">Google VR SDK video and panoramic image sample app walkthrough</a></p>
</li>
<li><p>Learn about Google VR design and development principles in <a href="https://developers.google.com/vr/elements/overview" target="_blank" rel="noopener">Daydream elements</a>.</p>
</li>
<li><p><a href="https://developers.google.com/vr/android/spatial-audio" target="_blank" rel="noopener">Spatial audio for Android tutorial</a></p>
</li>
<li><p><a href="https://developers.google.com/vr/android/reference_overview" target="_blank" rel="noopener">Google VR API Reference</a></p>
</li>
<li><p>Daydream:</p>
<p> Learn about implementing Daydream controller user interactions   in your app:</p>
<ul>
<li>Review the controller library in <strong>gvr-android-sdk</strong> &gt; <strong>libraries</strong> &gt;  <strong>sdk-controller</strong>.</li>
<li>See also the <a href="https://developers.google.com/vr/android/reference/com/google/vr/sdk/controller/package-summary" target="_blank" rel="noopener">controller library API reference</a>.</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>Tilt Brush</p>
<p>3d空间绘画</p>
<p>Oculus Rift and HTC VIVE可支持该功能。</p>
<p>都是vr头戴式设备</p>
<p>​</p>
</li>
<li><p>Earth VR</p>
<p>vr 视角来查看一些风景名胜</p>
</li>
<li><p>Cardboard</p>
</li>
<li><p>Expeditions</p>
<p>教育类相关，旅行远征，例如体验在火星表面，老师可以带着孩子进行更有沉浸式的体验</p>
</li>
<li><p>Jump</p>
<p>Jump is Google’s professional VR video solution. Jump makes 3D-360 video<br> production at scale possible with best-in-class automated stitching.<br>Jump cameras are designed to work with the Jump Assembler to enable<br>seamless VR video production.</p>
<p>一系列的摄像头产品，用于拍摄全景视频，自动缝合技术，实现</p>
</li>
<li><p>Developers</p>
</li>
</ul>
<h2 id="Google-AR-提供了什么"><a href="#Google-AR-提供了什么" class="headerlink" title="Google AR 提供了什么"></a>Google AR 提供了什么</h2><p><a href="https://developers.google.com/ar/discover/" target="_blank" rel="noopener">https://developers.google.com/ar/discover/</a></p>
<p>ARCore 是一个用于在 Android 上构建增强现实应用的平台。ARCore 使用三个主要技术将虚拟内容与通过手机摄像头看到的现实世界整合：</p>
<ul>
<li><a href="https://developers.google.com/ar/discover/concepts#motion_tracking" target="_blank" rel="noopener"><strong>运动跟踪</strong></a>让手机可以理解和跟踪它相对于现实世界的位置。</li>
<li><a href="https://developers.google.com/ar/discover/concepts#environmental_understanding" target="_blank" rel="noopener"><strong>环境理解</strong></a>让手机可以检测平坦水平表面（例如地面或咖啡桌）的大小和位置。</li>
<li><a href="https://developers.google.com/ar/discover/concepts#light_estimation" target="_blank" rel="noopener"><strong>光估测</strong></a>让手机可以估测环境当前的光照条件。</li>
</ul>
<h3 id="ARCore基本工作原理"><a href="#ARCore基本工作原理" class="headerlink" title="ARCore基本工作原理"></a>ARCore基本工作原理</h3><blockquote>
<p>ARCore 在做两件事：在移动设备移动时跟踪它的位置和构建自己对现实世界的理解。</p>
<p>ARCore 的运动跟踪技术使用手机摄像头标识兴趣点（称为特征点），并跟踪这些点随着时间变化的移动。将这些点的移动与手机惯性传感器的读数组合，ARCore 可以在手机移动时确定它的位置和屏幕方向。</p>
<p>除了标识关键点外，ARCore 还会检测平坦的表面（例如桌子或地面），并估测周围区域的平均光照强度。 这些功能共同让 ARCore 可以构建自己对周围世界的理解。</p>
<p>借助 ARCore 对现实世界的理解，您能够以一种与现实世界无缝整合的方式添加物体、注释或其他信息。 您可以将一只打盹的小猫放在咖啡桌的一角，或者利用艺术家的生平信息为一幅画添加注释。 运动跟踪意味着您可以移动和从任意角度查看这些物体，即使您转身离开房间，当您回来后，小猫或注释还会在您添加的地方。</p>
</blockquote>
<h3 id="Arcore-SDK概览"><a href="#Arcore-SDK概览" class="headerlink" title="Arcore SDK概览"></a>Arcore SDK概览</h3><h4 id="Hello-AR-java"><a href="#Hello-AR-java" class="headerlink" title="Hello AR java"></a>Hello AR java</h4><p>需要android 7.0以上，需要安装arcore</p>
<ul>
<li><p>清单文件，声明需要android.hardware.camera.ar，且需要安装Arcore，文件表明应用在Google的应用市场上只能在支持arcore的设备上可见</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</span><br><span class="line">    package=&quot;com.google.ar.core.examples.java.helloar&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;</span><br><span class="line">  &lt;!-- This tag indicates that this application requires ARCore.  This results in the application</span><br><span class="line">       only being visible in the Google Play Store on devices that support ARCore. --&gt;</span><br><span class="line">  &lt;uses-feature android:name=&quot;android.hardware.camera.ar&quot; android:required=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;application</span><br><span class="line">      android:allowBackup=&quot;false&quot;</span><br><span class="line">      android:icon=&quot;@drawable/ic_launcher&quot;</span><br><span class="line">      android:label=&quot;@string/app_name&quot;</span><br><span class="line">      android:theme=&quot;@style/AppTheme&quot;</span><br><span class="line">      android:usesCleartextTraffic=&quot;false&quot;</span><br><span class="line">      tools:ignore=&quot;GoogleAppIndexingWarning&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=&quot;.HelloArActivity&quot;</span><br><span class="line">        android:label=&quot;@string/app_name&quot;</span><br><span class="line">        android:configChanges=&quot;orientation|screenSize&quot;</span><br><span class="line">        android:exported=&quot;true&quot;</span><br><span class="line">        android:theme=&quot;@style/Theme.AppCompat.NoActionBar&quot;</span><br><span class="line">        android:screenOrientation=&quot;locked&quot;&gt;</span><br><span class="line">      &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;</span><br><span class="line">        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;</span><br><span class="line">      &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/activity&gt;</span><br><span class="line">    &lt;!-- 需要安装arcore --&gt;</span><br><span class="line">    &lt;meta-data android:name=&quot;com.google.ar.core&quot; android:value=&quot;required&quot; /&gt;</span><br><span class="line">  &lt;/application&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="computevision"><a href="#computevision" class="headerlink" title="computevision"></a>computevision</h4><ul>
<li><p>清单文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    xmlns:tools=&quot;http://schemas.android.com/tools&quot;</span><br><span class="line">    package=&quot;com.google.ar.core.examples.java.computervision&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;application</span><br><span class="line">      android:allowBackup=&quot;false&quot;</span><br><span class="line">      android:icon=&quot;@drawable/ic_launcher&quot;</span><br><span class="line">      android:label=&quot;@string/app_name&quot;</span><br><span class="line">      android:theme=&quot;@style/AppTheme&quot;</span><br><span class="line">      android:usesCleartextTraffic=&quot;false&quot;</span><br><span class="line">      tools:ignore=&quot;GoogleAppIndexingWarning&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;activity</span><br><span class="line">        android:name=&quot;.MainActivity&quot;</span><br><span class="line">        android:label=&quot;@string/app_name&quot;</span><br><span class="line">        android:configChanges=&quot;orientation|screenSize&quot;</span><br><span class="line">        android:exported=&quot;true&quot;</span><br><span class="line">        android:theme=&quot;@style/Theme.AppCompat.NoActionBar&quot;</span><br><span class="line">        android:screenOrientation=&quot;locked&quot;&gt;</span><br><span class="line">      &lt;intent-filter&gt;</span><br><span class="line">        &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;</span><br><span class="line">        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;</span><br><span class="line">      &lt;/intent-filter&gt;</span><br><span class="line">    &lt;/activity&gt;</span><br><span class="line">  &lt;/application&gt;</span><br><span class="line">&lt;/manifest&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>TODO: ARdemo walkthrough</p>
</blockquote>
<p>Api 查阅</p>
<ul>
<li><a href="https://developers.google.com/ar/reference/java/com/google/ar/core/package-summary" target="_blank" rel="noopener">com.google.ar.core</a> ARCore API implementation.</li>
<li><a href="https://developers.google.com/ar/reference/java/com/google/ar/core/exceptions/package-summary" target="_blank" rel="noopener">com.google.ar.core.exceptions</a> ARCore exceptions.</li>
</ul>
<h3 id="如何启用ARCore"><a href="#如何启用ARCore" class="headerlink" title="如何启用ARCore"></a>如何启用ARCore</h3><h4 id="清单文件配置"><a href="#清单文件配置" class="headerlink" title="清单文件配置"></a>清单文件配置</h4><ul>
<li><p>AR only: 以下定义表示应用只能在支持android.hardware.camera.ar，且安装了com.google.ar.core的设备上运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-sdk android:minSdkVersion=&quot;&#123;24 or higher&#125;&quot; /&gt;</span><br><span class="line">24以上版本</span><br><span class="line">  ...</span><br><span class="line">  &lt;uses-feature android:name=&quot;android.hardware.camera.ar&quot; android:required=&quot;true&quot; /&gt;</span><br><span class="line"></span><br><span class="line">  &lt;application&gt;</span><br><span class="line">    ...</span><br><span class="line">        &lt;meta-data android:name=&quot;com.google.ar.core&quot; android:value=&quot;required&quot; /&gt;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>AR可选，表示可以在不支持AR Core的设备上运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-sdk android:minSdkVersion=&quot;&#123;14 or higher&#125;&quot; /&gt;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  &lt;application&gt;</span><br><span class="line">    ...</span><br><span class="line">        &lt;meta-data android:name=&quot;com.google.ar.core&quot; android:value=&quot;optional&quot; /&gt;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>确认已经在项目的  <code>build.gradle</code> 文件中添加了 Google’s Maven 仓库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">repositories &#123;</span><br><span class="line">    google()</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>添加 ARCore 库依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    // ARCore library</span><br><span class="line">    implementation &apos;com.google.ar:core:1.0.0&apos;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Gradle会自动的将ARcore中的标签合并到应用的清单文件中。</p>
</blockquote>
<h4 id="执行运行时检查"><a href="#执行运行时检查" class="headerlink" title="执行运行时检查"></a>执行运行时检查</h4><p>确认是否已安装ARcore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// Set to true ensures requestInstall() triggers installation if necessary.</span><br><span class="line">private boolean mUserRequestedInstall = true;</span><br><span class="line"></span><br><span class="line">// in onResume:</span><br><span class="line">try &#123;</span><br><span class="line">  if (mSession == null) &#123;</span><br><span class="line">    switch (ArCoreApk.getInstance().requestInstall(this, mUserRequestedInstall)) &#123;</span><br><span class="line">      case INSTALLED:</span><br><span class="line">        mSession = new Session(this);</span><br><span class="line">        // Success.</span><br><span class="line">        break;</span><br><span class="line">      case INSTALL_REQUESTED:</span><br><span class="line">        // Ensures next invocation of requestInstall() will either return</span><br><span class="line">        // INSTALLED or throw an exception.</span><br><span class="line">        mUserRequestedInstall = false;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; catch (UnavailableUserDeclinedInstallException e) &#123;</span><br><span class="line">  // Display an appropriate message to the user and return gracefully.</span><br><span class="line">  return;</span><br><span class="line">&#125; catch (...) &#123;  // current catch statements</span><br><span class="line">  ...</span><br><span class="line">  return;  // mSession is still null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Activity resume的时候，执行session创建，如果创建不成功，则请求安装，</p>
<p>检查是否支持AR core，可选方案的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void maybeEnableArButton() &#123;</span><br><span class="line">  // Likely called from Activity.onCreate() of an activity with AR buttons.</span><br><span class="line">  ArAvailability availability = ArCoreApk.getInstance().checkAvailability(this);</span><br><span class="line">  if (availability.isTransient()) &#123;</span><br><span class="line">    // re-query at 5Hz while we check compatibility.</span><br><span class="line">    new Handler().postDelayed(new Runnable() &#123;</span><br><span class="line">      @Override</span><br><span class="line">      public void run() &#123;</span><br><span class="line">        maybeEnableArButton();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, 200);</span><br><span class="line">  &#125;</span><br><span class="line">  if (availability.isSupported()) &#123;</span><br><span class="line">    mArButton.setVisibility(VISIBLE);</span><br><span class="line">    mArButton.setEnabled(true);</span><br><span class="line">    // indicator on the button.</span><br><span class="line">  &#125; else &#123; // unsupported or unknown</span><br><span class="line">    mArButton.setVisibility(HIDDEN);</span><br><span class="line">    mArButton.setEnabled(false);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>checkAvailability可能需要联网检查</p>
</blockquote>
<h2 id="Google-VR-AR-在现有平台上的运行情况"><a href="#Google-VR-AR-在现有平台上的运行情况" class="headerlink" title="Google VR AR 在现有平台上的运行情况"></a>Google VR AR 在现有平台上的运行情况</h2><ol>
<li><p>寻宝游戏，demo 代码根据vr提供的sdk实现了左右分屏的这种效果，也就是说只要运行在普通的安卓手机上，在屏幕上，就可以看到一个左右分屏显示的功能，然后如果配合Google 的cardboard viewer 或者是 Daydream viewer 是可以直接在眼睛上实现3D显示的。那这个demo在我们的820+眼镜上的运行效果就是。在切换到2D模式的时候，我们看到的就是两个左右的图片，切换到3d的时候，确实可以实现看到一个叠加的图片，但是这个叠加后的有些变形。</p>
</li>
<li><p>Google vr播放器，需要在7.0以上版本运行，2d的播放器可以在5516上运行，但要切换成3D模式的时候，提示手机与Daydream不兼容；在pixel一些指定的兼容设备上才可运行，但是运行起来感觉屏幕闪烁较为明显，需要配合daydream屏体的控制器运行观看</p>
</li>
<li><p>ARcore支持的设备：</p>
<blockquote>
<p>Asus Zenfone AR</p>
<p>LG V30</p>
<p>Google Pixel</p>
<p>OnePlus 5</p>
<p>Samsung Galaxy</p>
</blockquote>
<p>在可支持的设备上，<strong>hello ar</strong>运行的起来就是一个摄像头应用，在识别平坦桌面后，可以放置android玩偶，然后移动相机，可以实现，各种视角查看玩偶。就想真实存在的物体一样。</p>
<p>5516无法支持ARcore</p>
<p><strong>computevision</strong> 纹理阅读，可识别物体纹理</p>
</li>
</ol>
<h2 id="如何兼容Google-VR-AR"><a href="#如何兼容Google-VR-AR" class="headerlink" title="如何兼容Google VR AR"></a>如何兼容Google VR AR</h2><ul>
<li><p>VR、 Daydream</p>
<p><uses-feature android:name="android.software.vr.mode" android:required="false">和<uses-feature android:name="android.hardware.vr.high_performance" android:required="false"> 由 Android N加入的新特性，前者表示需要使用Android VR模式，后者表示需要可支持Daydream的设备。</uses-feature></uses-feature></p>
<p>对于没有Google VR服务的设备，需要安装Google VR 服务，才可以将可支持Daydream的设备与对应的VR viewer配对</p>
</li>
</ul>
<ul>
<li><p>AR</p>
 <uses-feature android:name="android.hardware.camera.ar" android:required="true">

<p>另外需要安装ARcore</p>
</uses-feature></li>
</ul>
<h2 id="Nibiru-系统"><a href="#Nibiru-系统" class="headerlink" title="Nibiru 系统"></a>Nibiru 系统</h2><h2 id="Nibiru-VR"><a href="#Nibiru-VR" class="headerlink" title="Nibiru VR"></a>Nibiru VR</h2><ul>
<li><p>Nibiru studio</p>
<blockquote>
<p>面向VR应用开发者，开发者无需OpenGL基础，无需写<br>shader和计算矩阵，极大地简化了VR应用开发流程。并且<br>支持Head Tracking和Raycast交互方式，以及具有完善的<br>事件系统。定义了功能丰富的VR控件与组件集合，在功能点<br>上涵盖了Image、Label、Skybox、Listview、<br>ProgressBar Gridview等核心控件，同时支持播放、图片、<br>浏览器等组件。</p>
</blockquote>
</li>
<li><p>demo运行</p>
<p>新建一个空的项目，选择 file-new-import module，选择模块源码位置，点击finish，完成倒入</p>
<p>需要睿悦的os。</p>
<p>demo展示的主要展示了基于睿悦系统的一些基本控件的使用，基于睿悦系统的头部运动操作和响应，以及对系统设置Wi-Fi、蓝牙等系统界面的调用。</p>
<p>整体体验起来，空间立体的感觉还不够，似乎只是一个2d界面，经过3d左右分屏处理后，融合sensor之后的附加的交互而已。立体渲染部分比较少，给人的空间感体验较差。</p>
</li>
</ul>
<h2 id="Nibiru-AR"><a href="#Nibiru-AR" class="headerlink" title="Nibiru AR"></a>Nibiru AR</h2><p>目前就demo而言，AR的特性体现的比较少。</p>
<h2 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h2><p>游戏与VR/AR开发引擎。</p>
<h2 id="Unreal"><a href="#Unreal" class="headerlink" title="Unreal"></a>Unreal</h2><p><a href="https://www.zhihu.com/question/20116279" target="_blank" rel="noopener">https://www.zhihu.com/question/20116279</a> 知乎上关于unity和unreal两个平台的对比</p>
<p>TODO: 体验一下</p>

        </div></article>
      <nav class="pagination"><a class="prev" href="/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    <a class="next" href="/page/3/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">lynn8570</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
