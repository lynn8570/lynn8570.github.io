<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="android"><meta name="keywords" content="android"><link rel="alternate" href="/default" title="Lynn8570's Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="https://lynn8570.github.io/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css">
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true,"latex":false};
</script>

    <title>Lynn8570's Blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Lynn8570's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Lynn8570's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><section id="posts" class="posts"><article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2020/01/10/add-flutter-to-android/">add flutter to android</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2020-01-10
        </span></div>
    </header>

    <div class="post-content"><p>根据 <a href="https://flutter.dev/docs/development/add-to-app" target="_blank" rel="noopener">https://flutter.dev/docs/development/add-to-app</a> 中的步骤，在现有的应用中添加flutter模块</p>
<p>准备工作：</p>
<p>Android studio要升级到3.6，flutter插件要是42以上的</p>
<ol>
<li><h3 id="File-new-module-选择flutter-module，这样就可以生成一个flutter模块"><a href="#File-new-module-选择flutter-module，这样就可以生成一个flutter模块" class="headerlink" title="File-new module 选择flutter module，这样就可以生成一个flutter模块"></a>File-new module 选择flutter module，这样就可以生成一个flutter模块</h3></li>
<li><h3 id="向应用中添加并启动flutter页面"><a href="#向应用中添加并启动flutter页面" class="headerlink" title="向应用中添加并启动flutter页面"></a>向应用中添加并启动flutter页面</h3><ol>
<li><p>先初始化flutter在application中<br><code>FlutterMain.startInitialization(this);</code></p>
</li>
<li><p>启动默认页面</p>
<p><code>startActivity(FlutterActivity.createDefaultIntent(activity!!))</code></p>
</li>
<li><p>添加依赖 <code>implementation &#39;android.arch.lifecycle:common-java8:1.1.1&#39;</code></p>
</li>
</ol>
</li>
<li><p>错误记录</p>
<ol>
<li><p>错误: 程序包android.support.annotation不存在</p>
<p>修正：将对  android.support.annotation.NonNull; 的改为Androidx <code>androidx.fragment.app.Fragment;</code></p>
<p><code>androidx.annotation.NonNull;</code><br><code>import androidx.lifecycle.Lifecycle;</code><br><code>import androidx.lifecycle.LifecycleObserver;</code><br><code>import androidx.lifecycle.OnLifecycleEvent;</code></p>
</li>
<li><p>错误：未初始化flutter</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unable to start activity ComponentInfo&#123;com.magefitness.app/io.flutter.embedding.android.FlutterActivity&#125;: java.lang.IllegalStateException: ensureInitializationComplete must be called after startInitialization</span><br></pre></td></tr></table></figure>

<p>修正flutter未初始化，在application中<code>FlutterMain.startInitialization(this);</code>  </p>
</li>
</ol>
</li>
</ol>
<ol start="3">
<li><p>未添加 <code>implementation &#39;android.arch.lifecycle:common-java8:1.1.1&#39;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed resolution of: Lio/flutter/embedding/engine/FlutterEngineAndroidLifecycle$1;</span><br></pre></td></tr></table></figure>


</li>
</ol>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2019/06/29/hello-world/">Hello World</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-06-29
        </span></div>
    </header>

    <div class="post-content"><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/05/31/tensorflow/">TensorFlow Android walkthrough</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-31
        </span><span class="post-category">
            <a href="/categories/TensorFlow/">TensorFlow</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>【链接】tensorflow/tensorflow<br><a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/android" target="_blank" rel="noopener">https://github.com/tensorflow/tensorflow/tree/master/tensorflow/examples/android</a></p>
<h1 id="用pip-安装tensor-flow"><a href="#用pip-安装tensor-flow" class="headerlink" title="用pip 安装tensor flow"></a>用pip 安装tensor flow</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-1.0.0-py3-none-any.whl</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pip3 install --upgrade https://storage.googleapis.com/tensorflow/mac/tensorflow-0.6.0-py3-none-any.whl</span><br><span class="line"></span><br><span class="line"> Downloading https://storage.googleapis.com/tensorflow/mac/tensorflow-0.6.0-py3-none-any.whl (10.2MB)</span><br><span class="line">    100% |████████████████████████████████| 10.3MB 1.9MB/s </span><br><span class="line">Collecting numpy&gt;=1.8.2 (from tensorflow==0.6.0)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/8e/75/7a8b7e3c073562563473f2a61bd53e75d0a1f5e2047e576ee61d44113c22/numpy-1.14.3-cp36-cp36m-macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.macosx_10_10_intel.macosx_10_10_x86_64.whl (4.7MB)</span><br><span class="line">    100% |████████████████████████████████| 4.7MB 832kB/s </span><br><span class="line">Collecting protobuf==3.0.0a3 (from tensorflow==0.6.0)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/d7/92/34c5810fa05e98082d141048110db97d2f98d318fa96f8202bf146ab79de/protobuf-3.0.0a3.tar.gz (88kB)</span><br><span class="line">    100% |████████████████████████████████| 92kB 18.6MB/s </span><br><span class="line">Requirement not upgraded as not directly required: wheel&gt;=0.26 in ./venv/lib/python3.6/site-packages (from tensorflow==0.6.0) (0.31.1)</span><br><span class="line">Collecting six&gt;=1.10.0 (from tensorflow==0.6.0)</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/67/4b/141a581104b1f6397bfa78ac9d43d8ad29a7ca43ea90a2d863fe3056e86a/six-1.11.0-py2.py3-none-any.whl</span><br><span class="line">Requirement not upgraded as not directly required: setuptools in ./venv/lib/python3.6/site-packages (from protobuf==3.0.0a3-&gt;tensorflow==0.6.0) (39.1.0)</span><br><span class="line">Building wheels for collected packages: protobuf</span><br><span class="line">  Running setup.py bdist_wheel for protobuf ... done</span><br><span class="line">  Stored in directory: /Users/zowee-laisc/Library/Caches/pip/wheels/07/0a/98/ca8fbec7368a85849700304bf0cf40d2d8e183f9a5dd136795</span><br><span class="line">Successfully built protobuf</span><br><span class="line">Installing collected packages: numpy, protobuf, six, tensorflow</span><br><span class="line">Successfully installed numpy-1.14.3 protobuf-3.0.0a3 six-1.11.0 tensorflow-0.6.0</span><br><span class="line">(venv) zowee-laiscdeMacBook-Pro:tensorflow zowee-laisc$</span><br></pre></td></tr></table></figure>

<p>就这么简单，然后测试环境ok</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(venv) zowee-laiscdeMacBook-Pro:tensorflow zowee-laisc$ python</span><br><span class="line">Python 3.6.4 (v3.6.4:d48ecebad5, Dec 18 2017, 21:07:28) </span><br><span class="line">[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; import tensorflow as tf</span><br><span class="line">&gt;&gt;&gt; hello = tf.constant(&apos;hello tensorflow&apos;)</span><br><span class="line">&gt;&gt;&gt; sess = tf.Session()</span><br><span class="line">I tensorflow/core/common_runtime/local_device.cc:40] Local device intra op parallelism threads: 4</span><br><span class="line">I tensorflow/core/common_runtime/direct_session.cc:58] Direct session inter op parallelism threads: 4</span><br><span class="line">&gt;&gt;&gt; print(sess.run(hello))</span><br><span class="line">b&apos;hello tensorflow&apos;</span><br><span class="line">&gt;&gt;&gt; a = tf.constant(10)</span><br><span class="line">&gt;&gt;&gt; b = tf.constant(32)</span><br><span class="line">&gt;&gt;&gt; print(sess.run(a+b))</span><br><span class="line">42</span><br><span class="line">&gt;&gt;&gt; exit();</span><br></pre></td></tr></table></figure>

<p>python3运行起来有些问题，后面把环境换成python2.7了，</p>
<p>Pycharm 配置python版本为 2.7，然后激活虚拟环境即可。</p>
<h1 id="android-的环境"><a href="#android-的环境" class="headerlink" title="android 的环境"></a>android 的环境</h1><h2 id="下载GitHub-源码"><a href="#下载GitHub-源码" class="headerlink" title="下载GitHub 源码"></a>下载GitHub 源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --recurse-submodules https://github.com/tensorflow/tensorflow.git</span><br></pre></td></tr></table></figure>

<p>将example下的Android目录作为项目根目录，用android studio直接打开就可以了</p>
<p>将buildsystem改为 cmake，编译。</p>
<h2 id="Android-demo-walkthrough"><a href="#Android-demo-walkthrough" class="headerlink" title="Android demo walkthrough"></a>Android demo walkthrough</h2><h3 id="归类识别classifier"><a href="#归类识别classifier" class="headerlink" title="归类识别classifier"></a>归类识别classifier</h3><p>ClassifierActivity 用于识别分类的，继承了基础类CameraActivity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class ClassifierActivity extends CameraActivity implements OnImageAvailableListener &#123;</span><br></pre></td></tr></table></figure>

<p>其中CameraActivity封装了一些camera的操作</p>
<p>先查看下CameraActivity的代码</p>
<p>在onCreate的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onCreate(final Bundle savedInstanceState) &#123;</span><br><span class="line">  LOGGER.d(&quot;onCreate &quot; + this);</span><br><span class="line">  super.onCreate(null);</span><br><span class="line">  //设置屏幕常亮，只要给该window对用户可见的时候，保持屏幕亮屏</span><br><span class="line">  getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span><br><span class="line"></span><br><span class="line">  setContentView(R.layout.activity_camera);</span><br><span class="line">  if (hasPermission()) &#123;</span><br><span class="line">    setFragment();</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    requestPermission();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中setFragment()</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">protected void setFragment() &#123;</span><br><span class="line">    String cameraId = chooseCamera();//选择合适的camera</span><br><span class="line">    if (cameraId == null) &#123;</span><br><span class="line">      Toast.makeText(this, &quot;No Camera Detected&quot;, Toast.LENGTH_SHORT).show();</span><br><span class="line">      finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Fragment fragment;</span><br><span class="line">    if (useCamera2API) &#123;//true 初始化fragment</span><br><span class="line">      CameraConnectionFragment camera2Fragment =</span><br><span class="line">          CameraConnectionFragment.newInstance(</span><br><span class="line">              new CameraConnectionFragment.ConnectionCallback() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onPreviewSizeChosen(final Size size, final int rotation) &#123;</span><br><span class="line">                  Log.i(&quot;linlian&quot;,&quot;useCamera2API onPreviewSizeChosen=&quot;);</span><br><span class="line">                  previewHeight = size.getHeight();</span><br><span class="line">                  previewWidth = size.getWidth();</span><br><span class="line">                  CameraActivity.this.onPreviewSizeChosen(size, rotation);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              this,</span><br><span class="line">              getLayoutId(),</span><br><span class="line">              getDesiredPreviewFrameSize());</span><br><span class="line"></span><br><span class="line">      camera2Fragment.setCamera(cameraId);</span><br><span class="line">      fragment = camera2Fragment;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      fragment =</span><br><span class="line">          new LegacyCameraConnectionFragment(this, getLayoutId(), getDesiredPreviewFrameSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   //将合适的fragment添加到Activity中</span><br><span class="line">    getFragmentManager()</span><br><span class="line">        .beginTransaction()</span><br><span class="line">        .replace(R.id.container, fragment)</span><br><span class="line">        .commit();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中CameraConnectionFragment，对应布局为<code>protected int getLayoutId() {  return R.layout.camera_connection_fragment;}</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;RelativeLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;org.tensorflow.demo.AutoFitTextureView</span><br><span class="line">        android:id=&quot;@+id/texture&quot;</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_alignParentBottom=&quot;true&quot; /&gt; </span><br><span class="line"></span><br><span class="line">    &lt;org.tensorflow.demo.RecognitionScoreView</span><br><span class="line">        android:id=&quot;@+id/results&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;112dp&quot;</span><br><span class="line">        android:layout_alignParentTop=&quot;true&quot; /&gt; 用于显示类别 在顶部</span><br><span class="line"></span><br><span class="line">    &lt;org.tensorflow.demo.OverlayView</span><br><span class="line">        android:id=&quot;@+id/debug_overlay&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:layout_alignParentBottom=&quot;true&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure>

<p>RecognitionScoreView 自定义控件用于显示识别结果<code>canvas.drawText(recog.getTitle() + &quot;: &quot; + recog.getConfidence(), x, y, fgPaint);</code></p>
<p>OverlayView 简单的提供回调的view，例如调试的时候，可用于显示调试中的图像等。</p>
<p>AutoFitTextureView 继承 TextureView</p>
<p>TextureView可用于显示流内容，可以是视频或者OpenGL场景。</p>
<p>surfaceview 窗口的工作方式是创建一个置于应用窗口之后的新窗口，效率高，因为刷新新窗口的时候，不需要重新绘制应用程序的窗口，但是surfaceview不在应用窗口上，所以不能使用view.setAlpha()之类的变换。也很难放在list view或者scrollview中。</p>
<p>Textureview在Android4.0引入，来解决上述问题，textureview必须在硬件加速器中开启。</p>
<p>AutoFitTextureView 在Textureview的基础上添加的长宽适应的功能。</p>
<p>Textureview主要用法设置 <code>TextureView.SurfaceTextureListener</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * &#123;@link android.view.TextureView.SurfaceTextureListener&#125; handles several lifecycle events on a</span><br><span class="line">   * &#123;@link TextureView&#125;.</span><br><span class="line">   */</span><br><span class="line">  private final TextureView.SurfaceTextureListener surfaceTextureListener =</span><br><span class="line">      new TextureView.SurfaceTextureListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureAvailable(//初始化</span><br><span class="line">            final SurfaceTexture texture, final int width, final int height) &#123;</span><br><span class="line">          openCamera(width, height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureSizeChanged(//size 变化时候</span><br><span class="line">            final SurfaceTexture texture, final int width, final int height) &#123;</span><br><span class="line">          configureTransform(width, height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean onSurfaceTextureDestroyed(final SurfaceTexture texture) &#123;</span><br><span class="line">          return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onSurfaceTextureUpdated(final SurfaceTexture texture) &#123;&#125;</span><br><span class="line">      &#125;;</span><br></pre></td></tr></table></figure>

<p>打开摄像头，配置最合适的preview size</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Opens the camera specified by &#123;@link CameraConnectionFragment#cameraId&#125;.</span><br><span class="line">  */</span><br><span class="line"> private void openCamera(final int width, final int height) &#123;</span><br><span class="line">   setUpCameraOutputs();//设置预览大小</span><br><span class="line">   configureTransform(width, height);//旋转偏移量</span><br><span class="line">   final Activity activity = getActivity();</span><br><span class="line">   final CameraManager manager = (CameraManager) activity.getSystemService(Context.CAMERA_SERVICE);</span><br><span class="line">   try &#123;</span><br><span class="line">     if (!cameraOpenCloseLock.tryAcquire(2500, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">       throw new RuntimeException(&quot;Time out waiting to lock camera opening.&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     manager.openCamera(cameraId, stateCallback, backgroundHandler);//打开camera</span><br><span class="line">   &#125; catch (final CameraAccessException e) &#123;</span><br><span class="line">     LOGGER.e(e, &quot;Exception!&quot;);</span><br><span class="line">   &#125; catch (final InterruptedException e) &#123;</span><br><span class="line">     throw new RuntimeException(&quot;Interrupted while trying to lock camera opening.&quot;, e);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>stateCallback</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * &#123;@link android.hardware.camera2.CameraDevice.StateCallback&#125;</span><br><span class="line">  * is called when &#123;@link CameraDevice&#125; changes its state.</span><br><span class="line">  */</span><br><span class="line"> private final CameraDevice.StateCallback stateCallback =</span><br><span class="line">     new CameraDevice.StateCallback() &#123;</span><br><span class="line">       @Override</span><br><span class="line">       public void onOpened(final CameraDevice cd) &#123;</span><br><span class="line">         // This method is called when the camera is opened.  We start camera preview here.</span><br><span class="line">         cameraOpenCloseLock.release();</span><br><span class="line">         cameraDevice = cd;</span><br><span class="line">         createCameraPreviewSession();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onDisconnected(final CameraDevice cd) &#123;</span><br><span class="line">         cameraOpenCloseLock.release();</span><br><span class="line">         cd.close();</span><br><span class="line">         cameraDevice = null;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       public void onError(final CameraDevice cd, final int error) &#123;</span><br><span class="line">         cameraOpenCloseLock.release();</span><br><span class="line">         cd.close();</span><br><span class="line">         cameraDevice = null;</span><br><span class="line">         final Activity activity = getActivity();</span><br><span class="line">         if (null != activity) &#123;</span><br><span class="line">           activity.finish();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure>

<p>backgroundThread</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Starts a background thread and its &#123;@link Handler&#125;.</span><br><span class="line">  */</span><br><span class="line"> private void startBackgroundThread() &#123;//在onresume的时候被调用</span><br><span class="line">   backgroundThread = new HandlerThread(&quot;ImageListener&quot;);</span><br><span class="line">   backgroundThread.start();</span><br><span class="line">   backgroundHandler = new Handler(backgroundThread.getLooper());</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>其中 在camera onOpened() 的时候调用 createCameraPreviewSession</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Creates a new &#123;@link CameraCaptureSession&#125; for camera preview.</span><br><span class="line">  */</span><br><span class="line"> private void createCameraPreviewSession() &#123;</span><br><span class="line">   try &#123;</span><br><span class="line">     final SurfaceTexture texture = textureView.getSurfaceTexture();</span><br><span class="line">     assert texture != null;</span><br><span class="line"></span><br><span class="line">     // We configure the size of default buffer to be the size of camera preview we want.</span><br><span class="line">     texture.setDefaultBufferSize(previewSize.getWidth(), previewSize.getHeight());</span><br><span class="line"></span><br><span class="line">     // This is the output Surface we need to start preview.</span><br><span class="line">     final Surface surface = new Surface(texture);</span><br><span class="line"></span><br><span class="line">     // We set up a CaptureRequest.Builder with the output Surface.</span><br><span class="line">     previewRequestBuilder = cameraDevice.createCaptureRequest(CameraDevice.TEMPLATE_PREVIEW);</span><br><span class="line">     previewRequestBuilder.addTarget(surface);</span><br><span class="line"></span><br><span class="line">     LOGGER.i(&quot;Opening camera preview: &quot; + previewSize.getWidth() + &quot;x&quot; + previewSize.getHeight());</span><br><span class="line"></span><br><span class="line">     // Create the reader for the preview frames.</span><br><span class="line">     previewReader =</span><br><span class="line">         ImageReader.newInstance(</span><br><span class="line">             previewSize.getWidth(), previewSize.getHeight(), ImageFormat.YUV_420_888, 2);</span><br><span class="line"></span><br><span class="line">     previewReader.setOnImageAvailableListener(imageListener, backgroundHandler);</span><br><span class="line">     previewRequestBuilder.addTarget(previewReader.getSurface());</span><br><span class="line"></span><br><span class="line">     // Here, we create a CameraCaptureSession for camera preview.</span><br><span class="line">     cameraDevice.createCaptureSession(</span><br><span class="line">         Arrays.asList(surface, previewReader.getSurface()),</span><br><span class="line">         new CameraCaptureSession.StateCallback() &#123;</span><br><span class="line"></span><br><span class="line">           @Override</span><br><span class="line">           public void onConfigured(final CameraCaptureSession cameraCaptureSession) &#123;</span><br><span class="line">             // The camera is already closed</span><br><span class="line">             if (null == cameraDevice) &#123;</span><br><span class="line">               return;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             // When the session is ready, we start displaying the preview.</span><br><span class="line">             captureSession = cameraCaptureSession;</span><br><span class="line">             try &#123;</span><br><span class="line">               // Auto focus should be continuous for camera preview.</span><br><span class="line">               previewRequestBuilder.set(</span><br><span class="line">                   CaptureRequest.CONTROL_AF_MODE,</span><br><span class="line">                   CaptureRequest.CONTROL_AF_MODE_CONTINUOUS_PICTURE);</span><br><span class="line">               // Flash is automatically enabled when necessary.</span><br><span class="line">               previewRequestBuilder.set(</span><br><span class="line">                   CaptureRequest.CONTROL_AE_MODE, CaptureRequest.CONTROL_AE_MODE_ON_AUTO_FLASH);</span><br><span class="line"></span><br><span class="line">               // Finally, we start displaying the camera preview.</span><br><span class="line">               previewRequest = previewRequestBuilder.build();</span><br><span class="line">               captureSession.setRepeatingRequest(</span><br><span class="line">                   previewRequest, captureCallback, backgroundHandler);</span><br><span class="line">             &#125; catch (final CameraAccessException e) &#123;</span><br><span class="line">               LOGGER.e(e, &quot;Exception!&quot;);</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           @Override</span><br><span class="line">           public void onConfigureFailed(final CameraCaptureSession cameraCaptureSession) &#123;</span><br><span class="line">             showToast(&quot;Failed&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         null);</span><br><span class="line">   &#125; catch (final CameraAccessException e) &#123;</span><br><span class="line">     LOGGER.e(e, &quot;Exception!&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>以上只是一些camera的操作和预览大小的设置</p>
<p>实际与识别相关的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * Callback for android.hardware.Camera API</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public void onPreviewFrame(final byte[] bytes, final Camera camera) &#123;</span><br><span class="line">    Log.i(&quot;linlian&quot;,&quot;CameraActivity.onPreviewFrame()&quot;);</span><br><span class="line">    if (isProcessingFrame) &#123;</span><br><span class="line">      LOGGER.w(&quot;Dropping frame!&quot;);//如果正在处理，则丢掉这一frame</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      // Initialize the storage bitmaps once when the resolution is known.</span><br><span class="line">      if (rgbBytes == null) &#123;</span><br><span class="line">        Camera.Size previewSize = camera.getParameters().getPreviewSize();</span><br><span class="line">        previewHeight = previewSize.height;</span><br><span class="line">        previewWidth = previewSize.width;</span><br><span class="line">        rgbBytes = new int[previewWidth * previewHeight];//初始化 rgbBytes</span><br><span class="line">        onPreviewSizeChosen(new Size(previewSize.width, previewSize.height), 90);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; catch (final Exception e) &#123;</span><br><span class="line">      LOGGER.e(e, &quot;Exception!&quot;);</span><br><span class="line">      return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isProcessingFrame = true;</span><br><span class="line">    lastPreviewFrame = bytes;</span><br><span class="line">    yuvBytes[0] = bytes;</span><br><span class="line">    yRowStride = previewWidth;</span><br><span class="line"></span><br><span class="line">    imageConverter =</span><br><span class="line">        new Runnable() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public void run() &#123;//最终调用native方法实现转化</span><br><span class="line">            ImageUtils.convertYUV420SPToARGB8888(bytes, previewWidth, previewHeight, rgbBytes);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    postInferenceCallback =</span><br><span class="line">        new Runnable() &#123;</span><br><span class="line">          @Override</span><br><span class="line">          public void run() &#123;</span><br><span class="line">            camera.addCallbackBuffer(bytes);</span><br><span class="line">            isProcessingFrame = false;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    processImage();//在子类实现图片处理</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ClassifierActivity </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> protected void processImage() &#123;</span><br><span class="line">   rgbFrameBitmap.setPixels(getRgbBytes(), 0, previewWidth, 0, 0, previewWidth, previewHeight);</span><br><span class="line">   final Canvas canvas = new Canvas(croppedBitmap);</span><br><span class="line"></span><br><span class="line">   canvas.drawBitmap(rgbFrameBitmap, frameToCropTransform, null);</span><br><span class="line"></span><br><span class="line">   // For examining the actual TF input.</span><br><span class="line">   if (SAVE_PREVIEW_BITMAP) &#123;</span><br><span class="line">     ImageUtils.saveBitmap(croppedBitmap);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   //将原始图片进行剪切处理成需要的尺寸croppedBitmap</span><br><span class="line">   </span><br><span class="line">   runInBackground(</span><br><span class="line">       new Runnable() &#123;</span><br><span class="line">         @Override</span><br><span class="line">         public void run() &#123;</span><br><span class="line">           final long startTime = SystemClock.uptimeMillis();</span><br><span class="line">           //进行识别</span><br><span class="line">           final List&lt;Classifier.Recognition&gt; results = classifier.recognizeImage(croppedBitmap);</span><br><span class="line"></span><br><span class="line">           lastProcessingTimeMs = SystemClock.uptimeMillis() - startTime;</span><br><span class="line">           LOGGER.i(&quot;Detect: %s&quot;, results);//[[838] pot (42.3%), [322] pineapple (12.4%)]</span><br><span class="line">           cropCopyBitmap = Bitmap.createBitmap(croppedBitmap);</span><br><span class="line">           if (resultsView == null) &#123;</span><br><span class="line">             resultsView = (ResultsView) findViewById(R.id.results);</span><br><span class="line">           &#125;</span><br><span class="line">           resultsView.setResults(results);</span><br><span class="line">           requestRender();</span><br><span class="line">           readyForNextImage();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>final List&lt;Classifier.Recognition&gt; results = classifier.recognizeImage(croppedBitmap);</code></p>
<p>详细i 看下TensorFlowImageClassifier</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">classifier =</span><br><span class="line">    TensorFlowImageClassifier.create(</span><br><span class="line">        getAssets(),</span><br><span class="line">        MODEL_FILE,</span><br><span class="line">        LABEL_FILE,</span><br><span class="line">        INPUT_SIZE,</span><br><span class="line">        IMAGE_MEAN,</span><br><span class="line">        IMAGE_STD,</span><br><span class="line">        INPUT_NAME,</span><br><span class="line">        OUTPUT_NAME);</span><br></pre></td></tr></table></figure>

<p>其中的几个参赛和所用的模型文件有关</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private static final int INPUT_SIZE = 224;</span><br><span class="line">private static final int IMAGE_MEAN = 117;</span><br><span class="line">private static final float IMAGE_STD = 1;</span><br><span class="line">private static final String INPUT_NAME = &quot;input&quot;;</span><br><span class="line">private static final String OUTPUT_NAME = &quot;output&quot;;</span><br></pre></td></tr></table></figure>

<p>主要是在 TensorFlowImageClassifier</p>
<p>我们有两个文件，一个是模型文件pb结尾的，一个是标签文件，txt结尾的，TensorFlowImageClassifier需要读取模型和标签文件，然后在使用模型去识别处理新的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private static final String MODEL_FILE = &quot;file:///android_asset/tensorflow_inception_graph.pb&quot;;</span><br><span class="line">private static final String LABEL_FILE =</span><br><span class="line">    &quot;file:///android_asset/imagenet_comp_graph_label_strings.txt&quot;;</span><br></pre></td></tr></table></figure>

<p>读取标签文件并且添加到列表中标签列表 <code>private Vector&lt;String&gt; labels = new Vector&lt;String&gt;();</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String actualFilename = labelFilename.split(&quot;file:///android_asset/&quot;)[1];</span><br><span class="line">    Log.i(TAG, &quot;Reading labels from: &quot; + actualFilename);</span><br><span class="line">    BufferedReader br = null;</span><br><span class="line">    try &#123;</span><br><span class="line">      br = new BufferedReader(new InputStreamReader(assetManager.open(actualFilename)));</span><br><span class="line">      String line;</span><br><span class="line">      while ((line = br.readLine()) != null) &#123;</span><br><span class="line">        c.labels.add(line);</span><br><span class="line">      &#125;</span><br><span class="line">      br.close();</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      throw new RuntimeException(&quot;Problem reading label file!&quot; , e);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>加载模型，查看 TensorFlowInferenceInterface内部代码，大概就是加载文件后，该文件是一个byte[] graphDef ，图标定义的学习模型，通过this.loadGraph(graphDef, this.g);得到Graph对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.inferenceInterface = new TensorFlowInferenceInterface(assetManager, modelFilename);</span><br></pre></td></tr></table></figure>

<p>完成以上两步后，只要对图片进行合理的处理后，作为输入，就可以得到tensor flow模型给出的识别结果了</p>
<p>输入输出的一些数据定义则需要深刻理解模型的定义。The shape of the output is [N, NUM_CLASSES], where N is the batch size.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c.outputNames = new String[] &#123;outputName&#125;;//输出</span><br><span class="line">c.intValues = new int[inputSize * inputSize];//输入是一组大小为inputSize * inputSize的int数据，需要将图片信息转化为这种数据</span><br><span class="line">c.floatValues = new float[inputSize * inputSize * 3];</span><br><span class="line">c.outputs = new float[numClasses];</span><br></pre></td></tr></table></figure>

<p>识别处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> public List&lt;Recognition&gt; recognizeImage(final Bitmap bitmap) &#123;</span><br><span class="line">     Log.i(&quot;linlian&quot;,&quot;recognizeImage&quot;);</span><br><span class="line">   // Log this method so that it can be analyzed with systrace.</span><br><span class="line">   Trace.beginSection(&quot;recognizeImage&quot;);</span><br><span class="line"></span><br><span class="line">   Trace.beginSection(&quot;preprocessBitmap&quot;);</span><br><span class="line">   // Preprocess the image data from 0-255 int to normalized float based</span><br><span class="line">   // on the provided parameters.</span><br><span class="line">   bitmap.getPixels(intValues, 0, bitmap.getWidth(), 0, 0, bitmap.getWidth(), bitmap.getHeight());</span><br><span class="line">     Log.i(&quot;linlian&quot;,&quot;recognizeImage intValues.length=&quot;+intValues.length);</span><br><span class="line">   for (int i = 0; i &lt; intValues.length; ++i) &#123;</span><br><span class="line">     final int val = intValues[i];</span><br><span class="line">     floatValues[i * 3 + 0] = (((val &gt;&gt; 16) &amp; 0xFF) - imageMean) / imageStd;</span><br><span class="line">     floatValues[i * 3 + 1] = (((val &gt;&gt; 8) &amp; 0xFF) - imageMean) / imageStd;</span><br><span class="line">     floatValues[i * 3 + 2] = ((val &amp; 0xFF) - imageMean) / imageStd;</span><br><span class="line">     //Log.i(&quot;linlian&quot;,&quot; i=&quot;+i+&quot;  &quot;+floatValues[i * 3 + 0]+&quot; &quot;+floatValues[i * 3 + 0]+&quot;  &quot;+floatValues[i * 3 + 0]);</span><br><span class="line">   &#125;</span><br><span class="line">   Trace.endSection();</span><br><span class="line"></span><br><span class="line">   // Copy the input data into TensorFlow.	输入</span><br><span class="line">   Trace.beginSection(&quot;feed&quot;);</span><br><span class="line">   inferenceInterface.feed(inputName, floatValues, 1, inputSize, inputSize, 3);</span><br><span class="line">   Trace.endSection();</span><br><span class="line"></span><br><span class="line">   // Run the inference call.运行</span><br><span class="line">   Trace.beginSection(&quot;run&quot;);</span><br><span class="line">   inferenceInterface.run(outputNames, logStats);</span><br><span class="line">   Trace.endSection();</span><br><span class="line"></span><br><span class="line">   // Copy the output Tensor back into the output array.</span><br><span class="line">   Trace.beginSection(&quot;fetch&quot;);输出</span><br><span class="line">   inferenceInterface.fetch(outputName, outputs);</span><br><span class="line">   Trace.endSection();</span><br><span class="line"></span><br><span class="line">   // Find the best classifications.</span><br><span class="line">   PriorityQueue&lt;Recognition&gt; pq =</span><br><span class="line">       new PriorityQueue&lt;Recognition&gt;(</span><br><span class="line">           3,</span><br><span class="line">           new Comparator&lt;Recognition&gt;() &#123;</span><br><span class="line">             @Override</span><br><span class="line">             public int compare(Recognition lhs, Recognition rhs) &#123;</span><br><span class="line">               // Intentionally reversed to put high confidence at the head of the queue.</span><br><span class="line">               return Float.compare(rhs.getConfidence(), lhs.getConfidence());</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">   for (int i = 0; i &lt; outputs.length; ++i) &#123;</span><br><span class="line">     if (outputs[i] &gt; THRESHOLD) &#123;</span><br><span class="line">       pq.add(</span><br><span class="line">           new Recognition(</span><br><span class="line">               &quot;&quot; + i, labels.size() &gt; i ? labels.get(i) : &quot;unknown&quot;, outputs[i], null));</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   final ArrayList&lt;Recognition&gt; recognitions = new ArrayList&lt;Recognition&gt;();</span><br><span class="line">   int recognitionsSize = Math.min(pq.size(), MAX_RESULTS);</span><br><span class="line">   for (int i = 0; i &lt; recognitionsSize; ++i) &#123;</span><br><span class="line">     recognitions.add(pq.poll());</span><br><span class="line">   &#125;</span><br><span class="line">   Trace.endSection(); // &quot;recognizeImage&quot;</span><br><span class="line">   return recognitions;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="检测-detector"><a href="#检测-detector" class="headerlink" title="检测 detector"></a>检测 detector</h3><p>关于检测</p>
<p>加载的模型是由三种 可选 multi box，使用旧的API训练的模型 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private static final String MB_INPUT_NAME = &quot;ResizeBilinear&quot;;</span><br><span class="line">private static final String MB_OUTPUT_LOCATIONS_NAME = &quot;output_locations/Reshape&quot;;</span><br><span class="line">private static final String MB_OUTPUT_SCORES_NAME = &quot;output_scores/Reshape&quot;;</span><br><span class="line">private static final String MB_MODEL_FILE = &quot;file:///android_asset/multibox_model.pb&quot;;</span><br><span class="line">private static final String MB_LOCATION_FILE =</span><br><span class="line">    &quot;file:///android_asset/multibox_location_priors.txt&quot;;</span><br></pre></td></tr></table></figure>

<p>另外一部分 tensor flow object detect</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private static final int TF_OD_API_INPUT_SIZE = 300;</span><br><span class="line"> private static final String TF_OD_API_MODEL_FILE =</span><br><span class="line">     &quot;file:///android_asset/ssd_mobilenet_v1_android_export.pb&quot;;</span><br><span class="line"> private static final String TF_OD_API_LABELS_FILE = &quot;file:///android_asset/coco_labels_list.txt&quot;;</span><br></pre></td></tr></table></figure>

<p>还有yolo??</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// Configuration values for tiny-yolo-voc. Note that the graph is not included with TensorFlow and</span><br><span class="line">// must be manually placed in the assets/ directory by the user.</span><br><span class="line">// Graphs and models downloaded from http://pjreddie.com/darknet/yolo/ may be converted e.g. via</span><br><span class="line">// DarkFlow (https://github.com/thtrieu/darkflow). Sample command:</span><br><span class="line">// ./flow --model cfg/tiny-yolo-voc.cfg --load bin/tiny-yolo-voc.weights --savepb --verbalise</span><br><span class="line">private static final String YOLO_MODEL_FILE = &quot;file:///android_asset/graph-tiny-yolo-voc.pb&quot;;</span><br><span class="line">private static final int YOLO_INPUT_SIZE = 416;</span><br><span class="line">private static final String YOLO_INPUT_NAME = &quot;input&quot;;</span><br><span class="line">private static final String YOLO_OUTPUT_NAMES = &quot;output&quot;;</span><br><span class="line">private static final int YOLO_BLOCK_SIZE = 32;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>yolo 是一个实时物体识别的</p>
<p>You only look once (YOLO) is a state-of-the-art, real-time object detection system. On a Pascal Titan X it processes images at 30 FPS and has a mAP of 57.9% on COCO test-dev.</p>
</blockquote>
<p>主要看下tensorflow TF_OD 相关的</p>
<p>coco_labels_list.txt 标签文件，人啊，自行车啊，识别</p>
<p>ssd_mobilenet_v1_android_export.pb 模型文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tracker = new MultiBoxTracker(this);</span><br><span class="line">detector = TensorFlowObjectDetectionAPIModel.create(</span><br><span class="line">            getAssets(), TF_OD_API_MODEL_FILE, TF_OD_API_LABELS_FILE, TF_OD_API_INPUT_SIZE);</span><br><span class="line">        cropSize = TF_OD_API_INPUT_SIZE;</span><br></pre></td></tr></table></figure>

<p>模型的读取和输入输出定义 TensorFlowObjectDetectionAPIModel</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public static Classifier create(</span><br><span class="line">      final AssetManager assetManager,</span><br><span class="line">      final String modelFilename,</span><br><span class="line">      final String labelFilename,</span><br><span class="line">      final int inputSize) throws IOException &#123;</span><br><span class="line">    final TensorFlowObjectDetectionAPIModel d = new TensorFlowObjectDetectionAPIModel();</span><br><span class="line"></span><br><span class="line">    InputStream labelsInput = null;</span><br><span class="line">    String actualFilename = labelFilename.split(&quot;file:///android_asset/&quot;)[1];</span><br><span class="line">    labelsInput = assetManager.open(actualFilename);</span><br><span class="line">    BufferedReader br = null;</span><br><span class="line">    br = new BufferedReader(new InputStreamReader(labelsInput));</span><br><span class="line">    String line;</span><br><span class="line">    while ((line = br.readLine()) != null) &#123;</span><br><span class="line">      LOGGER.w(line);</span><br><span class="line">      d.labels.add(line);//逐行读取标签文件</span><br><span class="line">    &#125;</span><br><span class="line">    br.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    d.inferenceInterface = new TensorFlowInferenceInterface(assetManager, modelFilename);</span><br><span class="line"></span><br><span class="line">    final Graph g = d.inferenceInterface.graph();</span><br><span class="line"></span><br><span class="line">    d.inputName = &quot;image_tensor&quot;;//输入的shap定义</span><br><span class="line">    // The inputName node has a shape of [N, H, W, C], where</span><br><span class="line">    // N is the batch size</span><br><span class="line">    // H = W are the height and width</span><br><span class="line">    // C is the number of channels (3 for our purposes - RGB)</span><br><span class="line">    final Operation inputOp = g.operation(d.inputName);</span><br><span class="line">    if (inputOp == null) &#123;</span><br><span class="line">      throw new RuntimeException(&quot;Failed to find input Node &apos;&quot; + d.inputName + &quot;&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    d.inputSize = inputSize;</span><br><span class="line">    // The outputScoresName node has a shape of [N, NumLocations], where N</span><br><span class="line">    // is the batch size.  三个输出</span><br><span class="line">    final Operation outputOp1 = g.operation(&quot;detection_scores&quot;);</span><br><span class="line">    if (outputOp1 == null) &#123;</span><br><span class="line">      throw new RuntimeException(&quot;Failed to find output Node &apos;detection_scores&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    final Operation outputOp2 = g.operation(&quot;detection_boxes&quot;);</span><br><span class="line">    if (outputOp2 == null) &#123;</span><br><span class="line">      throw new RuntimeException(&quot;Failed to find output Node &apos;detection_boxes&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    final Operation outputOp3 = g.operation(&quot;detection_classes&quot;);</span><br><span class="line">    if (outputOp3 == null) &#123;</span><br><span class="line">      throw new RuntimeException(&quot;Failed to find output Node &apos;detection_classes&apos;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Pre-allocate buffers.</span><br><span class="line">    d.outputNames = new String[] &#123;&quot;detection_boxes&quot;, &quot;detection_scores&quot;,</span><br><span class="line">                                  &quot;detection_classes&quot;, &quot;num_detections&quot;&#125;;</span><br><span class="line">    d.intValues = new int[d.inputSize * d.inputSize];</span><br><span class="line">    d.byteValues = new byte[d.inputSize * d.inputSize * 3];</span><br><span class="line">    d.outputScores = new float[MAX_RESULTS];</span><br><span class="line">    d.outputLocations = new float[MAX_RESULTS * 4];</span><br><span class="line">    d.outputClasses = new float[MAX_RESULTS];</span><br><span class="line">    d.outputNumDetections = new float[1];</span><br><span class="line">    return d;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>识别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  public List&lt;Recognition&gt; recognizeImage(final Bitmap bitmap) &#123;</span><br><span class="line">    // Log this method so that it can be analyzed with systrace.</span><br><span class="line">    Trace.beginSection(&quot;recognizeImage&quot;);</span><br><span class="line"></span><br><span class="line">    Trace.beginSection(&quot;preprocessBitmap&quot;);</span><br><span class="line">    // Preprocess the image data from 0-255 int to normalized float based</span><br><span class="line">    // on the provided parameters.</span><br><span class="line">    bitmap.getPixels(intValues, 0, bitmap.getWidth(), 0, 0, bitmap.getWidth(), bitmap.getHeight());</span><br><span class="line"></span><br><span class="line">    for (int i = 0; i &lt; intValues.length; ++i) &#123;//图片数据处理</span><br><span class="line">      byteValues[i * 3 + 2] = (byte) (intValues[i] &amp; 0xFF);</span><br><span class="line">      byteValues[i * 3 + 1] = (byte) ((intValues[i] &gt;&gt; 8) &amp; 0xFF);</span><br><span class="line">      byteValues[i * 3 + 0] = (byte) ((intValues[i] &gt;&gt; 16) &amp; 0xFF);</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.endSection(); // preprocessBitmap</span><br><span class="line"></span><br><span class="line">    // Copy the input data into TensorFlow.输入</span><br><span class="line">    Trace.beginSection(&quot;feed&quot;);</span><br><span class="line">    inferenceInterface.feed(inputName, byteValues, 1, inputSize, inputSize, 3);</span><br><span class="line">    Trace.endSection();</span><br><span class="line"></span><br><span class="line">    // Run the inference call.运行</span><br><span class="line">    Trace.beginSection(&quot;run&quot;);</span><br><span class="line">    inferenceInterface.run(outputNames, logStats);</span><br><span class="line">    Trace.endSection();</span><br><span class="line"></span><br><span class="line">    // Copy the output Tensor back into the output array.结果输出</span><br><span class="line">    Trace.beginSection(&quot;fetch&quot;);</span><br><span class="line">    outputLocations = new float[MAX_RESULTS * 4];</span><br><span class="line">    outputScores = new float[MAX_RESULTS];</span><br><span class="line">    outputClasses = new float[MAX_RESULTS];</span><br><span class="line">    outputNumDetections = new float[1];</span><br><span class="line">    inferenceInterface.fetch(outputNames[0], outputLocations);</span><br><span class="line">    inferenceInterface.fetch(outputNames[1], outputScores);</span><br><span class="line">    inferenceInterface.fetch(outputNames[2], outputClasses);</span><br><span class="line">    inferenceInterface.fetch(outputNames[3], outputNumDetections);</span><br><span class="line">    Trace.endSection();</span><br><span class="line"></span><br><span class="line">    // Find the best detections.</span><br><span class="line">    final PriorityQueue&lt;Recognition&gt; pq =</span><br><span class="line">        new PriorityQueue&lt;Recognition&gt;(</span><br><span class="line">            1,</span><br><span class="line">            new Comparator&lt;Recognition&gt;() &#123;</span><br><span class="line">              @Override</span><br><span class="line">              public int compare(final Recognition lhs, final Recognition rhs) &#123;</span><br><span class="line">                // Intentionally reversed to put high confidence at the head of the queue.</span><br><span class="line">                return Float.compare(rhs.getConfidence(), lhs.getConfidence());</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    // Scale them back to the input size.</span><br><span class="line">    for (int i = 0; i &lt; outputScores.length; ++i) &#123;</span><br><span class="line">      final RectF detection =</span><br><span class="line">          new RectF(</span><br><span class="line">              outputLocations[4 * i + 1] * inputSize,</span><br><span class="line">              outputLocations[4 * i] * inputSize,</span><br><span class="line">              outputLocations[4 * i + 3] * inputSize,</span><br><span class="line">              outputLocations[4 * i + 2] * inputSize);</span><br><span class="line">      pq.add(</span><br><span class="line">          new Recognition(&quot;&quot; + i, labels.get((int) outputClasses[i]), outputScores[i], detection));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    final ArrayList&lt;Recognition&gt; recognitions = new ArrayList&lt;Recognition&gt;();</span><br><span class="line">    for (int i = 0; i &lt; Math.min(pq.size(), MAX_RESULTS); ++i) &#123;</span><br><span class="line">      recognitions.add(pq.poll());</span><br><span class="line">    &#125;</span><br><span class="line">    Trace.endSection(); // &quot;recognizeImage&quot;</span><br><span class="line">    return recognitions;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="训练模型"><a href="#训练模型" class="headerlink" title="训练模型"></a>训练模型</h1><p>运行手写识别</p>
<p>只需要直接运行<code>fully_connected_feed.py</code>文件，就可以开始训练：</p>
<p><code>python fully_connected_feed.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line"></span><br><span class="line">  File &quot;fully_connected_feed.py&quot;, line 279, in &lt;module&gt;</span><br><span class="line"></span><br><span class="line">    tf.app.run(main=main, argv=[sys.argv[0]] + unparsed)</span><br><span class="line"></span><br><span class="line">TypeError: run() got an unexpected keyword argument &apos;main&apos;</span><br></pre></td></tr></table></figure>

<p>版本太低？</p>
<p>Pip3 install tensorflow==1.4.0   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(venv) zowee-laiscdeMacBook-Pro:tensorflow zowee-laisc$ pip3 install --upgrade tensorflow==1.6.0</span><br></pre></td></tr></table></figure>

<p><strong>TensorFlow Python API 依赖 Python 2.7 版本.</strong></p>
<p>yong pycharm 新建2.7环境的python项目</p>
<p>激活 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> source venv/bin/activate</span><br></pre></td></tr></table></figure>

<p>安装tensor flow</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade tensorflow==1.6.0</span><br></pre></td></tr></table></figure>

<p>到下载的tensorflow</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tensorflow/tensorflow/tensorflow/examples/tutorials/mnist</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">(venv) zowee-laiscdeMacBook-Pro:mnist zowee-laisc$ python fully_connected_feed.py </span><br><span class="line">Successfully downloaded train-images-idx3-ubyte.gz 9912422 bytes.</span><br><span class="line">Extracting /tmp/tensorflow/mnist/input_data/train-images-idx3-ubyte.gz</span><br><span class="line">Successfully downloaded train-labels-idx1-ubyte.gz 28881 bytes.</span><br><span class="line">Extracting /tmp/tensorflow/mnist/input_data/train-labels-idx1-ubyte.gz</span><br><span class="line">Successfully downloaded t10k-images-idx3-ubyte.gz 1648877 bytes.</span><br><span class="line">Extracting /tmp/tensorflow/mnist/input_data/t10k-images-idx3-ubyte.gz</span><br><span class="line">Successfully downloaded t10k-labels-idx1-ubyte.gz 4542 bytes.</span><br><span class="line">Extracting /tmp/tensorflow/mnist/input_data/t10k-labels-idx1-ubyte.gz</span><br><span class="line">2018-05-22 16:15:26.976082: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA</span><br><span class="line">Step 0: loss = 2.32 (0.215 sec)</span><br><span class="line">Step 100: loss = 2.13 (0.001 sec)</span><br><span class="line">Step 200: loss = 1.96 (0.001 sec)</span><br><span class="line">Step 300: loss = 1.70 (0.001 sec)</span><br><span class="line">Step 400: loss = 1.31 (0.001 sec)</span><br><span class="line">Step 500: loss = 1.11 (0.001 sec)</span><br><span class="line">Step 600: loss = 0.89 (0.001 sec)</span><br><span class="line">Step 700: loss = 0.87 (0.001 sec)</span><br><span class="line">Step 800: loss = 0.70 (0.001 sec)</span><br><span class="line">Step 900: loss = 0.64 (0.001 sec)</span><br><span class="line">Training Data Eval:</span><br><span class="line">Num examples: 55000  Num correct: 46676  Precision @ 1: 0.8487</span><br><span class="line">Validation Data Eval:</span><br><span class="line">Num examples: 5000  Num correct: 4264  Precision @ 1: 0.8528</span><br><span class="line">Test Data Eval:</span><br><span class="line">Num examples: 10000  Num correct: 8526  Precision @ 1: 0.8526</span><br><span class="line">Step 1000: loss = 0.55 (0.012 sec)</span><br><span class="line">Step 1100: loss = 0.58 (0.123 sec)</span><br><span class="line">Step 1200: loss = 0.40 (0.001 sec)</span><br><span class="line">Step 1300: loss = 0.49 (0.001 sec)</span><br><span class="line">Step 1400: loss = 0.37 (0.001 sec)</span><br><span class="line">Step 1500: loss = 0.70 (0.001 sec)</span><br><span class="line">Step 1600: loss = 0.40 (0.001 sec)</span><br><span class="line">Step 1700: loss = 0.24 (0.001 sec)</span><br><span class="line">Step 1800: loss = 0.31 (0.001 sec)</span><br><span class="line">Step 1900: loss = 0.39 (0.001 sec)</span><br><span class="line">Training Data Eval:</span><br><span class="line">Num examples: 55000  Num correct: 49053  Precision @ 1: 0.8919</span><br><span class="line">Validation Data Eval:</span><br><span class="line">Num examples: 5000  Num correct: 4509  Precision @ 1: 0.9018</span><br><span class="line">Test Data Eval:</span><br><span class="line">Num examples: 10000  Num correct: 8971  Precision @ 1: 0.8971</span><br><span class="line">(venv) zowee-laiscdeMacBook-Pro:mnist zowee-laisc$</span><br></pre></td></tr></table></figure>

<p>启动tensorboard</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(venv) zowee-laiscdeMacBook-Pro:mnist zowee-laisc$ tensorboard --logdir=logs/</span><br><span class="line">TensorBoard 1.6.0 at http://zowee-laiscdeMacBook-Pro.local:6006 (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>


        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/05/11/android_studio_opencv/">使用Android studio导入open cv 示例代码</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-11
        </span><span class="post-category">
            <a href="/categories/OpenCV/">OpenCV</a>
            </span>
        </div>
    </header>

    <div class="post-content"><p>使用Android studio导入opencv几个sample示例代码</p>
<ul>
<li>calibration</li>
<li>colorblob</li>
<li>facedection</li>
</ul>
<p>其中facedection用到jni，环境配置需要配置ndk，以及编写cmakelist文件。</p>
<h2 id="简单导入"><a href="#简单导入" class="headerlink" title="简单导入"></a>简单导入</h2><ol>
<li><h3 id="下载opencv-sdk"><a href="#下载opencv-sdk" class="headerlink" title="下载opencv sdk"></a>下载opencv sdk</h3><p><a href="https://sourceforge.net/projects/opencvlibrary/files/opencv-android/" target="_blank" rel="noopener">下载</a> opencv 的 Android sdk，并解压到电脑某个路径</p>
</li>
<li><h3 id="模块导入opencv-sdk"><a href="#模块导入opencv-sdk" class="headerlink" title="模块导入opencv sdk"></a>模块导入opencv sdk</h3><p>参考 <a href="https://mp.weixin.qq.com/s/sPjs7KC0yOV-bVZTgpeqUA" target="_blank" rel="noopener">opencv 开发环境搭建</a> 将sdk/java中的代码通过 file-new-Import Module导入。</p>
</li>
<li><h3 id="添加项目依赖"><a href="#添加项目依赖" class="headerlink" title="添加项目依赖"></a>添加项目依赖</h3><p>在 file-Project Structure中选择应用模块，在dependencies 标签下添加dependence，选择刚才导入的opencv模块openCVLibrary341 </p>
</li>
<li><h3 id="添加jniLibs"><a href="#添加jniLibs" class="headerlink" title="添加jniLibs"></a>添加jniLibs</h3><p>如果此时项目不加jniLibs，项目可以编译，但是运行时，回先提示安装open cv manager。就是要另外安装 sdk 目录中apk文件夹下对应的apk，例如 OpenCV_3.4.1_manager_arm64-v8a.apk。</p>
<p>如果不想要另外安装的，则需要将 sdk-native-libs下的 so 文件复制导入项目的jniLibs中。</p>
<p>这样编译之后的apk比较大，要好几十M。</p>
<p>如果是简单的使用opencv 的sdk，例如sample中的color bob示例，这这里的配置就可以了，以下是涉及到ndk编程，项目需要编写cpp文件然后再参与编译，例如示例代码中的facedetection。</p>
</li>
</ol>
<h2 id="涉及jni"><a href="#涉及jni" class="headerlink" title="涉及jni"></a>涉及jni</h2><ol>
<li><h3 id="下载ndk"><a href="#下载ndk" class="headerlink" title="下载ndk"></a>下载ndk</h3><p>File-Project structure - sdk Location。 查看Android NDK location，如果为空，点击底部的Download 即可自动下载，并配置好nkd的位置，如 <code>…../sdk/android-sdk-macosx/ndk-bundle</code></p>
<p>还需要下载cmake：Android studio打开preference对话框，查找 android sdk，在sdk tools标签下勾选下载 cmake。</p>
</li>
<li><h3 id="c-c-源码文件夹"><a href="#c-c-源码文件夹" class="headerlink" title="c/c++源码文件夹"></a>c/c++源码文件夹</h3><p>在main目录下创建cpp文件夹，用于存放cpp文件。</p>
</li>
<li><h3 id="编写CMakeLists-txt"><a href="#编写CMakeLists-txt" class="headerlink" title="编写CMakeLists.txt"></a>编写CMakeLists.txt</h3><p>cmake文件可以参考在Android studio中新建一个c++ support项目而自动生成的cmakelist文件。参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line"></span><br><span class="line">#include open cv sdk中的jni include路径，不然</span><br><span class="line">include_directories(/Users/zowee-laisc/lynn/opencv/OpenCV-android-sdk/sdk/native/jni/include)</span><br><span class="line"></span><br><span class="line">#导入项目jniLibs文件夹下载 so库</span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             lib_opencv</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             IMPORTED)</span><br><span class="line"></span><br><span class="line">set_target_properties(lib_opencv</span><br><span class="line">                      PROPERTIES IMPORTED_LOCATION</span><br><span class="line">                      $&#123;CMAKE_SOURCE_DIR&#125;/src/main/jniLibs/$&#123;ANDROID_ABI&#125;/libopencv_java3.so)</span><br><span class="line"></span><br><span class="line">#编译添加自己的jni 库</span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             detection_based_tracker</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             src/main/cpp/DetectionBasedTracker_jni.cpp )</span><br><span class="line"></span><br><span class="line"># Searches for a specified prebuilt library and stores the path as a</span><br><span class="line"># variable. Because CMake includes system libraries in the search path by</span><br><span class="line"># default, you only need to specify the name of the public NDK library</span><br><span class="line"># you want to add. CMake verifies that the library exists before</span><br><span class="line"># completing its build.</span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable.</span><br><span class="line">              log-lib</span><br><span class="line"></span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate.</span><br><span class="line">              log )</span><br><span class="line"></span><br><span class="line"># Specifies libraries CMake should link to your target library. You</span><br><span class="line"># can link multiple libraries, such as libraries you define in this</span><br><span class="line"># build script, prebuilt third-party libraries, or system libraries.</span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.</span><br><span class="line">                       detection_based_tracker</span><br><span class="line"></span><br><span class="line">                       lib_opencv</span><br><span class="line"></span><br><span class="line">                       # Links the target library to the log library</span><br><span class="line">                       # included in the NDK.</span><br><span class="line">                       $&#123;log-lib&#125; )</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ol start="4">
<li><h3 id="修改gradle文件"><a href="#修改gradle文件" class="headerlink" title="修改gradle文件"></a>修改gradle文件</h3><p>修改应用gradle文件，主要是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">externalNativeBuild &#123;</span><br><span class="line">           cmake &#123;</span><br><span class="line">               cppFlags &quot;-frtti -fexceptions&quot;</span><br><span class="line">               abiFilters &apos;x86&apos;, &apos;x86_64&apos;, &apos;armeabi-v7a&apos;, &apos;arm64-v8a&apos;</span><br><span class="line">               arguments &quot;-DANDROID_STL=gnustl_static&quot;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>完整文件如下：</p>
</li>
</ol>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;com.android.application&apos;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 27</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId &quot;com.zowee.facedection&quot;</span><br><span class="line">        minSdkVersion 21</span><br><span class="line">        targetSdkVersion 27</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner &quot;android.support.test.runner.AndroidJUnitRunner&quot;</span><br><span class="line"></span><br><span class="line">        externalNativeBuild &#123;</span><br><span class="line">            cmake &#123;</span><br><span class="line">                cppFlags &quot;-frtti -fexceptions&quot;</span><br><span class="line">                abiFilters &apos;x86&apos;, &apos;x86_64&apos;, &apos;armeabi-v7a&apos;, &apos;arm64-v8a&apos;</span><br><span class="line">                arguments &quot;-DANDROID_STL=gnustl_static&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            jniLibs.srcDirs = [&apos;src/main/jniLibs&apos;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;), &apos;proguard-rules.pro&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            path &quot;CMakeLists.txt&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(include: [&apos;*.jar&apos;], dir: &apos;libs&apos;)</span><br><span class="line">    implementation &apos;com.android.support:appcompat-v7:27.1.1&apos;</span><br><span class="line">    testImplementation &apos;junit:junit:4.12&apos;</span><br><span class="line">    androidTestImplementation &apos;com.android.support.test:runner:1.0.2&apos;</span><br><span class="line">    androidTestImplementation &apos;com.android.support.test.espresso:espresso-core:3.0.2&apos;</span><br><span class="line">    implementation project(&apos;:openCVLibrary341&apos;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="5">
<li><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>构建项目的时候，遇到的主要报错信息和解决方案</p>
<ul>
<li><p>用&lt;&gt;来导入文件出错，该用双引号导入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error:(1, 10) error: &apos;DetectionBasedTracker_jni.h&apos; file not found with &lt;angled&gt; include; use &quot;quotes&quot; instead</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ul>
<li><p>无法找到 opencv2/core.hpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error:(2, 10) fatal error: &apos;opencv2/core.hpp&apos; file not found</span><br><span class="line">Error:(2, 10) fatal error: &apos;opencv2/core.hpp&apos; file not found</span><br></pre></td></tr></table></figure>

<p>在cmakelist文件中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include_directories(/Users/zowee-laisc/lynn/opencv/OpenCV-android-sdk/sdk/native/jni/include)</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>Linker命令错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/Measurebox2/facedection/src/main/cpp/DetectionBasedTracker_jni.cpp</span><br><span class="line">Error:(36) undefined reference to `cv::CascadeClassifier::detectMultiSc</span><br><span class="line">Error:error: linker command failed with exit code 1 (use -v to see invocation)</span><br><span class="line"></span><br><span class="line">或者</span><br><span class="line">Error:(36) undefined reference to `cv::CascadeClassi</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<p>检查gradle文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cmake &#123;</span><br><span class="line">    cppFlags &quot;-frtti -fexceptions&quot;</span><br><span class="line">    abiFilters &apos;x86&apos;, &apos;x86_64&apos;, &apos;armeabi-v7a&apos;, &apos;arm64-v8a&apos;</span><br><span class="line">    arguments &quot;-DANDROID_STL=gnustl_static&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>删除部分libs文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Error:Execution failed for task &apos;:facedection:transformNativeLibsWithStripDebugSymbolForDebug&apos;.</span><br><span class="line">&gt; A problem occurred starting process &apos;command &apos;/Users/zowee-laisc/lynn/sdk/android-sdk-macosx/ndk-bundle/toolchains/mips64el-linux-android-4.9/prebuilt/darwin-x86_64/bin/mips64el-linux-android-strip&apos;&apos;</span><br></pre></td></tr></table></figure>

<p>解决方法将jniLibs下的mips64的so 库文件夹删除 </p>
</li>
</ul>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/05/09/scrapy_test/">scrapy 入门</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-09
        </span><span class="post-category">
            <a href="/categories/Python/">Python</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#创建项目后，在终端进入项目录入</span><br><span class="line"># source venv/bin/activate 来激活环境，最前面出现 (venv)</span><br><span class="line"># (venv) zowee-laiscdeMacBook-Pro:scrapytest zowee-laisc$ pip install Scrapy 然后安装Scrapy</span><br></pre></td></tr></table></figure>

<blockquote>
<p>激活虚拟环境后，如果要退出活着删除可以使用如下命令</p>
<p><strong>退出虚拟环境</strong>$
    deactivate<br><strong>删除虚拟环境</strong><br>    rm -r venv</p>
</blockquote>
<p>创建scrapy项目 <code>scrapy startproject tutorial</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(venv) zowee-laiscdeMacBook-Pro:scrapytest zowee-laisc$ scrapy startproject tutorial</span><br><span class="line">New Scrapy project &apos;tutorial&apos;, using template directory &apos;/Users/zowee-laisc/lynn/pycharmProject/scrapytest/venv/lib/python3.6/site-packages/scrapy/templates/project&apos;, created in:</span><br><span class="line">    /Users/zowee-laisc/lynn/pycharmProject/scrapytest/tutorial</span><br><span class="line"></span><br><span class="line">You can start your first spider with:</span><br><span class="line">    cd tutorial</span><br><span class="line">    scrapy genspider example example.com</span><br></pre></td></tr></table></figure>

<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><ol>
<li><h2 id="生成爬虫类"><a href="#生成爬虫类" class="headerlink" title="生成爬虫类"></a>生成爬虫类</h2><p>生成一个spider爬虫类 scrappy genspider spiderName xxxxdomain</p>
<p>会在spider文件夹下生成一个 spiderXXX.py文件</p>
<p>示例：爬一下公司内网的buglist</p>
<p>​</p>
</li>
<li><h2 id="定义item字段"><a href="#定义item字段" class="headerlink" title="定义item字段"></a>定义item字段</h2><p>定义我们要处理哪些数据在 items.py文件中添加如下定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import scrapy</span><br><span class="line">class ChandaoItem(scrapy.Item):</span><br><span class="line">    # define the fields for your item here like:</span><br><span class="line">    #bug title</span><br><span class="line">    title = scrapy.Field()</span><br><span class="line">    #严重等级</span><br><span class="line">    severity = scrapy.Field()</span><br><span class="line">    #bug 发现者</span><br><span class="line">    founder = scrapy.Field()</span><br><span class="line">    #当前责任人</span><br><span class="line">    current = scrapy.Field()</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><h2 id="登录数据"><a href="#登录数据" class="headerlink" title="登录数据"></a>登录数据</h2><p>一般网站都要账号密码登录流程</p>
<p>在进入请求的时候，将用户数据封好后，再返回给引擎，要求请求完成后由after_login来处理。</p>
<p>在after_login中在重新请求到我们需要爬取的页面，这个时候，已经是登录状态了，然后再将请求后的数据交给parse_buglist处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def parse(self, response):</span><br><span class="line">        return scrapy.FormRequest.from_response(</span><br><span class="line">            response,</span><br><span class="line">            formdata=&#123;&apos;account&apos;:&apos;linlian&apos;,&apos;password&apos;:&apos;XXXX&apos;&#125;,</span><br><span class="line">            callback = self.after_login</span><br><span class="line">        )</span><br><span class="line">def after_login(self,response):</span><br><span class="line">        print(&quot;after......&quot;)</span><br><span class="line">        print(response.xpath(&apos;//script&apos;).extract()[0])</span><br><span class="line">        #with open(&quot;body.txt&quot;, &apos;wb&apos;) as f:</span><br><span class="line">        #    f.write(response.body)</span><br><span class="line">        #b&quot;&lt;script&gt;parent.location=&apos;/zentao/index.html&apos;;\n\n&lt;/script&gt;\n&quot;</span><br><span class="line">        return scrapy.Request(&apos;http://192.168.2.27/zentao/bug-browse-21.html&apos;,</span><br><span class="line">                              callback= self.parse_buglist)</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><h2 id="页面解析"><a href="#页面解析" class="headerlink" title="页面解析"></a>页面解析</h2><p>拿到页面数据后，通过xpath拿到我们需要的节点，进行迭代解析我们需要的数据，然后通过页面分析拿到需要进一步请求的连接地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def parse_buglist(self,response):</span><br><span class="line">       print(&quot;parse_buglist&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       node_list = response.xpath(&quot;//tr[@class=&apos;text-center&apos;]&quot;)</span><br><span class="line">       for node in node_list:</span><br><span class="line">           item =  ChandaoItem()</span><br><span class="line">           item[&apos;severity&apos;] = node.xpath(&quot;./td[2]/span/text()&quot;).extract()[0]</span><br><span class="line">           item[&apos;title&apos;] = node.xpath(&quot;./td[4]/a/text()&quot;).extract()[0]</span><br><span class="line">           item[&apos;founder&apos;] = node.xpath(&quot;./td[5]/text()&quot;).extract()[0]</span><br><span class="line">           item[&apos;current&apos;] = node.xpath(&quot;./td[6]/text()&quot;).extract()[0]</span><br><span class="line">           yield item</span><br><span class="line"></span><br><span class="line">       try:</span><br><span class="line">           url = response.xpath(&quot;//i[@class=&apos;icon-play&apos;]/../@href&quot;).extract()[0]</span><br><span class="line">           print(url)</span><br><span class="line">           if len(url) !=0:</span><br><span class="line">               yield      scrapy.Request(&apos;http://192.168.2.27&apos;+url,callback=self.parse_buglist)</span><br><span class="line">       except IndexError:</span><br><span class="line">           print(&quot;Get next Error&quot;)</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
<li><h2 id="数据保存"><a href="#数据保存" class="headerlink" title="数据保存"></a>数据保存</h2><p>运行爬虫 <code>scrapey crawl Buglist -o items.json</code> 并将结果保存在 items.json</p>
</li>
</ol>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/18/agile note/">敏捷开发 小记</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-18
        </span><span class="post-category">
            <a href="/categories/BLOG/">BLOG</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="第一部分-敏捷开发"><a href="#第一部分-敏捷开发" class="headerlink" title="第一部分 敏捷开发"></a>第一部分 敏捷开发</h1><blockquote>
<p>人与人之间的交互式复杂的，并且从其效果从来都是难以预期，但却是工作中最为重要的方面</p>
<p>—人件</p>
</blockquote>
<p>构建起具有合作精神的自组织团队</p>
<blockquote>
<p>教堂尖顶傻姑娘的风标，即使由钢铁制成，如果不懂得顺应风势的艺术，一样会被风暴立即摧毁</p>
<p>——海因里希-海涅</p>
</blockquote>
<p>让软件团队具有快速工作、响应变化能力的价值观和原则。</p>
<h2 id="敏捷宣言"><a href="#敏捷宣言" class="headerlink" title="敏捷宣言"></a>敏捷宣言</h2><blockquote>
<p>个体和交互 胜过 过程和工具</p>
<p>可以工作的软件 胜过 面面俱到的文档</p>
<p>客户合作 胜过 合同谈判</p>
<p>响应变化 胜过 遵循计划</p>
</blockquote>
<p>为下<strong>两周</strong>的做详细计划，为下三个月做粗略计划，再为以后做极为粗糙的计划。</p>
<h2 id="敏捷原则："><a href="#敏捷原则：" class="headerlink" title="敏捷原则："></a>敏捷原则：</h2><ol>
<li>我们最优先要做的事尽早的，持续的交付有价值的软件来使客户满意</li>
<li>即使到开发的后期，也欢迎改变需求。敏捷过程利用变化来为客户创建竞争优势。</li>
<li>经常性的交付可以工作的软件，交付间隔可以从几周到几个月，交付时间间隔越短越好。</li>
<li>整个项目开发期间，业务人员和开发人员必须天天在一起工作。</li>
<li>围绕被激励起来的个人来构建项目，给他们提供所需要的环境和支持，并且信任他们能够完成工作。</li>
<li>团队内部，最具有效果且富有效率的传递信息的方法就是，面对面的交谈。</li>
<li>工作的软件事收腰的进度度量标准</li>
<li>敏捷过程提倡可持续的开发速度，责任人，开发者，用户应该能够保持一个长期的，恒定的开发速度。</li>
<li>不断的关注优秀的技能和好的设计会增强敏捷能力</li>
<li>简单—使未完成的工作最大化的艺术—是根本。简单</li>
<li>最好的架构、需求和设计出自于自组织的团队</li>
<li>每隔和一段时间，团队会在如何更有效的工作方面进行反省，相对应的对自己的行为进行调整。</li>
</ol>
<h2 id="极限编程"><a href="#极限编程" class="headerlink" title="极限编程"></a>极限编程</h2><p>xp，极限编程，是敏捷方法中的最著名的一个。</p>
<p>和客户反复讨论，以获取对于需求细节的理解，但不去捕获那些细节。</p>
<p>重构；不能容忍代码重复</p>
<p>重构是持续进行的，不是在项目结束，版本发布的时候</p>
<p>而是我们，要在每隔一个小时，或者半个小时就要去做的事情！！！</p>
<p>隐喻</p>
<p>极限编程是一组简单、具体的实践，这些实践结合起来形成了敏捷开发的过程。</p>
<h2 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h2><p>初识探索：客户会不断编写新的用户素材。</p>
<p>开发人员对这些素材进行估算，估算是相对的，不是绝对的。</p>
<p>大的素材进行拆分，过小的素材进行合并</p>
<p>用户能够安全的进行存款、取款、转账等活动</p>
<p>拆分为：</p>
<ul>
<li>用户登录</li>
<li>用户退出</li>
<li>用户向其账户存款</li>
<li>用户从其账户取款</li>
<li>用户从其账户向其他账户转账</li>
</ul>
<p>任务计划</p>
<p>一个任务，是一个开发人员能够在4～16个小时内实现的一些功能。</p>
<p>在迭代中的点；我们希望看到拥有一半素材点数的完整素材被完成。而不是完成了百分之90的素材点，确没有一个完整的素材被完成。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<p>烈火验真金，逆境磨意志——卢修斯-塞尼加</p>
</blockquote>
<p>测试驱动</p>
<p>Mock object模式。测试方法</p>
<p>白盒测试</p>
<p>黑盒测试</p>
<h2 id="重构"><a href="#重构" class="headerlink" title="重构"></a>重构</h2><p>代码可读性，</p>
<p>去掉重复的代码</p>
<p>提炼</p>
<h2 id="一次编程实践"><a href="#一次编程实践" class="headerlink" title="一次编程实践"></a>一次编程实践</h2><p>如果还没必要引入新的类，先用简单参数。add(int) 二不是 add(Throw)这样。</p>
<p>单一职责原则。game接受投掷也知道如何计算每轮的得分，好像有点违反了单一职责原则，如果增加一个scorer对象呢？？暂时先放着。因为我们还没想好把分数计算放在哪里</p>
<p>先把代码写的更容易让人理解。</p>
<p>各种测试例过了之后，看到乱乱的程序，再来重构一下？？</p>
<p>从测试开始，至上而下</p>
<h1 id="第二部分-敏捷设计"><a href="#第二部分-敏捷设计" class="headerlink" title="第二部分 敏捷设计"></a>第二部分 敏捷设计</h1><p>全局视。图和软件一起演化，在每次迭代中，团队改进系统设计，使设计尽可能适合于当前系统。不会花很多时间去预测未来的需求和需要，也不会试图在今天就构建一些基础结构去支撑那些他们认为明天才回需要的特性。</p>
<p>拙劣的设计：</p>
<ul>
<li><p>僵硬化：设计难以改变</p>
<p>单一的改动导致有依赖关系的模块的连锁改动，必须要改动的模块越多，表示设计越僵硬化</p>
</li>
<li><p>脆弱性：设计易于遭到破坏</p>
<p>一个地方修改后，许多地方就可能出现问题</p>
</li>
<li><p>牢固性：设计难以重用</p>
<p>​</p>
</li>
<li><p>粘滞性：难以做正确的事情</p>
</li>
<li><p>不必要的复杂性：过分设计</p>
</li>
<li><p>不必要的重复：滥用鼠标</p>
</li>
<li><p>晦涩性：混乱的表达</p>
</li>
</ul>
<p>原则：</p>
<ul>
<li>单一职责原则 the single responsibility principle</li>
<li>开放-封闭原则 the open-close principle</li>
<li>Liskov替换原则 the Liskov substitution principle</li>
<li>依赖倒置原则 the dependency inversion principle</li>
<li>接口隔离原则 the interface segregation interface</li>
</ul>
<p>敏捷开发人员如何知道要做什么？</p>
<ol>
<li>遵循敏捷实践去发现问题；</li>
<li>应用设计原则去诊断问题</li>
<li>应用适当的设计模式去解决问题</li>
</ol>
<h2 id="单一职责原则-simple-responsibility-principle"><a href="#单一职责原则-simple-responsibility-principle" class="headerlink" title="单一职责原则 simple responsibility principle"></a>单一职责原则 simple responsibility principle</h2><p>内聚性——一个模块组成元素之间的功能相关性。</p>
<p>就一个类而言，应该仅有一个引起它变化的原因；</p>
<p>例如把game 和 scorer分离，之前game即要跟踪当前比赛，又要计算得分。每个职责的变化都是一个轴线。如果一个类承担的多于一个职责，那么引起这个类变化的原因就有多个</p>
<p>如果一个类承担的职责过多，就等于把这些职责耦合在一起了。一个职责的变化可能会抑制这个类完成其他职责的能力。</p>
<h2 id="开放-封闭原则"><a href="#开放-封闭原则" class="headerlink" title="开放-封闭原则"></a>开放-封闭原则</h2><p>对于扩展，是开放的</p>
<p>对于更改，是封闭的</p>
<p>关键是抽象！！！</p>
<h2 id="Liskov替换原则"><a href="#Liskov替换原则" class="headerlink" title="Liskov替换原则"></a>Liskov替换原则</h2><p>子类型必须能够替换掉他们的基类型</p>
<p>从行为的角度看 A是不是 is-a B，例如我们认为正方形是一种特殊的长方形。</p>
<p>但在结算面积的时候，设置宽为4，长为5，长方形的面积是<code>4*5</code>，而如果设置了正方形长为4，宽为5，面积，，，就不是<code>4*5</code>这么算的了</p>
<p>提取公共部分</p>
<p>派生类中添加了其他类不会抛出的异常，也是违反了lsp原则</p>
<p>Is-a含义过于宽广，子类型的正确定义是：可替换性的“</p>
<h2 id="依赖倒置原则-dip"><a href="#依赖倒置原则-dip" class="headerlink" title="依赖倒置原则 dip"></a>依赖倒置原则 dip</h2><p>高层模块不应该依赖于低层模块，二者都应该依赖于抽象</p>
<p>抽象不应该依赖于细节，细节应该依赖于抽象</p>
<ul>
<li>任何变量都不应该持有一个指向具体类的指针或者引用</li>
<li>任何类都不应该从高具体类派生</li>
<li>任何方法都不应该复写它的任何基类中已经实现的方法</li>
</ul>
<p>高层策略需要和低层实现进行分离</p>
<h2 id="接口隔离原则"><a href="#接口隔离原则" class="headerlink" title="接口隔离原则"></a>接口隔离原则</h2><p>如果类的借口不是内聚的，就表示该类具有胖的接口</p>
<h1 id="第三部分-薪水支付案例研究"><a href="#第三部分-薪水支付案例研究" class="headerlink" title="第三部分 薪水支付案例研究"></a>第三部分 薪水支付案例研究</h1><p>系统需求点</p>
<p>用例分析，列举，异常情况</p>
<p>介绍熟悉一些常见设计模式，monostate倒是之前没见过的模式，从行为上的单例</p>
<h2 id="第一次迭代开始"><a href="#第一次迭代开始" class="headerlink" title="第一次迭代开始"></a>第一次迭代开始</h2><ul>
<li><p>规格说明，与客户交谈中的一些记录，基本需求</p>
</li>
<li><p>基于用用例分析，考虑下系统的行为</p>
<p>进行用例分析的时候，关注素材和验收测试，找出系统的用户会执行的操作种类。</p>
<p>通过用例设计了系统核心模型图</p>
</li>
<li><p>实现，uml作为交流媒介，草图</p>
<p>测试优先</p>
</li>
<li><p>打包，包的设计原则</p>
<p>重用发布等价原则、共同重用原则、共同封闭原则、包内聚兴总结、稳定性包的耦合性和原则、</p>
<p>​</p>
<p>​</p>
</li>
</ul>
<h2 id="气象站案例研究"><a href="#气象站案例研究" class="headerlink" title="气象站案例研究"></a>气象站案例研究</h2><p>todo</p>
<h2 id="ETS案例研究"><a href="#ETS案例研究" class="headerlink" title="ETS案例研究"></a>ETS案例研究</h2><p>todo</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/TextPathView动画/">Textpath动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Text路径动画效果"><a href="#Text路径动画效果" class="headerlink" title="Text路径动画效果"></a>Text路径动画效果</h1><p>项目地址：<a href="https://github.com/totond/TextPathView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/5f388182db2cf6e039befbfdc41a7e195e93f5a4/68747470733a2f2f692e696d6775722e636f6d2f6c356f385847352e676966" alt="text path 动画"></p>
<p>这个的原理解析也写的很清楚 <a href="https://juejin.im/post/5a9677b16fb9a063375765ad" target="_blank" rel="noopener">连接</a></p>
<p>主要是获取path的过程</p>
<p>以及同步显示画笔</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/wave动画效果/">wave动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Wave动画效果"><a href="#Wave动画效果" class="headerlink" title="Wave动画效果"></a>Wave动画效果</h1><p>项目地址：<a href="https://github.com/tangqi92/WaveLoadingView" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/8f83a9935a2b79ed9c63749a1b1b907e2cae850a/687474703a2f2f3778696b66632e636f6d312e7a302e676c622e636c6f7564646e2e636f6d2f776176656c6f6164696e67766965772e706e67" alt="image"></p>
<p>实现波浪wave效果，以及水位位置调整。</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="外部形状"><a href="#外部形状" class="headerlink" title="外部形状"></a>外部形状</h3><p>外部形状可以是圆形，三角形，整个图形的绘制区域由canvas决定</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void initBoarderPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBoarderPain = new Paint();</span><br><span class="line">    mBoarderPain.setAntiAlias(true);</span><br><span class="line">    mBoarderPain.setStyle(Paint.Style.STROKE);//描边</span><br><span class="line">    mBoarderPain.setStrokeWidth(DEFAULT_BOARD_WIDTH);</span><br><span class="line">    mBoarderPain.setColor(Color.RED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void initBgPaint() &#123;</span><br><span class="line">    //默认的style是fill，填充的</span><br><span class="line">    mBgPaint = new Paint();</span><br><span class="line">    mBgPaint.setAntiAlias(true);</span><br><span class="line">    mBgPaint.setColor(getResources().getColor(R.color.voicebg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>怎么画波浪呢？</p>
<p>初始化paint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private void initWavePaint() &#123;</span><br><span class="line">       mWavePain = new Paint();</span><br><span class="line">       mWavePain.setAntiAlias(true);</span><br><span class="line">       mWavePain.setColor(getResources().getColor(R.color.voicefr));</span><br><span class="line">       updateWaveShader();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>其中updateWaveShader，使用的着色器是BitmapShader。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void updateWaveShader() &#123;</span><br><span class="line">       if (getWaveBitmap() != null) &#123;</span><br><span class="line">           mWaveShader = new BitmapShader(getWaveBitmap(), Shader.TileMode.REPEAT, Shader.TileMode.CLAMP);//x坐标repeat模式，y方向上最后一个像素重复</span><br><span class="line">           mWavePain.setShader(mWaveShader);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePain.setShader(null);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>而getWaveBitmap()的任务是获得一个画有两个波浪的图形</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private Bitmap getWaveBitmap() &#123;//返回一个波形的图案，两条线</span><br><span class="line"></span><br><span class="line">    int wavecount = 1;//容纳多少个完整波形</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    int width = getMeasuredWidth();</span><br><span class="line">    int height = getMeasuredHeight();</span><br><span class="line">    Log.i(&quot;linlian&quot;, &quot;width=&quot; + width + &quot; height=&quot; + height);</span><br><span class="line">    if (width &gt; 0 &amp;&amp; height &gt; 0) &#123;</span><br><span class="line"></span><br><span class="line">        Bitmap bitmap = Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">        Canvas waveLineCanvas = new Canvas(bitmap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //坐标点数组，x从0-width，y=Asin(Wx+Q)+H</span><br><span class="line">        // W = 2*PI/width</span><br><span class="line">        // A = height</span><br><span class="line">        // h = height</span><br><span class="line">        // Q = 0</span><br><span class="line">        final int endX = width + 1;</span><br><span class="line">        final int endY = height + 1;</span><br><span class="line">        float W = (float) (2f * Math.PI * wavecount / width);</span><br><span class="line">        float A = height / 10f;//波浪幅度在整体的10分之一</span><br><span class="line">        float H = height / 2;//默认水位在一半的位置</span><br><span class="line">        float[] waveY = new float[endX];</span><br><span class="line"></span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveY[x] = (float) (A * Math.sin(W * x)) + H;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int xShift = width / 4;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavebg));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[(x + xShift) % endX], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line">        mWavePaint.setColor(getResources().getColor(R.color.wavefr));</span><br><span class="line">        for (int x = 0; x &lt; endX; x++) &#123;</span><br><span class="line"></span><br><span class="line">            waveLineCanvas.drawLine(x, waveY[x], x, endY, mWavePaint);// .:|:. 像这样画线</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置好图形着色器之后，在view的onDraw方法上，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   protected void onDraw(Canvas canvas) &#123;</span><br><span class="line">       super.onDraw(canvas);</span><br><span class="line">       float boaderwidth = DEFAULT_BOARD_WIDTH;</span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, (getWidth() - boaderwidth) / 2f - 1f, mBoarderPain);//画边框</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mBgPaint);//画圆形背景</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePain);//画波浪图形</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何实现动画效果呢"><a href="#如何实现动画效果呢" class="headerlink" title="如何实现动画效果呢"></a>如何实现动画效果呢</h3><p>通过属性动画来实现，改变waveXshift的值，从0到1变化，两秒，重复变化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">private void initAnimation() &#123;</span><br><span class="line">       mShaderMatrix = new Matrix();</span><br><span class="line">       ObjectAnimator waveXshiftAnimator = ObjectAnimator.ofFloat(this, &quot;waveXshift&quot;, 0f, 1f); </span><br><span class="line">       waveXshiftAnimator.setRepeatCount(ValueAnimator.INFINITE);</span><br><span class="line">       waveXshiftAnimator.setDuration(2000);</span><br><span class="line">       waveXshiftAnimator.setInterpolator(new LinearInterpolator());</span><br><span class="line">       mAnimatorset = new AnimatorSet();</span><br><span class="line">       mAnimatorset.play(waveXshiftAnimator);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>属性变化的时候，重新绘制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void setWaveXshift(float mWaveXshift) &#123;</span><br><span class="line">    if (this.mWaveXshift != mWaveXshift) &#123;</span><br><span class="line">        this.mWaveXshift = mWaveXshift;</span><br><span class="line">        //变化的是重新绘制view，实现动画效果</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在onDraw中，实现图像的水平移动 mWaveXshift * getWidth();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (mWaveShader != null) &#123;</span><br><span class="line">           if (mWavePaint.getShader() == null) &#123;</span><br><span class="line">               mWavePaint.setShader(mWaveShader);</span><br><span class="line">           &#125;</span><br><span class="line">           float dx = mWaveXshift * getWidth();</span><br><span class="line">           mShaderMatrix.setTranslate(dx, 0);//平移波浪，实现推进效果</span><br><span class="line">           mWaveShader.setLocalMatrix(mShaderMatrix);</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           mWavePaint.setShader(null);</span><br><span class="line">       &#125;</span><br><span class="line">       canvas.drawCircle(getWidth() / 2f, getHeight() / 2f, getWidth() / 2f - boaderwidth, mWavePaint);//画波浪</span><br></pre></td></tr></table></figure>

<p>重新实现的代码可以参考</p>
<p><a href="https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java" target="_blank" rel="noopener">https://github.com/lynn8570/VoiceView/blob/master/animlib/src/main/java/anim/lynn/voice/VoiceWave.java</a></p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/常见动画效果/">常见动画效果</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="引导动画"><a href="#引导动画" class="headerlink" title="引导动画"></a>引导动画</h1><p>项目地址：<a href="https://github.com/daimajia/AndroidViewAnimations" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://camo.githubusercontent.com/c41223966bdfed2260dbbabbcbae648e5db542c6/687474703a2f2f7777332e73696e61696d672e636e2f6d773639302f3631306463303334677731656a37356d69327737376732306333306a623471722e676966" alt="引导动画"></p>
<p>这个库使用起来还是非常方便的：例如在点击的时候，就可以设置某个视图的动画效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">findViewById(R.id.submit).setOnClickListener(new View.OnClickListener() &#123;</span><br><span class="line">           @Override</span><br><span class="line">           public void onClick(View v) &#123;</span><br><span class="line"></span><br><span class="line">               YoYo.with(Techniques.Tada)</span><br><span class="line">                       .duration(700)</span><br><span class="line">                       .playOn(findViewById(R.id.edit_area));</span><br><span class="line"></span><br><span class="line">               t.setText(&quot;Wrong password!&quot;);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></figure>

<p>YoYo.with(Techniques.Tada)返回一个new AnimationComposer(techniques)的对象，主要用于设置动画的参数。</p>
<p>playOn(target);的时候，将参数设置到animator中并通过animator.setTarget(target);设置作用对象，然后调用play，实际上就是设置好动画参数，然后执行animator.animate()开始动画</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private BaseViewAnimator play() &#123;</span><br><span class="line">    animator.setTarget(target);</span><br><span class="line"></span><br><span class="line">    if (pivotX == YoYo.CENTER_PIVOT) &#123;</span><br><span class="line">        ViewCompat.setPivotX(target, target.getMeasuredWidth() / 2.0f);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        target.setPivotX(pivotX);</span><br><span class="line">    &#125;</span><br><span class="line">    if (pivotY == YoYo.CENTER_PIVOT) &#123;</span><br><span class="line">        ViewCompat.setPivotY(target, target.getMeasuredHeight() / 2.0f);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        target.setPivotY(pivotY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    animator.setDuration(duration)</span><br><span class="line">            .setRepeatTimes(repeatTimes)</span><br><span class="line">            .setRepeatMode(repeatMode)</span><br><span class="line">            .setInterpolator(interpolator)</span><br><span class="line">            .setStartDelay(delay);</span><br><span class="line"></span><br><span class="line">    if (callbacks.size() &gt; 0) &#123;</span><br><span class="line">        for (Animator.AnimatorListener callback : callbacks) &#123;</span><br><span class="line">            animator.addAnimatorListener(callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    animator.animate();</span><br><span class="line">    return animator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来挑几个基本的动画实现或者几个有意思的实现来看看吧。</p>
<p>所以textview的demo动画有几个基本的设置默认一些参数，执行时间为1200，无限循环，中心点，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.duration(1200)</span><br><span class="line">.repeat(YoYo.INFINITE)</span><br><span class="line">.pivot(YoYo.CENTER_PIVOT, YoYo.CENTER_PIVOT)</span><br><span class="line">.interpolate(new AccelerateDecelerateInterpolator())</span><br></pre></td></tr></table></figure>

<h2 id="弹性掉落"><a href="#弹性掉落" class="headerlink" title="弹性掉落"></a>弹性掉落</h2><p>DropOutnAnimator</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class DropOutAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void prepare(View target) &#123;</span><br><span class="line">        int distance = target.getTop() + target.getHeight();</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;alpha&quot;, 0, 1),</span><br><span class="line">                Glider.glide(Skill.BounceEaseOut, getDuration(), ObjectAnimator.ofFloat(target, &quot;translationY&quot;, -distance, 0))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>prepare()方法在设置setTarget的时候被调用，这里主要用于AnimatorSet的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public BaseViewAnimator setTarget(View target) &#123;</span><br><span class="line">       reset(target);</span><br><span class="line">       prepare(target);</span><br><span class="line">       return this;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>DropOutAnimator在prepare的时候设置了两个动画，一个是透明度从从0到1，这个比较好理解，在透明度变化的同时，有个y轴位置上的偏移动画，这个y轴的位置偏移不是简单的线性偏移，而是带有球回弹效果的偏移，这种偏移怎么实现的呢？</p>
<p>先看ObjectAnimator.ofFloat(target, “translationY”, -distance, 0)表示将translationY属性从-171到0的一个变化，-171的时候超出屏幕之外，不可见，然后慢慢向下移，移动到view的top为0的位置，即view在屏幕的top位置。</p>
<p>再看Glider.glide(Skill.BounceEaseOut, getDuration(), ValueAnimator XXXX)，表示将 的这种TypeEvaluator通过animator.setEvaluator(TypeEvaluator t);设置到ValueAnimator XXXXanimator中，这个animator就是前面说的translationY偏移动画中。这种组合将产生奇妙的效果，那Skill.BounceEaseOut具体对translationY的偏移有什么影响呢？</p>
<p>TypeEvaluator的核心在于evaluate方法，子类通过override该方法，通过参数fraction因素和startValue\endValue来计算中间值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface TypeEvaluator&lt;T&gt; &#123;</span><br><span class="line">    T evaluate(float fraction, T startValue, T endValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DropOutAnimator的集成关系是：DropOutAnimator-&gt;BaseEasingMet-&gt;TypeEvaluator，其中BaseEasingMet对evaluate进行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">   public final Float evaluate(float fraction, Number startValue, Number endValue)&#123;</span><br><span class="line">       float t = mDuration * fraction;</span><br><span class="line">       float b = startValue.floatValue();</span><br><span class="line">       float c = endValue.floatValue() - startValue.floatValue();</span><br><span class="line">       float d = mDuration;</span><br><span class="line">       float result = calculate(t,b,c,d);</span><br><span class="line">       for(EasingListener l : mListeners)&#123;</span><br><span class="line">           l.on(t,result,b,c,d);</span><br><span class="line">       &#125;</span><br><span class="line">       return result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public abstract Float calculate(float t, float b, float c, float d);</span><br></pre></td></tr></table></figure>

<p>其中，算法分析如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public  Float calculate(float t, float b, float c, float d)&#123;</span><br><span class="line">               Log.i(&quot;DropOutAnimator&quot;,&quot;time=&quot;+t+&quot;start b=&quot;+b+&quot;length c=&quot;+c+&quot;duration=&quot;+d);</span><br><span class="line">               if ((t/=d) &lt; (1/2.75f)) &#123;//f=0.36</span><br><span class="line">                   return c*(7.5625f*t*t) + b;</span><br><span class="line">               &#125; else if (t &lt; (2/2.75f)) &#123;//f=0.72727272</span><br><span class="line">                   return c*(7.5625f*(t-=(1.5f/2.75f))*t + .75f) + b;</span><br><span class="line">               &#125; else if (t &lt; (2.5/2.75)) &#123;</span><br><span class="line">                   return c*(7.5625f*(t-=(2.25f/2.75f))*t + .9375f) + b;</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                   return c*(7.5625f*(t-=(2.625f/2.75f))*t + .984375f) + b;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure>

<p>第一个阶段f从0-0.36的时候，将参数带入<code>171*7.5625*x*x-171</code>得到-171-0的值，完成了y坐标从-171到0的drop过程。</p>
<p>第二个阶段0.36-0.7272，带入参数为<code>171*(7.5625*(x-0.54)*(x-0.54)+0.75)-171</code>完成从0到-42.75再到0的过程</p>
<p>以此类推，算法的图形如下</p>
<p><img src="images/dropdown.png" alt="路径示意图"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01-11 00:29:10.884 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: result=-13.279831</span><br><span class="line">01-11 00:29:10.900 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: fraction=0.37059042startValue=-171.0fraction=0.0</span><br><span class="line">01-11 00:29:10.902 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: time=444.7085start b=-171.0length c=171.0duration=1200.0</span><br><span class="line">01-11 00:29:10.902 12553-12553/com.daimajia.androidanimations I/DropOutAnimator: result=-3.2075958</span><br></pre></td></tr></table></figure>

<p>以上，就是弹性掉落的动画分析啦</p>
<p>其他的效果也主要是算法的分析：</p>
<p>t=f*duaration 时间</p>
<p>b表示起始值</p>
<p>c表示总的变化幅度</p>
<p>d表示持续时长</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public Float calculate(float t, float b, float c, float d) &#123;</span><br><span class="line">        return c*((t=t/d-1)*t*t*t*t + 1) + b;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="心脏跳动效果"><a href="#心脏跳动效果" class="headerlink" title="心脏跳动效果"></a>心脏跳动效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class PulseAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleY&quot;, 1, 1.1f, 1),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleX&quot;, 1, 1.1f, 1)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>x,y大小的变化组合，1变到1.1再变回1</p>
<h2 id="拉扯效果"><a href="#拉扯效果" class="headerlink" title="拉扯效果"></a>拉扯效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class RubberBandAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleX&quot;, 1, 1.25f, 0.75f, 1.15f, 1),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;scaleY&quot;, 1, 0.75f, 1.25f, 0.85f, 1)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>x方向被拉由1变为1.25，弹回0.75，再被拉到1.15，在弹回到1</p>
<p>y方向在x被拉伸的时候，y是缩小的，对应1变为0.75，到1.25，在对应，0.85，再回到1，互补</p>
<h2 id="左右抖动"><a href="#左右抖动" class="headerlink" title="左右抖动"></a>左右抖动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ShakeAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;translationX&quot;, 0, 25, -25, 25, -25, 15, -15, 6, -6, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="摇晃效果"><a href="#摇晃效果" class="headerlink" title="摇晃效果"></a>摇晃效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class SwingAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;rotation&quot;, 0, 10, -10, 6, -6, 3, -3, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="站立效果"><a href="#站立效果" class="headerlink" title="站立效果"></a>站立效果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class StandUpAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        float x = (target.getWidth() - target.getPaddingLeft() - target.getPaddingRight()) / 2</span><br><span class="line">                + target.getPaddingLeft();</span><br><span class="line">        float y = target.getHeight() - target.getPaddingBottom();</span><br><span class="line">        //中心点</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotX&quot;, x, x, x, x, x),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotY&quot;, y, y, y, y, y),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;rotationX&quot;, 55, -30, 15, -15, 0)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rotationX表示围绕x坐标的旋转，55到-30表示从屏幕后方往前绕x抽向屏幕前方旋转，几个来回值后，有抖动反弹效果。</p>
<h2 id="悬挂旋转，掉落"><a href="#悬挂旋转，掉落" class="headerlink" title="悬挂旋转，掉落"></a>悬挂旋转，掉落</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class HingeAnimator extends BaseViewAnimator &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void prepare(View target) &#123;</span><br><span class="line">        float x = target.getPaddingLeft();</span><br><span class="line">        float y = target.getPaddingTop();</span><br><span class="line">        getAnimatorAgent().playTogether(</span><br><span class="line">                Glider.glide(Skill.SineEaseInOut, 1300, ObjectAnimator.ofFloat(target, &quot;rotation&quot;, 0, 80, 60, 80, 60, 60)),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;translationY&quot;, 0, 0, 0, 0, 0, 700),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;alpha&quot;, 1, 1, 1, 1, 1, 0),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotX&quot;, x, x, x, x, x, x),</span><br><span class="line">                ObjectAnimator.ofFloat(target, &quot;pivotY&quot;, y, y, y, y, y, y)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        setDuration(1300);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以左上角为中心，SineEaseInOut方式，从0-80-60-80-60，最后在60度的地方，Y轴坐标下降，并且淡出</p>
<p>差不多类似的所以，这些可爱的组合和算法是怎么想出来的啊，真棒！！！</p>

        </div></article>
      <article class="post">
    <header class="post-header">
      <h1 class="post-title"><a class="post-link" href="/2018/04/13/svg路径动画/">svg路径动画</a>
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span><span class="post-category">
            <a href="/categories/animation/">animation</a>
            </span>
        </div>
    </header>

    <div class="post-content"><h1 id="Svg-路径动画效果"><a href="#Svg-路径动画效果" class="headerlink" title="Svg 路径动画效果"></a>Svg 路径动画效果</h1><p>项目地址：<a href="https://github.com/geftimov/android-pathview" target="_blank" rel="noopener">Github</a></p>
<p>动画效果：</p>
<p><img src="https://github.com/geftimov/android-pathview/blob/master/art/fill-after-resize-new.gif" alt="svg path动画"></p>
<h2 id="什么是svg"><a href="#什么是svg" class="headerlink" title="什么是svg"></a>什么是svg</h2><p>Scalable Vector Graphics (SVG)可缩放的矢量图形，应用几个定义<a href="https://en.wikipedia.org/wiki/Scalable_Vector_Graphics" target="_blank" rel="noopener">wiki</a></p>
<blockquote>
<ul>
<li>SVG 指可伸缩矢量图形 (Scalable Vector Graphics)</li>
<li>SVG 用来定义用于网络的基于<a href="https://baike.baidu.com/item/%E7%9F%A2%E9%87%8F/1400417" target="_blank" rel="noopener">矢量</a>的图形</li>
<li>SVG 使用 XML 格式定义图形</li>
<li>SVG 图像在放大或改变尺寸的情况下其图形质量不会有所损失</li>
<li>SVG 是万维网<a href="https://baike.baidu.com/item/%E8%81%94%E7%9B%9F/4799014" target="_blank" rel="noopener">联盟</a>的标准</li>
<li>SVG 与诸如 <a href="https://baike.baidu.com/item/DOM/50288" target="_blank" rel="noopener">DOM</a>和 <a href="https://baike.baidu.com/item/XSL" target="_blank" rel="noopener">XSL</a> 之类的<a href="https://baike.baidu.com/item/W3C" target="_blank" rel="noopener">W3C</a>标准是一个整体</li>
</ul>
</blockquote>
<h2 id="PathView做了什么"><a href="#PathView做了什么" class="headerlink" title="PathView做了什么"></a>PathView做了什么</h2><p>通过XML方式获取svg资源id </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;com.eftimoff.androipathview.PathView</span><br><span class="line">        android:id=&quot;@+id/pathView&quot;</span><br><span class="line">        android:layout_width=&quot;350dp&quot;</span><br><span class="line">        android:layout_height=&quot;350dp&quot;</span><br><span class="line">        app:svg=&quot;@raw/monitor&quot;  //在res/raw文件夹中，</span><br><span class="line">        app:pathColor=&quot;@android:color/white&quot;</span><br><span class="line">        app:pathWidth=&quot;2dp&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>在onSizeChanged的时候加载svg文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">  protected void onSizeChanged(final int w, final int h, int oldw, int oldh) &#123;</span><br><span class="line">      super.onSizeChanged(w, h, oldw, oldh);</span><br><span class="line"></span><br><span class="line">      if (mLoader != null) &#123;</span><br><span class="line">          try &#123;</span><br><span class="line">              mLoader.join();//必须在loader运行完毕后，再运行</span><br><span class="line">          &#125; catch (InterruptedException e) &#123;</span><br><span class="line">              Log.e(LOG_TAG, &quot;Unexpected error&quot;, e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if (svgResourceId != 0) &#123;</span><br><span class="line">          mLoader = new Thread(new Runnable() &#123;</span><br><span class="line">              @Override</span><br><span class="line">              public void run() &#123;</span><br><span class="line"></span><br><span class="line">                  svgUtils.load(getContext(), svgResourceId);通过svg包加载资源文件到 mSvg</span><br><span class="line"></span><br><span class="line">                  synchronized (mSvgLock) &#123;</span><br><span class="line">                      width = w - getPaddingLeft() - getPaddingRight();</span><br><span class="line">                      height = h - getPaddingTop() - getPaddingBottom();</span><br><span class="line">                      paths = svgUtils.getPathsForViewport(width, height);</span><br><span class="line">                      updatePathsPhaseLocked();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, &quot;SVG Loader&quot;);</span><br><span class="line">          mLoader.start();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中load主要是加载资源文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Loading the svg from the resources.</span><br><span class="line"> *</span><br><span class="line"> * @param context     Context object to get the resources.</span><br><span class="line"> * @param svgResource int resource id of the svg.</span><br><span class="line"> */</span><br><span class="line">public void load(Context context, int svgResource) &#123;</span><br><span class="line">    if (mSvg != null) </span><br><span class="line">        return;</span><br><span class="line">    try &#123;</span><br><span class="line">        mSvg = SVG.getFromResource(context, svgResource);//通过 com.caverock.androidsvg api加载</span><br><span class="line">        mSvg.setDocumentPreserveAspectRatio(PreserveAspectRatio.UNSCALED);</span><br><span class="line">    &#125; catch (SVGParseException e) &#123;</span><br><span class="line">        Log.e(LOG_TAG, &quot;Could not load specified SVG resource&quot;, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getPathsForViewport，将</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Render the svg to canvas and catch all the paths while rendering.</span><br><span class="line"> *</span><br><span class="line"> * @param width  - the width to scale down the view to,</span><br><span class="line"> * @param height - the height to scale down the view to,</span><br><span class="line"> * @return All the paths from the svg.</span><br><span class="line"> */</span><br><span class="line">public List&lt;SvgPath&gt; getPathsForViewport(final int width, final int height) &#123;</span><br><span class="line">    final float strokeWidth = mSourcePaint.getStrokeWidth();</span><br><span class="line">    Canvas canvas = new Canvas() &#123;</span><br><span class="line">        private final Matrix mMatrix = new Matrix();</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getWidth() &#123;</span><br><span class="line">            return width;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public int getHeight() &#123;</span><br><span class="line">            return height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void drawPath(Path path, Paint paint) &#123;</span><br><span class="line">            Path dst = new Path();</span><br><span class="line"></span><br><span class="line">            //noinspection deprecation</span><br><span class="line">            getMatrix(mMatrix);</span><br><span class="line">            path.transform(mMatrix, dst);//将path中的点进行mMatrix变化后，并将最终的path写到dst path中</span><br><span class="line">            paint.setAntiAlias(true);//抗锯齿</span><br><span class="line">            paint.setStyle(Paint.Style.STROKE);</span><br><span class="line">            paint.setStrokeWidth(strokeWidth);</span><br><span class="line">            mPaths.add(new SvgPath(dst, paint));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    rescaleCanvas(width, height, strokeWidth, canvas);</span><br><span class="line"></span><br><span class="line">    return mPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rescaleCanvas：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">    * Rescale the canvas with specific width and height.</span><br><span class="line">    *</span><br><span class="line">    * @param width       The width of the canvas.</span><br><span class="line">    * @param height      The height of the canvas.</span><br><span class="line">    * @param strokeWidth Width of the path to add to scaling.</span><br><span class="line">    * @param canvas      The canvas to be drawn.</span><br><span class="line">    */</span><br><span class="line">   private void rescaleCanvas(int width, int height, float strokeWidth, Canvas canvas) &#123;</span><br><span class="line">       if (mSvg == null) </span><br><span class="line">           return;</span><br><span class="line">       final RectF viewBox = mSvg.getDocumentViewBox();</span><br><span class="line"></span><br><span class="line">       final float scale = Math.min(width</span><br><span class="line">                       / (viewBox.width() + strokeWidth),</span><br><span class="line">               height / (viewBox.height() + strokeWidth));</span><br><span class="line"></span><br><span class="line">       canvas.translate((width - viewBox.width() * scale) / 2.0f,</span><br><span class="line">               (height - viewBox.height() * scale) / 2.0f);</span><br><span class="line">       canvas.scale(scale, scale);</span><br><span class="line"></span><br><span class="line">       mSvg.renderToCanvas(canvas);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>对于Matrix的学习扩展，请参阅<a href="https://blog.csdn.net/abcdef314159/article/details/52813313" target="_blank" rel="noopener">Matrix源码详解</a></p>
<p><a href="https://github.com/GcsSloop/AndroidNote/blob/master/CustomView/Advance/[09]Matrix_Basic.md" target="_blank" rel="noopener">matrix原理</a></p>
<p>动画影响的属性是percentage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * Default constructor.</span><br><span class="line">  *</span><br><span class="line">  * @param pathView The view that must be animated.</span><br><span class="line">  */</span><br><span class="line"> public AnimatorBuilder(final PathView pathView) &#123;</span><br><span class="line">     anim = ObjectAnimator.ofFloat(pathView, &quot;percentage&quot;, 0.0f, 1.0f);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>通过影响percentage的值，从而影响</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Animate this property. It is the percentage of the path that is drawn.</span><br><span class="line"> * It must be [0,1].</span><br><span class="line"> *</span><br><span class="line"> * @param percentage float the percentage of the path.</span><br><span class="line"> */</span><br><span class="line">public void setPercentage(float percentage) &#123;</span><br><span class="line">    if (percentage &lt; 0.0f || percentage &gt; 1.0f) &#123;</span><br><span class="line">        throw new IllegalArgumentException(&quot;setPercentage not between 0.0f and 1.0f&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    progress = percentage;</span><br><span class="line">    synchronized (mSvgLock) &#123;</span><br><span class="line">        updatePathsPhaseLocked();//更新path</span><br><span class="line">    &#125;</span><br><span class="line">    invalidate();再重新绘制</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据progress，更新svgPath</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This refreshes the paths before draw and resize.</span><br><span class="line"> */</span><br><span class="line">private void updatePathsPhaseLocked() &#123;</span><br><span class="line">    final int count = paths.size();</span><br><span class="line">    for (int i = 0; i &lt; count; i++) &#123;</span><br><span class="line">        SvgUtils.SvgPath svgPath = paths.get(i);</span><br><span class="line">        svgPath.path.reset();</span><br><span class="line">        svgPath.measure.getSegment(0.0f, svgPath.length * progress, svgPath.path, true);</span><br><span class="line">        //Given a start and stop distance, return in dst the intervening segment(s). If the segment is zero-length, return false, else return true. startD and stopD are pinned to legal values (0..getLength()). If startD &lt;= stopD then return false (and leave dst untouched). Begin the segment with a moveTo if startWithMoveTo is true</span><br><span class="line">        // Required only for Android 4.4 and earlier</span><br><span class="line">        svgPath.path.rLineTo(0.0f, 0.0f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从而实现，path动画</p>

        </div></article>
      <nav class="pagination"><a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></section></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2020<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">lynn8570</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script>
</body>
</html>
